<!doctype html>

<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>บันทึกการซื้อของเก่า (ทอง/เงิน/นาก/...)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .square-img { width:280px; height:280px; object-fit:cover; border:1px solid #ddd; background:#fff; }
    .print-area { background:#fff; padding:20px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    .pdf-sign { height:70px; border-bottom:1px dashed #333; margin-top:24px; }
    .item-card { border:1px solid #e6e6e6; padding:10px; border-radius:6px; background:#fff; }
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left:0; top:0; width:100%; }
    }
  </style>
</head>
<body>
<div class="container py-4">
  <h3 class="mb-3">ฟอร์มบันทึกการซื้อของเก่า (พร้อมสร้าง PDF)</h3>
  <div class="row gy-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>1) รูปภาพ</h5>
        <div class="mb-2">
          <label class="form-label">รูปบัตรประชาชน (แนะนำให้ถ่ายพร้อมของในภาพเดียวหรืออัพแยกทั้งคู่)</label>
          <input class="form-control" type="file" id="idImageInput" accept="image/*">
        </div>
        <div class="mb-2">
          <label class="form-label">รูปของ (อัพได้หลายไฟล์)</label>
          <input class="form-control" type="file" id="itemImagesInput" accept="image/*" multiple>
        </div>
        <div class="d-flex gap-2 flex-wrap mt-2" id="thumbs"></div>
      </div><div class="card p-3 mt-3">
    <h5>2) ข้อมูลผู้ขาย</h5>
    <div class="mb-2">
      <label class="form-label">ชื่อ-นามสกุล (ให้ผู้ขายเขียน/เซ็นหน้าเอกสาร)</label>
      <input class="form-control" id="sellerName" placeholder="ชื่อ นามสกุล">
    </div>
    <div class="mb-2">
      <label class="form-label">เบอร์โทร</label>
      <input class="form-control" id="sellerPhone" placeholder="081-xxx-xxxx">
    </div>
    <div class="mb-2 row">
      <div class="col-6">
        <label class="form-label">วันที่</label>
        <input class="form-control" id="sellDate" type="date">
      </div>
      <div class="col-6">
        <label class="form-label">เวลา</label>
        <input class="form-control" id="sellTime" type="time">
      </div>
    </div>
  </div>

  <div class="card p-3 mt-3">
    <h5>3) รายการของที่นำมาขาย (เพิ่มได้หลายชิ้น)</h5>
    <div id="itemsList"></div>
    <div class="mt-2">
      <button class="btn btn-outline-primary btn-sm" id="addItemBtn">+ เพิ่มรายการ</button>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-success" id="generatePdfBtn">สร้าง PDF พร้อมดาวน์โหลด</button>
    <button class="btn btn-secondary" id="previewBtn">ดูตัวอย่างในหน้า</button>
  </div>

  <div class="mt-3 text-muted small">หมายเหตุ: บันทึกนี้จะสร้างเป็นไฟล์ PDF สำหรับพิมพ์ให้ผู้ขายเซ็นด้วยปากกาได้</div>
</div>

<div class="col-md-6">
  <div class="print-area" id="printAreaPreview">
    <div class="text-center mb-2">
      <div id="imagesTop" style="display:flex; justify-content:center; gap:12px; align-items:center;">
        <!-- will inject square image(s) -->
      </div>
    </div>
    <h4 class="text-center mb-1">บันทึกการซื้อของเก่า</h4>
    <p class="text-center small mb-3">(เอกสารสำหรับพิมพ์ให้ผู้ขายลงชื่อ/เซ็น)</p>

    <div class="mb-2">
      <strong>ชื่อ-นามสกุล ผู้ขาย:</strong> <span id="p_sellerName">-</span>
    </div>
    <div class="mb-2">
      <strong>เบอร์โทร:</strong> <span id="p_sellerPhone">-</span>
    </div>
    <div class="mb-2">
      <strong>วันที่/เวลา:</strong> <span id="p_sellDate">-</span> <span id="p_sellTime">-</span>
    </div>

    <hr>
    <div id="p_itemsContainer"></div>

    <hr>
    <div>
      <div>ลงชื่อผู้รับของ: <div class="pdf-sign"></div></div>
      <div class="mt-3">(เซ็น / เขียนด้วยปากกา)</div>
    </div>

    <div class="mt-4 small text-muted">เอกสารนี้ทำขึ้นโดยระบบบันทึกการซื้อของเก่า — กรุณาตรวจสอบความถูกต้องก่อนพิมพ์</div>
  </div>
</div>

  </div>
</div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><script>
// Helpers
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

let itemCount = 0;
const itemsList = document.getElementById('itemsList');
const addItemBtn = document.getElementById('addItemBtn');

function addItem(data={}){
  itemCount++;
  const id = 'item_'+itemCount;
  const el = document.createElement('div');
  el.className = 'item-card mb-2';
  el.innerHTML = `
    <div class="d-flex justify-content-between align-items-start mb-2">
      <strong>รายการ #${itemCount}</strong>
      <button class="btn btn-sm btn-danger remove-item">ลบ</button>
    </div>
    <div class="row g-2">
      <div class="col-6">
        <label class="form-label">ประเภทแร่/ชนิด</label>
        <select class="form-select item-type">
          <option value="ทอง">ทอง</option>
          <option value="เงิน">เงิน</option>
          <option value="นาก">นาก</option>
          <option value="แพลตตินั่ม">แพลตตินั่ม</option>
          <option value="โรเดียม">โรเดียม</option>
          <option value="พาราเดียม">พาราเดียม</option>
          <option value="อื่นๆ">อื่นๆ</option>
        </select>
      </div>
      <div class="col-6">
        <label class="form-label">ชนิดของ (เช่น กรอบพระ, สร้อย)</label>
        <input class="form-control item-desc" placeholder="ตัวอย่าง: สร้อยคอ 1 เส้น">
      </div>
      <div class="col-4">
        <label class="form-label">น้ำหนัก (กรัม)</label>
        <input class="form-control item-weight" type="number" step="0.01">
      </div>
      <div class="col-4">
        <label class="form-label">% ของแร่ (เช่น 96.5)</label>
        <input class="form-control item-purity" type="number" step="0.01">
      </div>
      <div class="col-4">
        <label class="form-label">ราคาต่อกรัม (บาท)</label>
        <input class="form-control item-pricegram" type="number" step="0.01">
      </div>
      <div class="col-12 mt-2">
        <label class="form-label">ราคากลางในการซื้อขาย (อาจเป็นค่าที่ร้านกำหนด)</label>
        <input class="form-control item-marketprice" placeholder="เช่น 2,800 บาท">
      </div>
    </div>
  `;
  itemsList.appendChild(el);
  if(data.type) el.querySelector('.item-type').value = data.type;
  if(data.desc) el.querySelector('.item-desc').value = data.desc;
  if(data.weight) el.querySelector('.item-weight').value = data.weight;
  if(data.purity) el.querySelector('.item-purity').value = data.purity;
  if(data.pricegram) el.querySelector('.item-pricegram').value = data.pricegram;
  if(data.marketprice) el.querySelector('.item-marketprice').value = data.marketprice;

  el.querySelector('.remove-item').addEventListener('click', () => el.remove());
}

addItemBtn.addEventListener('click', ()=>addItem());
// add initial one
addItem({type:'ทอง', desc:'กรอบพระ'});

// Image handling
const idImageInput = document.getElementById('idImageInput');
const itemImagesInput = document.getElementById('itemImagesInput');
const thumbs = document.getElementById('thumbs');
let idImageData = null;
let itemImagesData = [];

idImageInput.addEventListener('change', ev => {
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    idImageData = e.target.result;
    renderThumbs();
  }
  reader.readAsDataURL(f);
});

itemImagesInput.addEventListener('change', ev => {
  itemImagesData = [];
  const files = Array.from(ev.target.files);
  let loaded = 0;
  files.forEach((f, i) => {
    const r = new FileReader();
    r.onload = e => {
      itemImagesData.push(e.target.result);
      loaded++; if(loaded===files.length) renderThumbs();
    }
    r.readAsDataURL(f);
  });
});

function renderThumbs(){
  thumbs.innerHTML = '';
  if(idImageData){
    const d = document.createElement('div');
    d.innerHTML = `<div class="text-center p-2"><div class="small">บัตรประชาชน</div><img src="${idImageData}" class="square-img"></div>`;
    thumbs.appendChild(d);
  }
  itemImagesData.forEach((src,i)=>{
    const d = document.createElement('div');
    d.innerHTML = `<div class="text-center p-2"><div class="small">ของ #${i+1}</div><img src="${src}" class="square-img"></div>`;
    thumbs.appendChild(d);
  });
  updatePreview();
}

// Update preview panel
function updatePreview(){
  // imagesTop: center square image composed of ID and first item (if both present)
  const imagesTop = document.getElementById('imagesTop');
  imagesTop.innerHTML = '';
  if(itemImagesData.length>0 && idImageData){
    const wrap = document.createElement('div');
    wrap.style.display='flex';
    wrap.style.gap='8px';
    wrap.innerHTML = `<img src="${itemImagesData[0]}" class="square-img"><img src="${idImageData}" class="square-img">`;
    imagesTop.appendChild(wrap);
  } else if(itemImagesData.length>0){
    const img = document.createElement('img'); img.src = itemImagesData[0]; img.className='square-img'; imagesTop.appendChild(img);
  } else if(idImageData){
    const img = document.createElement('img'); img.src = idImageData; img.className='square-img'; imagesTop.appendChild(img);
  } else {
    imagesTop.innerHTML = '<div class="square-img" style="display:flex;align-items:center;justify-content:center;color:#777">ไม่มีรูป</div>';
  }

  // text fields
  document.getElementById('p_sellerName').innerText = document.getElementById('sellerName').value || '-';
  document.getElementById('p_sellerPhone').innerText = document.getElementById('sellerPhone').value || '-';
  document.getElementById('p_sellDate').innerText = document.getElementById('sellDate').value || '-';
  document.getElementById('p_sellTime').innerText = document.getElementById('sellTime').value || '-';

  // items
  const p_itemsContainer = document.getElementById('p_itemsContainer');
  p_itemsContainer.innerHTML = '';
  const cards = itemsList.querySelectorAll('.item-card');
  cards.forEach((c,i)=>{
    const type = c.querySelector('.item-type').value || '-';
    const desc = c.querySelector('.item-desc').value || '-';
    const weight = c.querySelector('.item-weight').value || '-';
    const purity = c.querySelector('.item-purity').value || '-';
    const pricegram = c.querySelector('.item-pricegram').value || '-';
    const marketprice = c.querySelector('.item-marketprice').value || '-';

    const div = document.createElement('div');
    div.innerHTML = `
      <div style="margin-bottom:10px">
        <strong>รายการ ${i+1}:</strong> ${type} — ${desc}<br>
        น้ำหนัก: ${weight} กรัม | ความบริสุทธิ์: ${purity}% | ราคาต่อกรัม: ${pricegram} บาท<br>
        ราคากลาง: ${marketprice}
      </div>
    `;
    p_itemsContainer.appendChild(div);
  });
}

// keep preview updated when inputs change
['sellerName','sellerPhone','sellDate','sellTime'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', updatePreview);
});
itemsList.addEventListener('input', updatePreview);

// preview button
document.getElementById('previewBtn').addEventListener('click', ()=>{
  updatePreview();
  window.scrollTo({top:0, behavior:'smooth'});
});

// Generate PDF using html2canvas + jspdf
const { jsPDF } = window.jspdf;

document.getElementById('generatePdfBtn').addEventListener('click', async ()=>{
  updatePreview();
  const preview = document.getElementById('printAreaPreview');
  // enlarge for better resolution
  const canvas = await html2canvas(preview, { scale:2, useCORS:true, scrollY:-window.scrollY });
  const imgData = canvas.toDataURL('image/jpeg', 0.95);

  // create A4 pdf (portrait)
  const pdf = new jsPDF({ unit:'mm', format:'a4' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // compute image size to fit width with margin
  const margin = 10;
  const imgProps = pdf.getImageProperties(imgData);
  const pdfWidth = pageWidth - margin*2;
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  pdf.addImage(imgData, 'JPEG', margin, margin, pdfWidth, pdfHeight);

  // add a blank line for physical signature area on separate page if needed
  // ensure enough space: if pdfHeight > pageHeight - margin*2 we may need multiple pages — simple approach: scale to fit

  pdf.save('บันทึกการซื้อของเก่า.pdf');
});

// auto-update preview initially
updatePreview();
</script></body>
</html>
