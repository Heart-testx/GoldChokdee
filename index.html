<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ! (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°)</title>
    <style>
        :root {
            --gap-size: 15px; /* Define a CSS variable for gap */
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            flex-direction: column;
            padding: 20px 10px; /* ‡∏•‡∏î padding ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Top Controls Area */
        .top-controls-container {
            width: 95%; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            max-width: 450px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° max-width ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            background-color: #fff;
            padding: 15px 20px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .top-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .currency-display {
            font-size: 1.1em; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px; /* ‡∏•‡∏î gap */
        }
        .diamond-icon {
            width: 22px; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            height: 22px;
            vertical-align: middle;
        }
        .count-display {
            font-size: 1em; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            color: #333;
            font-weight: bold;
        }
        .reset-button, .shop-button, .inventory-button, .minigame-button { /* Added minigame-button */
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 20px;
            font-size: 0.85em; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏î */
        }
        .reset-button { background-color: #f44336; }
        .reset-button:hover { background-color: #da190b; }
        .shop-button { background-color: #17a2b8; }
        .shop-button:hover { background-color: #138496; }
        .inventory-button { background-color: #ff9800; } /* ‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á */
        .inventory-button:hover { background-color: #e68900; }
        .minigame-button { background-color: #673ab7; } /* New color for minigame button */
        .minigame-button:hover { background-color: #512da8; }

        /* Container for multiple cards */
        #resultsContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--gap-size); /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ CSS */
            width: 100%; /* ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
            max-width: 1200px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î max-width ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 5 ‡πÉ‡∏ö */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .card-container {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            overflow: hidden;
            margin-bottom: 0; /* Remove extra margin-bottom if present */
        }

        /* Responsive adjustments for card-container */
        /* Default for wide screens: 5 cards per row */
        .card-container {
            width: calc(20% - (var(--gap-size) * 4 / 5)); /* 5 cards, accounting for 4 gaps */
            max-width: 220px; /* Max individual card width to prevent too wide */
            min-width: 160px; /* Min width for mobile portrait */
        }

        @media (max-width: 1200px) { /* 4 cards per row */
            .card-container {
                width: calc(25% - (var(--gap-size) * 3 / 4));
                max-width: 250px;
            }
        }
        @media (max-width: 900px) { /* 3 cards per row */
            .card-container {
                width: calc(33.33% - (var(--gap-size) * 2 / 3));
                max-width: 280px;
            }
        }
        @media (max-width: 600px) { /* 2 cards per row */
            .card-container {
                width: calc(50% - (var(--gap-size) * 1 / 2));
                max-width: 350px;
            }
        }
        @media (max-width: 400px) { /* 1 card per row */
            .card-container {
                width: calc(100% - (var(--gap-size) * 0)); /* Full width, no gaps between */
                max-width: 400px;
            }
        }


        /* Border Glow Effect for Rarity */
        .card-container::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 20px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        .card-container.rarity-lr::before { /* New LR Glow */
            background: linear-gradient(45deg, #e74c3c, #f39c12, #f1c40f, #2ecc71, #3498db, #9b59b6, #e74c3c);
            background-size: 600% 600%;
            animation: glowing 6s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-ur::before {
            background: linear-gradient(45deg, #ffcc00, #ff6600, #ff00cc, #6600ff);
            background-size: 400% 400%;
            animation: glowing 4s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-ssr::before {
            background: linear-gradient(45deg, #00ffff, #00bfff, #8a2be2, #ff1493);
            background-size: 400% 400%;
            animation: glowing 3s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-sr::before {
            background: linear-gradient(45deg, #00ff00, #008000);
            background-size: 400% 400%;
            animation: glowing 2s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-n::before {
            opacity: 0;
        }

        .card-image {
            width: 80px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid #66bb6a; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î border */
            animation: popIn 0.5s ease-out;
        }
        .card-name {
            font-size: 1.2em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠ */
            color: #333;
            margin-bottom: 5px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-skill {
            font-size: 0.8em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏¥‡∏• */
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
            font-style: italic;
            min-height: 3.5em; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î min-height ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word; /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÜ ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ */
        }
        .card-stats {
            font-size: 0.75em;
            color: #666;
            margin-top: 5px;
            line-height: 1.3;
        }
        .card-stats span {
            display: block;
        }
        .rarity-display {
            font-size: 1em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏£‡∏ó */
            font-weight: bold;
            margin-bottom: 8px;
            padding: 2px 7px;
            border-radius: 10px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î border-radius */
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Rarity Specific Colors */
        .rarity-display.lr { background-color: #FF1493; color: #FFFFFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* New LR Color */
        .rarity-display.ur { background-color: #FFD700; color: #8B0000; text-shadow: 1px 1px 2px rgba(255,255,255,0.7); }
        .rarity-display.ssr { background-color: #8A2BE2; color: #FFFFFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .rarity-display.sr { background-color: #00FF7F; color: #006400; text-shadow: 1px 1px 2px rgba(255,255,255,0.7); }
        .rarity-display.n { background-color: #C0C0C0; color: #555555; }


        .random-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 30px;
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        .random-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        .random-button:active {
            transform: translateY(0);
        }

        .random-button.x10 {
            background-color: #007bff;
        }
        .random-button.x10:hover {
            background-color: #0056b3;
        }
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .error-message {
            color: #d9534f;
            margin-top: 10px;
            font-weight: bold;
            display: none;
            text-align: center;
        }


        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 10px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡πÉ‡∏´‡πâ popup ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            box-sizing: border-box;
        }
        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .popup-content {
            background-color: #fff;
            padding: 20px 30px; /* ‡∏•‡∏î padding */
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 95%; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° max-width ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            max-height: 90vh; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
            overflow-y: auto; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° scrollbar ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô */
        }
        .popup-overlay.active .popup-content {
            transform: scale(1);
        }
        .popup-content h2 {
            color: #333; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ popup */
            font-size: 2em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î */
            margin-bottom: 15px;
            text-shadow: none; /* ‡πÑ‡∏°‡πà‡∏°‡∏µ shadow */
        }
        .popup-content p {
            font-size: 1.1em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î */
            color: #333;
            margin-bottom: 20px;
        }
        .popup-close-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 20px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 25px;
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 15px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
        }
        .popup-close-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        /* Shop Popup Styles */
        #shopPopupOverlay {
            z-index: 1010;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 15px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            margin-bottom: 8px; /* ‡∏•‡∏î margin-bottom */
            gap: 10px;
            flex-wrap: wrap; /* ‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
        }
        .shop-item-info {
            text-align: left;
            flex-grow: 1; /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ */
        }
        .shop-item-name {
            font-weight: bold;
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
            color: #555;
        }
        .shop-item-price {
            display: flex;
            align-items: center;
            gap: 4px; /* ‡∏•‡∏î gap */
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
            color: #007bff;
            font-weight: bold;
        }
        .shop-item-real-price {
            font-size: 0.9em;
            color: #777;
            margin-left: 10px;
            white-space: nowrap;
        }
        .buy-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }
        .buy-button:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }
        .buy-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Inventory Popup Styles */
        #inventoryPopupContent .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            gap: 10px;
            margin-top: 20px;
            max-height: 50vh; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á grid */
            overflow-y: auto; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° scrollbar */
        }

        .inventory-item {
            background-color: #eceff1;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer; /* Make inventory items clickable */
        }
        .inventory-item img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #ccc;
        }
        .inventory-item .name {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .inventory-item .count {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: #007bff;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .inventory-item .rarity-label {
            font-size: 0.7em;
            font-weight: bold;
            padding: 1px 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        /* New LR Rarity Label */
        .inventory-item .rarity-label.lr { background-color: #FF1493; color: #FFFFFF; }
        .inventory-item .rarity-label.ur { background-color: #FFD700; color: #8B0000; }
        .inventory-item .rarity-label.ssr { background-color: #8A2BE2; color: #FFFFFF; }
        .inventory-item .rarity-label.sr { background-color: #00FF7F; color: #006400; }
        .inventory-item .rarity-label.n { background-color: #C0C0C0; color: #555555; }
        .inventory-item .stats {
            font-size: 0.7em;
            color: #666;
            text-align: left;
            margin-top: 5px;
            line-height: 1.2;
            width: 100%;
        }


        /* Exchange Section in Shop Popup */
        .exchange-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .exchange-section h3 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 15px;
        }
        .exchange-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .exchange-item-info {
            text-align: left;
            flex-grow: 1;
        }
        .exchange-cost {
            font-size: 1em;
            color: #d9534f;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .exchange-cost span {
            font-size: 0.9em;
            color: #555;
            font-weight: normal;
        }
        .exchange-button {
            background-color: #5cb85c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }
        .exchange-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .exchange-button:hover:not(:disabled) {
            background-color: #4cae4c;
            transform: translateY(-1px);
        }

        /* Probability Boost Item */
        .probability-boost-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .probability-boost-section h3 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 15px;
        }
        .boost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .boost-item-info {
            text-align: left;
            flex-grow: 1;
        }
        .boost-item-name {
            font-weight: bold;
            font-size: 1em;
            color: #555;
        }
        .boost-item-price {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 1em;
            color: #dc3545; /* Red color for boost price */
            font-weight: bold;
        }
        .boost-item-duration {
            font-size: 0.8em;
            color: #777;
            margin-top: 5px;
        }
        .buy-boost-button {
            background-color: #6f42c1; /* Purple color for boost button */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }
        .buy-boost-button:hover {
            background-color: #5a359d;
            transform: translateY(-1px);
        }
        .buy-boost-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Mini-Game Popup Styles */
        #miniGamePopupOverlay {
            z-index: 1020;
        }
        #miniGamePopupContent .mini-game-section {
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            background-color: #fdfdfd;
        }
        #miniGamePopupContent .mini-game-section h3 {
            font-size: 1.3em;
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 10px;
        }
        #miniGamePopupContent .mini-game-rewards {
            margin-top: 10px;
            font-size: 0.95em;
            color: #555;
        }
        #miniGamePopupContent .mini-game-cost {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1em;
            color: #d9534f;
            font-weight: bold;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        #miniGamePopupContent .mini-game-cost span {
            font-weight: normal;
            color: #333;
        }
        #miniGamePopupContent .mini-game-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
        }
        #miniGamePopupContent .mini-game-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        #miniGamePopupContent .mini-game-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #miniGamePopupContent .mini-game-status {
            margin-top: 15px;
            font-size: 0.9em;
            color: #007bff;
            font-weight: bold;
        }


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes glowing {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>
    <div class="top-controls-container">
        <div class="top-controls-row">
            <div class="currency-display">
                <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                ‡πÄ‡∏û‡∏ä‡∏£: <span id="diamondCount">0</span>
            </div>
            <button class="shop-button" onclick="openShop()">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div class="top-controls-row">
            <div class="count-display">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°: <span id="rollCount">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            <button class="inventory-button" onclick="openInventory()">‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
        </div>
        <div class="top-controls-row">
            <div class="count-display">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏ä‡∏£: <span id="topUpCount">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            <button class="minigame-button" onclick="openMiniGame()">‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°</button> </div>
        <div class="top-controls-row">
            <div></div> <button class="reset-button" onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <div class="button-group">
        <button class="random-button" onclick="handleRoll(1)">‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ 100 üíé)</button>
        <button class="random-button x10" onclick="handleRoll(10)">‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ 900 üíé)</button>
    </div>
    <div id="errorMessage" class="error-message"></div>

    <div id="resultsContainer">
        <div id="initialCard" class="card-container">
            <h1>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠...</h1>
            <div id="rarityDisplay" class="rarity-display"></div>
            <img id="friendImage" class="card-image" src="https://via.placeholder.com/150/EEEEEE/888888?text=‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" alt="‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
            <div id="friendName" class="card-name">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°!</div>
            <div id="friendSkill" class="card-skill">‡∏à‡∏∞‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡∏™‡∏∏‡∏î‡∏Æ‡∏≤!</div>
            <div id="friendStats" class="card-stats"></div>
        </div>
    </div>

    <div id="urPopupOverlay" class="popup-overlay">
        <div class="popup-content">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ UR!</h2>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Ultra Rare!</p>
            <button class="popup-close-button" onclick="closePopup('urPopupOverlay')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="lrPopupOverlay" class="popup-overlay"> <div class="popup-content">
            <h2>‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ LR!</h2>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Legendary Rare!</p>
            <button class="popup-close-button" onclick="closePopup('lrPopupOverlay')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="shopPopupOverlay" class="popup-overlay">
        <div id="shopPopupContent" class="popup-content">
            <h2>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏ä‡∏£</h2>
            <div id="shopItemsContainer">
                </div>

            <div class="exchange-section">
                <h3>‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</h3>
                <div id="exchangeOffersContainer">
                    </div>
            </div>

            <div class="probability-boost-section">
                <h3>‡∏ö‡∏π‡∏™‡∏ï‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</h3>
                <div class="boost-item">
                    <div class="boost-item-info">
                        <div class="boost-item-name">‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ UR x2</div>
                        <div class="boost-item-price">
                            <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                            10,000 ‡πÄ‡∏û‡∏ä‡∏£
                        </div>
                        <div class="boost-item-duration" id="urBoostStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                    </div>
                    <button class="buy-boost-button" id="buyURBoostBtn" onclick="buyProbabilityBoost(10000, 'UR', 2, 300000)">‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>
                <div class="boost-item">
                    <div class="boost-item-info">
                        <div class="boost-item-name">‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ LR x2</div>
                        <div class="boost-item-price">
                            <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                            50,000 ‡πÄ‡∏û‡∏ä‡∏£
                        </div>
                        <div class="boost-item-duration" id="lrBoostStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                    </div>
                    <button class="buy-boost-button" id="buyLRBoostBtn" onclick="buyProbabilityBoost(50000, 'LR', 2, 300000)">‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>
            </div>
            <button class="popup-close-button" onclick="closeShop()">‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
    </div>

    <div id="inventoryPopupOverlay" class="popup-overlay">
        <div id="inventoryPopupContent" class="popup-content">
            <h2>‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î</h2>
            <div class="inventory-grid" id="inventoryGrid">
                </div>
            <button class="popup-close-button" onclick="closePopup('inventoryPopupOverlay')">‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏á</button>
        </div>
    </div>

    <div id="miniGamePopupOverlay" class="popup-overlay">
        <div id="miniGamePopupContent" class="popup-content">
            <h2>‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°: ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢!</h2>
            <p>‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•! ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î.</p>
            <div id="miniGameExpeditionsContainer">
                </div>
            <button class="popup-close-button" onclick="closePopup('miniGamePopupOverlay')">‡∏õ‡∏¥‡∏î‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°</button>
        </div>
    </div>

    <script>
        let rollCounter = 0;
        let diamondCount = 1000;
        let topUpCount = 0;
        let inventory = {}; // { "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô": { friendData: {}, count: 1 } }
        let rollsSinceLastUR = 0;
        let rollsSinceLastLR = 0; // New: Pity for LR
        const PITY_ROLLS_FOR_UR = 1000;
        const PITY_ROLLS_FOR_LR = 5000; // New: Pity for LR
        const COST_PER_ROLL = 100;
        const COST_TEN_ROLLS = 900;

        // Probability Boost variables
        let urBoostActive = false;
        let urBoostEndTime = 0;
        let lrBoostActive = false; // New: LR Boost
        let lrBoostEndTime = 0; // New: LR Boost

        // --- Data for Shop Items (Diamonds) ---
        const shopItems = [
            { name: "‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", diamonds: 1000, realPrice: 99 },
            { name: "‡πÅ‡∏û‡πá‡∏Å‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°", diamonds: 5000, realPrice: 449 },
            { name: "‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ", diamonds: 10000, realPrice: 899 },
            { name: "‡πÅ‡∏û‡πá‡∏Å‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ", diamonds: 50000, realPrice: 10000 },
            { name: "‡πÅ‡∏û‡πá‡∏Å‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥", diamonds: 100000, realPrice: 15000 }
        ];

        // --- Data for Exchange Offers ---
        const exchangeOffers = [
            { rarity: "N", requiredCount: 500, diamondsReward: 100 },
            { rarity: "SR", requiredCount: 300, diamondsReward: 100 },
            { rarity: "SSR", requiredCount: 150, diamondsReward: 100 },
            { rarity: "UR", requiredCount: 1, diamondsReward: 5000 },
            { rarity: "LR", requiredCount: 1, diamondsReward: 15000 }
        ];

        // --- Data for Mini-Game Expeditions ---
        const expeditions = [
            {
                id: 'easy',
                name: '‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ (Easy Expedition)',
                description: '‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô N 5 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SR 1 ‡πÉ‡∏ö',
                cost: { N: 5, SR: 1, type: 'cards' },
                rewards: '50 üíé, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 5% ‡πÑ‡∏î‡πâ SSR Card',
                duration: 60 * 1000, // 1 minute in milliseconds
                statusId: 'easyExpeditionStatus',
                ongoingVar: 'easyExpeditionOngoing',
                endTimeVar: 'easyExpeditionEndTime',
                timerVar: 'easyExpeditionTimer'
            },
            {
                id: 'challenging',
                name: '‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (Challenging Expedition)',
                description: '‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô SSR 3 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ UR 1 ‡πÉ‡∏ö',
                cost: { SSR: 3, UR: 1, type: 'cards' },
                rewards: '500 üíé, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 1% ‡πÑ‡∏î‡πâ UR Card, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 0.1% ‡πÑ‡∏î‡πâ LR Card',
                duration: 5 * 60 * 1000, // 5 minutes
                statusId: 'challengingExpeditionStatus',
                ongoingVar: 'challengingExpeditionOngoing',
                endTimeVar: 'challengingExpeditionEndTime',
                timerVar: 'challengingExpeditionTimer'
            },
            {
                id: 'ancient_ruins',
                name: '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô (Ancient Ruins Exploration)',
                description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Stamina ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 200 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (UR 1 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SSR 5 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SR 10 ‡πÉ‡∏ö)',
                cost: { stamina: 200, type: 'stats' }, // Example for stat-based cost
                rewards: '1000 üíé, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 2% ‡πÑ‡∏î‡πâ LR Card',
                duration: 10 * 60 * 1000, // 10 minutes
                statusId: 'ancientRuinsExpeditionStatus',
                ongoingVar: 'ancientRuinsExpeditionOngoing',
                endTimeVar: 'ancientRuinsExpeditionEndTime',
                timerVar: 'ancientRuinsExpeditionTimer'
            },
            {
                id: 'summit_conquest',
                name: '‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ (Summit Conquest)',
                description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Attack ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 300 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (LR 1 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ UR 3 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SSR 10 ‡πÉ‡∏ö)',
                cost: { attack: 300, type: 'stats' },
                rewards: '5000 üíé, ‡∏Å‡∏≤‡∏£‡πå‡∏î LR 100%',
                duration: 30 * 60 * 1000, // 30 minutes
                statusId: 'summitConquestExpeditionStatus',
                ongoingVar: 'summitConquestExpeditionOngoing',
                endTimeVar: 'summitConquestExpeditionEndTime',
                timerVar: 'summitConquestExpeditionTimer'
            },
            {
                id: 'buddy_rescue',
                name: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ (Buddy Rescue Operation)',
                description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Defense ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 250 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞ N Card 50 ‡πÉ‡∏ö',
                cost: { defense: 250, N: 50, type: 'mixed' },
                rewards: '2500 üíé, ‡∏Å‡∏≤‡∏£‡πå‡∏î UR 100% (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)',
                duration: 15 * 60 * 1000, // 15 minutes
                statusId: 'buddyRescueExpeditionStatus',
                ongoingVar: 'buddyRescueExpeditionOngoing',
                endTimeVar: 'buddyRescueExpeditionEndTime',
                timerVar: 'buddyRescueExpeditionTimer'
            }
        ];


        const friendsData = [
            // LR (Legendary Rare) - 0.01% chance
            { rarity: "LR", name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏à‡∏≠‡∏°‡∏û‡∏•‡∏±‡∏á", image: "https://i.ibb.co/L51cFLQ/superduck.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏´‡πà‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•' - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏ä‡∏£‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏¥‡∏ï‡∏¥‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏±‡∏ö‡∏•‡πâ‡∏≤‡∏ô!", stats: { hp: 200, stamina: 100, attack: 150, defense: 120 } },
            // UR (Ultra Rare) - 0.04% chance
            { rarity: "UR", name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä", image: "https://i.ibb.co/L51cFLQ/superduck.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏•‡∏ø‡∏Å‡∏û‡∏µ‡∏ä‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å' - ‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ô‡πà‡∏≤‡∏ó‡∏±‡∏ä‡∏ô‡πà‡∏≤‡∏à‡∏∏‡πä‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏•‡∏á‡πÑ‡∏´‡∏•", stats: { hp: 150, stamina: 80, attack: 120, defense: 100 } },
            { rarity: "UR", name: "‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡∏ß‡∏ô‡πâ‡∏≠", image: "https://i.ibb.co/L51cFLQ/superduck.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô' - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏°‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠", stats: { hp: 140, stamina: 90, attack: 110, defense: 95 } },
            { rarity: "UR", name: "‡∏ï‡πâ‡∏≤‡∏ü‡∏±‡∏ô‡πÄ‡∏´‡∏¢‡∏¥‡∏ô", image: "https://i.ibb.co/L51cFLQ/superduck.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ü‡∏±‡∏ô‡πÄ‡∏â‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤' - ‡∏™‡∏Å‡∏¥‡∏•‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏â‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ß‡∏Å‡∏°‡∏∂‡∏á", stats: { hp: 160, stamina: 70, attack: 130, defense: 110 } },
            { rarity: "UR", name: "‡∏≠‡∏±‡∏á‡∏Å‡∏≠‡∏£‡πå‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä", image: "https://i.ibb.co/L51cFLQ/superduck.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏±‡πà‡∏á' - ‡∏£‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏¢‡∏±‡πà‡∏ß‡∏¢‡∏ß‡∏ô‡∏™‡∏≤‡∏ß‡πÜ!", stats: { hp: 130, stamina: 110, attack: 100, defense: 80 } },
            // SSR (Super Super Rare) - 5% chance
            { rarity: "SSR", name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏Ñ‡∏ô‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì", image: "https://i.ibb.co/y4p8R0c/ajarnyord.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÄ‡∏´‡∏á‡∏≤‡∏à‡∏±‡∏ö‡πÉ‡∏à' - ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏î ‡πÄ‡∏Ç‡∏≤‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏≠‡πÉ‡∏à‡πÄ‡∏•‡∏µ‡∏¢‡πÑ‡∏≠‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á", stats: { hp: 100, stamina: 60, attack: 80, defense: 70 } },
            { rarity: "SSR", name: "‡∏°‡∏µ‡∏ô‡∏ï‡∏π‡∏î‡∏´‡∏°‡∏∂‡∏Å", image: "https://i.ibb.co/y4p8R0c/ajarnyord.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ï‡∏π‡∏î‡∏´‡∏°‡∏∂‡∏Å‡∏≠‡∏≤‡∏•‡∏∞‡∏ß‡∏≤‡∏î' - ‡∏ï‡∏π‡∏î‡∏´‡∏°‡∏∂‡∏Å‡∏¢‡∏±‡∏Å‡∏©‡πå‡∏à‡∏∞‡∏û‡πà‡∏ô‡∏´‡∏°‡∏∂‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î‡∏°‡∏¥‡∏î", stats: { hp: 95, stamina: 70, attack: 85, defense: 75 } },
            { rarity: "SSR", name: "‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä", image: "https://i.ibb.co/y4p8R0c/ajarnyord.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏•‡∏°‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏∑‡πà‡∏ô' - ‡πÅ‡∏Ñ‡πà‡∏û‡∏±‡∏î‡πÄ‡∏ö‡∏≤‡πÜ ‡∏Å‡πá‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏∑‡πà‡∏ô", stats: { hp: 105, stamina: 65, attack: 75, defense: 80 } },
            { rarity: "SSR", name: "‡πÅ‡∏ö‡∏á‡∏Ñ‡πå‡∏Ñ‡πá‡∏≠‡∏Å", image: "https://i.ibb.co/y4p8R0c/ajarnyord.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ï‡∏£‡∏µ' - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏á‡∏Ñ‡πå‡∏Ñ‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å", stats: { hp: 90, stamina: 80, attack: 90, defense: 65 } },
            { rarity: "SSR", name: "‡∏ô‡πâ‡∏≠‡∏á‡πÑ‡∏ô‡∏ó‡πå‡∏Ñ‡∏ô‡∏™‡∏ß‡∏¢", image: "https://i.ibb.co/y4p8R0c/ajarnyord.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏™‡∏ß‡∏¢‡∏à‡∏ô‡πÄ‡∏´‡∏•‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á' - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏´‡∏¢‡∏∏‡∏î‡πÇ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≠‡∏á‡∏à‡∏ô‡πÄ‡∏´‡∏•‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á", stats: { hp: 110, stamina: 55, attack: 80, defense: 70 } },
            // SR (Super Rare) - 15% chance
            { rarity: "SR", name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏î‡∏∏‡πä‡∏Å‡∏î‡∏¥‡πä‡∏Å", image: "https://i.ibb.co/RgJ70QG/chick.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÄ‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢' - ‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏ï‡πâ‡∏ô‡∏î‡∏∏‡πä‡∏Å‡∏î‡∏¥‡πä‡∏Å‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏°‡∏∂‡∏ô‡∏á‡∏á!", stats: { hp: 70, stamina: 40, attack: 50, defense: 45 } },
            { rarity: "SR", name: "‡∏ö‡∏±‡∏Å‡∏´‡∏ô‡∏≠‡∏°", image: "https://i.ibb.co/RgJ70QG/chick.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢' - ‡∏´‡∏ô‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏à‡∏≠‡∏°‡∏ã‡∏ô‡∏à‡∏∞‡∏ï‡∏≤‡∏°‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢", stats: { hp: 65, stamina: 45, attack: 55, defense: 40 } },
            { rarity: "SR", name: "‡πÄ‡∏õ‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏≠‡∏¢‡∏ô‡πâ‡∏≥", image: "https://i.ibb.co/RgJ70QG/chick.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ã‡∏¥‡∏Å‡πÅ‡∏ã‡∏Å' - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ï‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô", stats: { hp: 75, stamina: 35, attack: 45, defense: 50 } },
            // N (Normal) - 79.95% chance
            { rarity: "N", name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤", image: "https://i.ibb.co/Vv3y3kS/rabbit.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ß‡∏¥‡πà‡∏á‡∏´‡∏ô‡∏µ' - ‡∏™‡∏Å‡∏¥‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏ß‡∏¥‡πà‡∏á 100 ‡πÄ‡∏°‡∏ï‡∏£‡πÉ‡∏ô 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ", stats: { hp: 50, stamina: 30, attack: 20, defense: 25 } },
            { rarity: "N", name: "‡πÅ‡∏°‡∏ß‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß‡∏à‡∏≠‡∏°‡∏ã‡∏ô", image: "https://i.ibb.co/Vv3y3kS/rabbit.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏ö' - ‡∏´‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÑ‡∏õ‡πÉ‡∏ô‡∏û‡∏∏‡πà‡∏°‡πÑ‡∏°‡πâ", stats: { hp: 45, stamina: 35, attack: 18, defense: 22 } },
            { rarity: "N", name: "‡∏´‡∏°‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå", image: "https://i.ibb.co/Vv3y3kS/rabbit.jpg", skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô' - ‡∏™‡∏Å‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô", stats: { hp: 55, stamina: 25, attack: 22, defense: 28 } }
        ];

        // Global variables for mini-game expeditions
        let easyExpeditionOngoing = false;
        let easyExpeditionEndTime = 0;
        let challengingExpeditionOngoing = false;
        let challengingExpeditionEndTime = 0;
        let ancientRuinsExpeditionOngoing = false;
        let ancientRuinsExpeditionEndTime = 0;
        let summitConquestExpeditionOngoing = false;
        let summitConquestExpeditionEndTime = 0;
        let buddyRescueExpeditionOngoing = false;
        let buddyRescueExpeditionEndTime = 0;

        function saveGameData() {
            const gameData = {
                rollCounter: rollCounter,
                diamondCount: diamondCount,
                topUpCount: topUpCount,
                inventory: inventory,
                rollsSinceLastUR: rollsSinceLastUR,
                rollsSinceLastLR: rollsSinceLastLR,
                urBoostActive: urBoostActive,
                urBoostEndTime: urBoostEndTime,
                lrBoostActive: lrBoostActive,
                lrBoostEndTime: lrBoostEndTime,
                easyExpeditionOngoing: easyExpeditionOngoing,
                easyExpeditionEndTime: easyExpeditionEndTime,
                challengingExpeditionOngoing: challengingExpeditionOngoing,
                challengingExpeditionEndTime: challengingExpeditionEndTime,
                ancientRuinsExpeditionOngoing: ancientRuinsExpeditionOngoing,
                ancientRuinsExpeditionEndTime: ancientRuinsExpeditionEndTime,
                summitConquestExpeditionOngoing: summitConquestExpeditionOngoing,
                summitConquestExpeditionEndTime: summitConquestExpeditionEndTime,
                buddyRescueExpeditionOngoing: buddyRescueExpeditionOngoing,
                buddyRescueExpeditionEndTime: buddyRescueExpeditionEndTime
            };
            localStorage.setItem('gachaGameData', JSON.stringify(gameData));
            console.log('Game data saved!');
        }

        function loadGameData() {
            const savedData = localStorage.getItem('gachaGameData');
            if (savedData) {
                const gameData = JSON.parse(savedData);
                rollCounter = gameData.rollCounter || 0;
                diamondCount = gameData.diamondCount || 0;
                topUpCount = gameData.topUpCount || 0;
                inventory = gameData.inventory || {};
                rollsSinceLastUR = gameData.rollsSinceLastUR || 0;
                rollsSinceLastLR = gameData.rollsSinceLastLR || 0;
                urBoostActive = gameData.urBoostActive || false;
                urBoostEndTime = gameData.urBoostEndTime || 0;
                lrBoostActive = gameData.lrBoostActive || false;
                lrBoostEndTime = gameData.lrBoostEndTime || 0;

                easyExpeditionOngoing = gameData.easyExpeditionOngoing || false;
                easyExpeditionEndTime = gameData.easyExpeditionEndTime || 0;
                challengingExpeditionOngoing = gameData.challengingExpeditionOngoing || false;
                challengingExpeditionEndTime = gameData.challengingExpeditionEndTime || 0;
                ancientRuinsExpeditionOngoing = gameData.ancientRuinsExpeditionOngoing || false;
                ancientRuinsExpeditionEndTime = gameData.ancientRuinsExpeditionEndTime || 0;
                summitConquestExpeditionOngoing = gameData.summitConquestExpeditionOngoing || false;
                summitConquestExpeditionEndTime = gameData.summitConquestExpeditionEndTime || 0;
                buddyRescueExpeditionOngoing = gameData.buddyRescueExpeditionOngoing || false;
                buddyRescueExpeditionEndTime = gameData.buddyRescueExpeditionEndTime || 0;

                console.log('Game data loaded!');
            }
            updateUI();
            checkAllBoostsStatus(); // Check boost status on load
            updateMiniGameButtons(); // Update mini-game status on load
        }

        function updateUI() {
            document.getElementById('diamondCount').textContent = diamondCount.toLocaleString();
            document.getElementById('rollCount').textContent = rollCounter.toLocaleString();
            document.getElementById('topUpCount').textContent = topUpCount.toLocaleString();

            // Update boost statuses
            const urBoostStatusElement = document.getElementById('urBoostStatus');
            const lrBoostStatusElement = document.getElementById('lrBoostStatus');
            const buyURBoostBtn = document.getElementById('buyURBoostBtn');
            const buyLRBoostBtn = document.getElementById('buyLRBoostBtn');

            if (urBoostActive && urBoostEndTime > Date.now()) {
                const timeLeft = Math.ceil((urBoostEndTime - Date.now()) / 1000);
                urBoostStatusElement.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (${formatTime(timeLeft)})`;
                buyURBoostBtn.disabled = true;
            } else {
                urBoostActive = false;
                urBoostEndTime = 0;
                urBoostStatusElement.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                buyURBoostBtn.disabled = false;
            }

            if (lrBoostActive && lrBoostEndTime > Date.now()) {
                const timeLeft = Math.ceil((lrBoostEndTime - Date.now()) / 1000);
                lrBoostStatusElement.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (${formatTime(timeLeft)})`;
                buyLRBoostBtn.disabled = true;
            } else {
                lrBoostActive = false;
                lrBoostEndTime = 0;
                lrBoostStatusElement.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                buyLRBoostBtn.disabled = false;
            }

            updateExchangeButtons();
            updateMiniGameButtons(); // Ensure mini-game buttons are updated with current counts
            saveGameData();
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }


        function showErrorMessage(message) {
            const errorMessageElement = document.getElementById('errorMessage');
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
            setTimeout(() => {
                errorMessageElement.style.display = 'none';
            }, 3000);
        }

        function handleRoll(numRolls) {
            let cost = (numRolls === 10) ? COST_TEN_ROLLS : COST_PER_ROLL;

            if (diamondCount < cost) {
                showErrorMessage('‡πÄ‡∏û‡∏ä‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏ä‡∏£');
                return;
            }

            diamondCount -= cost;
            rollCounter += numRolls;
            document.getElementById('resultsContainer').innerHTML = ''; // Clear previous results

            for (let i = 0; i < numRolls; i++) {
                const friend = getRandomFriend();
                displayFriend(friend);
                addFriendToInventory(friend);

                if (friend.rarity === 'UR') {
                    openPopup('urPopupOverlay');
                    rollsSinceLastUR = 0;
                } else {
                    rollsSinceLastUR++;
                }

                if (friend.rarity === 'LR') {
                    openPopup('lrPopupOverlay');
                    rollsSinceLastLR = 0;
                } else {
                    rollsSinceLastLR++;
                }
            }
            updateUI();
        }

        function getRandomFriend() {
            let totalChance = 0;
            let urChance = 0.04; // Base UR chance
            let lrChance = 0.01; // Base LR chance
            let ssrChance = 5;
            let srChance = 15;
            let nChance = 79.95;

            // Apply boost effects
            if (urBoostActive && urBoostEndTime > Date.now()) {
                urChance *= 2;
                // Distribute the extra UR chance by reducing N chance proportionally
                const boostAmount = 0.04; // The increase from x1 to x2
                if (nChance - boostAmount >= 0) {
                    nChance -= boostAmount;
                } else {
                    // If N chance is too low, adjust from SR or SSR
                    srChance -= boostAmount / 2;
                    ssrChance -= boostAmount / 2;
                }
            }
            if (lrBoostActive && lrBoostEndTime > Date.now()) {
                lrChance *= 2;
                // Distribute the extra LR chance
                const boostAmount = 0.01;
                 if (nChance - boostAmount >= 0) {
                    nChance -= boostAmount;
                } else {
                    srChance -= boostAmount / 2;
                    ssrChance -= boostAmount / 2;
                }
            }

            // Pity system
            if (rollsSinceLastUR >= PITY_ROLLS_FOR_UR) {
                urChance = 100; // Guarantee UR
                lrChance = 0; ssrChance = 0; srChance = 0; nChance = 0; // Other chances to 0
                console.log("UR Pity Activated!");
            }
            if (rollsSinceLastLR >= PITY_ROLLS_FOR_LR) {
                lrChance = 100; // Guarantee LR
                urChance = 0; ssrChance = 0; srChance = 0; nChance = 0; // Other chances to 0
                console.log("LR Pity Activated!");
            }

            const chances = {
                "LR": lrChance,
                "UR": urChance,
                "SSR": ssrChance,
                "SR": srChance,
                "N": nChance
            };

            // Recalculate total chance to ensure it sums to 100 (or very close)
            totalChance = Object.values(chances).reduce((sum, chance) => sum + chance, 0);

            let random = Math.random() * totalChance; // Scale random number to total chance

            let cumulativeChance = 0;
            for (let i = 0; i < friendsData.length; i++) {
                const friend = friendsData[i];
                cumulativeChance += chances[friend.rarity];
                if (random < cumulativeChance) {
                    return friend;
                }
            }
            // Fallback in case of floating point inaccuracies, return a random N card
            return friendsData.filter(f => f.rarity === 'N')[Math.floor(Math.random() * friendsData.filter(f => f.rarity === 'N').length)];
        }


        function displayFriend(friend) {
            const resultsContainer = document.getElementById('resultsContainer');
            const cardContainer = document.createElement('div');
            cardContainer.className = `card-container rarity-${friend.rarity.toLowerCase()}`;

            cardContainer.innerHTML = `
                <div id="rarityDisplay" class="rarity-display ${friend.rarity.toLowerCase()}">${friend.rarity}</div>
                <img src="${friend.image}" alt="${friend.name}" class="card-image">
                <div class="card-name">${friend.name}</div>
                <div class="card-skill">${friend.skill}</div>
                <div class="card-stats">
                    <span>HP: ${friend.stats.hp}</span>
                    <span>Stamina: ${friend.stats.stamina}</span>
                    <span>Attack: ${friend.stats.attack}</span>
                    <span>Defense: ${friend.stats.defense}</span>
                </div>
            `;
            resultsContainer.appendChild(cardContainer);
        }

        function addFriendToInventory(friend) {
            if (inventory[friend.name]) {
                inventory[friend.name].count++;
            } else {
                inventory[friend.name] = {
                    friendData: friend,
                    count: 1
                };
            }
        }

        function openPopup(popupId) {
            document.getElementById(popupId).classList.add('active');
        }

        function closePopup(popupId) {
            document.getElementById(popupId).classList.remove('active');
        }

        // --- Shop Functions ---
        function renderShopItems() {
            const container = document.getElementById('shopItemsContainer');
            container.innerHTML = ''; // Clear existing items

            shopItems.forEach(item => {
                const shopItemDiv = document.createElement('div');
                shopItemDiv.className = 'shop-item';
                shopItemDiv.innerHTML = `
                    <div class="shop-item-info">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price">
                            <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                            ${item.diamonds.toLocaleString()} ‡πÄ‡∏û‡∏ä‡∏£ <span class="shop-item-real-price">(‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.realPrice} ‡∏ö‡∏≤‡∏ó)</span>
                        </div>
                    </div>
                    <button class="buy-button" onclick="buyDiamonds(${item.diamonds}, ${item.realPrice})">‡∏ã‡∏∑‡πâ‡∏≠</button>
                `;
                container.appendChild(shopItemDiv);
            });
        }

        function renderExchangeOffers() {
            const container = document.getElementById('exchangeOffersContainer');
            container.innerHTML = ''; // Clear existing offers

            exchangeOffers.forEach(offer => {
                const currentCount = Object.values(inventory).filter(card => card.friendData.rarity === offer.rarity).reduce((sum, card) => sum + card.count, 0);
                const disabled = currentCount < offer.requiredCount ? 'disabled' : '';

                const exchangeItemDiv = document.createElement('div');
                exchangeItemDiv.className = 'exchange-item';
                exchangeItemDiv.innerHTML = `
                    <div class="exchange-item-info">
                        <div class="shop-item-name">‡πÅ‡∏•‡∏Å ${offer.rarity} Cards ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</div>
                        <div class="exchange-cost">‡πÉ‡∏ä‡πâ <span id="cardCount${offer.rarity}">${currentCount}</span>/${offer.requiredCount} ‡πÉ‡∏ö ${offer.rarity} <span>‡πÑ‡∏î‡πâ ${offer.diamondsReward.toLocaleString()} üíé</span></div>
                    </div>
                    <button class="exchange-button" id="exchange${offer.rarity}Btn" onclick="exchangeCards('${offer.rarity}', ${offer.requiredCount}, ${offer.diamondsReward})" ${disabled}>‡πÅ‡∏•‡∏Å</button>
                `;
                container.appendChild(exchangeItemDiv);
            });
        }

        function openShop() {
            renderShopItems();
            renderExchangeOffers(); // Render exchange offers when opening shop
            openPopup('shopPopupOverlay');
            updateUI(); // Ensure counts and button states are fresh
        }

        function closeShop() {
            closePopup('shopPopupOverlay');
        }

        function buyDiamonds(amount, price) {
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ ${amount.toLocaleString()} ‡πÄ‡∏û‡∏ä‡∏£ ‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${price} ‡∏ö‡∏≤‡∏ó ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                diamondCount += amount;
                topUpCount++;
                alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${amount.toLocaleString()} ‡πÄ‡∏û‡∏ä‡∏£!`);
                updateUI();
                renderExchangeOffers(); // Re-render exchange offers after buying diamonds (in case it affects counts)
            }
        }

        function exchangeCards(rarity, requiredCount, diamondReward) {
            let cardsToExchange = [];
            let currentCount = 0;

            // Collect all cards of the specified rarity
            for (const cardName in inventory) {
                if (inventory[cardName].friendData.rarity === rarity) {
                    cardsToExchange.push(inventory[cardName]);
                    currentCount += inventory[cardName].count;
                }
            }

            if (currentCount < requiredCount) {
                showErrorMessage(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î ${rarity} ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å!`);
                return;
            }

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${requiredCount} ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö ${rarity} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö ${diamondReward.toLocaleString()} ‡πÄ‡∏û‡∏ä‡∏£ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                let exchanged = 0;
                for (let i = 0; i < cardsToExchange.length; i++) {
                    const card = cardsToExchange[i];
                    const take = Math.min(card.count, requiredCount - exchanged);
                    card.count -= take;
                    exchanged += take;

                    if (card.count === 0) {
                        delete inventory[card.friendData.name];
                    }

                    if (exchanged >= requiredCount) {
                        break;
                    }
                }

                diamondCount += diamondReward;
                alert(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î ${rarity} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${diamondReward.toLocaleString()} ‡πÄ‡∏û‡∏ä‡∏£!`);
                updateUI();
                renderExchangeOffers(); // Re-render to update counts and button states
                renderInventory(); // Re-render inventory to show removed cards
            }
        }

        function updateExchangeButtons() {
            exchangeOffers.forEach(offer => {
                const countElement = document.getElementById(`cardCount${offer.rarity}`);
                const buttonElement = document.getElementById(`exchange${offer.rarity}Btn`);
                if (countElement && buttonElement) {
                    const currentCount = Object.values(inventory).filter(card => card.friendData.rarity === offer.rarity).reduce((sum, card) => sum + card.count, 0);
                    countElement.textContent = currentCount;
                    buttonElement.disabled = currentCount < offer.requiredCount;
                }
            });
        }


        // --- Inventory Functions ---
        function renderInventory() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = ''; // Clear existing inventory

            const sortedInventory = Object.values(inventory).sort((a, b) => {
                const rarityOrder = { "LR": 0, "UR": 1, "SSR": 2, "SR": 3, "N": 4 };
                return rarityOrder[a.friendData.rarity] - rarityOrder[b.friendData.rarity];
            });

            if (sortedInventory.length === 0) {
                inventoryGrid.innerHTML = '<p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á.</p>';
                return;
            }

            sortedInventory.forEach(item => {
                const card = item.friendData;
                const inventoryItemDiv = document.createElement('div');
                inventoryItemDiv.className = 'inventory-item';
                inventoryItemDiv.setAttribute('data-card-name', card.name); // Add data attribute to identify card

                inventoryItemDiv.innerHTML = `
                    <div class="rarity-label ${card.rarity.toLowerCase()}">${card.rarity}</div>
                    <img src="${card.image}" alt="${card.name}">
                    <div class="name">${card.name}</div>
                    <div class="count">${item.count}</div>
                    <div class="stats">
                        <span>HP: ${card.stats.hp}</span>
                        <span>Stamina: ${card.stats.stamina}</span>
                        <span>Attack: ${card.stats.attack}</span>
                        <span>Defense: ${card.stats.defense}</span>
                    </div>
                `;
                inventoryGrid.appendChild(inventoryItemDiv);
            });
        }

        function openInventory() {
            renderInventory();
            openPopup('inventoryPopupOverlay');
        }


        // --- Mini-Game Functions ---
        function renderExpeditions() {
            const container = document.getElementById('miniGameExpeditionsContainer');
            container.innerHTML = ''; // Clear existing expeditions

            expeditions.forEach(expedition => {
                const expeditionDiv = document.createElement('div');
                expeditionDiv.className = 'mini-game-section';

                let costHtml = '';
                let canStart = true;
                let currentCostValues = {}; // To display current card/stat counts

                if (expedition.cost.type === 'cards') {
                    const costParts = [];
                    for (const rarity in expedition.cost) {
                        if (rarity !== 'type') {
                            const currentCount = Object.values(inventory).filter(card => card.friendData.rarity === rarity).reduce((sum, card) => sum + card.count, 0);
                            currentCostValues[rarity] = currentCount;
                            costParts.push(`‡∏Å‡∏≤‡∏£‡πå‡∏î ${rarity}: <span id="miniGame${expedition.id.charAt(0).toUpperCase() + expedition.id.slice(1)}${rarity}Count">${currentCount}</span>/${expedition.cost[rarity]}`);
                            if (currentCount < expedition.cost[rarity]) {
                                canStart = false; // Cannot start if not enough cards of a required type
                            }
                        }
                    }
                    costHtml = costParts.join(' ‡∏´‡∏£‡∏∑‡∏≠ '); // Use '‡∏´‡∏£‡∏∑‡∏≠' for OR conditions
                } else if (expedition.cost.type === 'stats') {
                    let totalStat = 0;
                    let statName = Object.keys(expedition.cost).find(key => key !== 'type');
                    Object.values(inventory).forEach(card => {
                        if (card.friendData.stats && card.friendData.stats[statName]) {
                            totalStat += card.friendData.stats[statName] * card.count;
                        }
                    });
                    currentCostValues[statName] = totalStat;
                    costHtml = `${statName.charAt(0).toUpperCase() + statName.slice(1)} ‡∏£‡∏ß‡∏°: <span id="miniGame${expedition.id.charAt(0).toUpperCase() + expedition.id.slice(1)}${statName}Count">${totalStat}</span>/${expedition.cost[statName]}`;
                    if (totalStat < expedition.cost[statName]) {
                        canStart = false;
                    }
                } else if (expedition.cost.type === 'mixed') {
                    const costParts = [];
                    let totalDefense = 0;
                    let nCardCount = 0;

                    Object.values(inventory).forEach(card => {
                        if (card.friendData.stats && card.friendData.stats.defense) {
                            totalDefense += card.friendData.stats.defense * card.count;
                        }
                        if (card.friendData.rarity === 'N') {
                            nCardCount += card.count;
                        }
                    });
                    currentCostValues['defense'] = totalDefense;
                    currentCostValues['N'] = nCardCount;

                    costParts.push(`Defense ‡∏£‡∏ß‡∏°: <span id="miniGame${expedition.id.charAt(0).toUpperCase() + expedition.id.slice(1)}DefenseCount">${totalDefense}</span>/${expedition.cost.defense}`);
                    costParts.push(`N Card: <span id="miniGame${expedition.id.charAt(0).toUpperCase() + expedition.id.slice(1)}NCount">${nCardCount}</span>/${expedition.cost.N}`);

                    costHtml = costParts.join(', ');

                    if (totalDefense < expedition.cost.defense || nCardCount < expedition.cost.N) {
                        canStart = false;
                    }
                }

                const statusVar = window[expedition.ongoingVar];
                const endTimeVar = window[expedition.endTimeVar];
                const isOngoing = statusVar && endTimeVar > Date.now();
                const buttonDisabled = isOngoing || !canStart ? 'disabled' : '';
                const buttonText = isOngoing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢...' : `‡πÄ‡∏£‡∏¥‡πà‡∏°${expedition.name.split('(')[0].trim()} (${expedition.duration / 1000 / 60} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
                const statusText = isOngoing ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(Math.ceil((endTimeVar - Date.now()) / 1000))}` : '';

                expeditionDiv.innerHTML = `
                    <h3>${expedition.name}</h3>
                    <p>${expedition.description}</p>
                    <div class="mini-game-cost"> ${costHtml} </div>
                    <div class="mini-game-rewards">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${expedition.rewards}</div>
                    <button class="mini-game-button" id="startExpedition${expedition.id.replace(/_/g, '')}Btn" onclick="startExpedition('${expedition.id}')" ${buttonDisabled}>${buttonText}</button>
                    <div class="mini-game-status" id="${expedition.statusId}">${statusText}</div>
                `;
                container.appendChild(expeditionDiv);
            });
        }

        function openMiniGame() {
            renderExpeditions(); // Render expeditions when opening mini-game
            openPopup('miniGamePopupOverlay');
            updateUI(); // Ensure button states are fresh
        }

        function startExpedition(expeditionId) {
            const expedition = expeditions.find(exp => exp.id === expeditionId);
            if (!expedition) return;

            let canProceed = true;
            let cardsUsed = []; // To store cards actually consumed

            if (expedition.cost.type === 'cards') {
                const availableCards = {};
                for (const rarity in expedition.cost) {
                    if (rarity !== 'type') {
                        availableCards[rarity] = Object.values(inventory).filter(card => card.friendData.rarity === rarity).reduce((sum, card) => sum + card.count, 0);
                    }
                }

                // Check if either condition (N cards OR SR cards) is met for easy expedition
                if (expeditionId === 'easy') {
                    if (availableCards['N'] >= expedition.cost['N']) {
                        // Use N cards
                        let tempCount = 0;
                        for (const cardName in inventory) {
                            if (inventory[cardName].friendData.rarity === 'N') {
                                const take = Math.min(inventory[cardName].count, expedition.cost['N'] - tempCount);
                                if (take > 0) {
                                    cardsUsed.push({ name: cardName, count: take, rarity: 'N' });
                                    tempCount += take;
                                }
                                if (tempCount >= expedition.cost['N']) break;
                            }
                        }
                    } else if (availableCards['SR'] >= expedition.cost['SR']) {
                        // Use SR cards
                        let tempCount = 0;
                        for (const cardName in inventory) {
                            if (inventory[cardName].friendData.rarity === 'SR') {
                                const take = Math.min(inventory[cardName].count, expedition.cost['SR'] - tempCount);
                                if (take > 0) {
                                    cardsUsed.push({ name: cardName, count: take, rarity: 'SR' });
                                    tempCount += take;
                                }
                                if (tempCount >= expedition.cost['SR']) break;
                            }
                        }
                    } else {
                        canProceed = false;
                        showErrorMessage(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${expedition.name}!`);
                    }
                }
                // Check if either condition (SSR cards OR UR cards) is met for challenging expedition
                else if (expeditionId === 'challenging') {
                    if (availableCards['SSR'] >= expedition.cost['SSR']) {
                        // Use SSR cards
                        let tempCount = 0;
                        for (const cardName in inventory) {
                            if (inventory[cardName].friendData.rarity === 'SSR') {
                                const take = Math.min(inventory[cardName].count, expedition.cost['SSR'] - tempCount);
                                if (take > 0) {
                                    cardsUsed.push({ name: cardName, count: take, rarity: 'SSR' });
                                    tempCount += take;
                                }
                                if (tempCount >= expedition.cost['SSR']) break;
                            }
                        }
                    } else if (availableCards['UR'] >= expedition.cost['UR']) {
                        // Use UR cards
                        let tempCount = 0;
                        for (const cardName in inventory) {
                            if (inventory[cardName].friendData.rarity === 'UR') {
                                const take = Math.min(inventory[cardName].count, expedition.cost['UR'] - tempCount);
                                if (take > 0) {
                                    cardsUsed.push({ name: cardName, count: take, rarity: 'UR' });
                                    tempCount += take;
                                }
                                if (tempCount >= expedition.cost['UR']) break;
                            }
                        }
                    } else {
                        canProceed = false;
                        showErrorMessage(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${expedition.name}!`);
                    }
                }
                // Default logic for other card type costs
                else {
                     for (const rarity in expedition.cost) {
                        if (rarity !== 'type') {
                            const currentCount = Object.values(inventory).filter(card => card.friendData.rarity === rarity).reduce((sum, card) => sum + card.count, 0);
                            if (currentCount < expedition.cost[rarity]) {
                                canProceed = false;
                                showErrorMessage(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î ${rarity} ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${expedition.name}!`);
                                break;
                            }
                            // If enough, collect cards for consumption
