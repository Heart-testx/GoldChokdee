<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≠‡∏á,‡πÄ‡∏á‡∏¥‡∏ô,‡∏ô‡∏≤‡∏Å</title>
  
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for easy theme switching */
    :root {
      --bg-color: #e0e0e0; /* Light mode: ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏õ‡∏π‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢ */
      --text-color: #333333; /* Light mode: ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
      --container-bg: #f2f2f2; /* Light mode: ‡∏Ç‡∏≤‡∏ß‡∏≠‡∏°‡πÄ‡∏ó‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö container */
      --border-color: #b0b0b0; /* Light mode: ‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡πÜ */
      --box-shadow-color: rgba(0,0,0,0.15); /* Light mode: ‡πÄ‡∏á‡∏≤ */
      --tab-inactive-bg: #e0e0e0; /* Light mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á tab ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà active */
      --tab-inactive-text: #666666; /* Light mode: ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° tab ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà active */
      --tab-active-bg: #ffffff; /* Light mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á tab ‡∏ó‡∏µ‡πà active */
      --tab-active-text: #333333; /* Light mode: ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° tab ‡∏ó‡∏µ‡πà active */
      --tab-active-border: #6c757d; /* Light mode: ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ active tab */
      --input-bg: #ffffff; /* Light mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á input */
      --input-text: #333333; /* Light mode: ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° input */
      --input-placeholder: #888888; /* Light mode: ‡∏™‡∏µ placeholder */
      --button-bg: #6c757d; /* Light mode: ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
      --button-text: white; /* Light mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≤‡∏ß‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏° */
      --button-hover-bg: #5a6268; /* Light mode: ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
      --reset-btn-bg: #dc3545; /* Light mode: ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡πÅ‡∏î‡∏á */
      --reset-btn-hover-bg: #c82333; /* Light mode: ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡πÅ‡∏î‡∏á hover */
      --popup-bg: #f2f2f2; /* Light mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á popup */
      --popup-text: #333333; /* Light mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° popup */
      --popup-close-btn: #888888; /* Light mode: ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î popup */
      --history-bg: #f2f2f2; /* Light mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á history section */
      --history-list-bg: #ffffff; /* Light mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á list item */
      --history-item-border: #e0e0e0; /* Light mode: ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á item */
      --history-item-text: #555555; /* Light mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° item */
      --history-item-time: #777; /* Light mode: ‡πÄ‡∏ß‡∏•‡∏≤ item */
      --gold-item-bg: #fcf8e3; /* Light mode: ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
      --gold-item-border: #d4af37; /* Light mode: ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
      --silver-item-bg: #f0f4f7; /* Light mode: ‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
      --silver-item-border: #a0a0a0; /* Light mode: ‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
      --link-color: #6c757d; /* Light mode: ‡∏™‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå */
    }

    /* Dark Mode Styles */
    body.dark-mode {
      --bg-color: #2c2c2c; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
      --text-color: #e0e0e0; /* Dark mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --container-bg: #3a3a3a; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á container ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
      --border-color: #555555; /* Dark mode: ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
      --box-shadow-color: rgba(0,0,0,0.4); /* Dark mode: ‡πÄ‡∏á‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
      --tab-inactive-bg: #4a4a4a; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á tab ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà active */
      --tab-inactive-text: #bbbbbb; /* Dark mode: ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° tab ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà active */
      --tab-active-bg: #2c2c2c; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á tab ‡∏ó‡∏µ‡πà active */
      --tab-active-text: #ffffff; /* Dark mode: ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° tab ‡∏ó‡∏µ‡πà active */
      --tab-active-border: #888888; /* Dark mode: ‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ active tab */
      --input-bg: #4a4a4a; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á input ‡πÄ‡∏Ç‡πâ‡∏° */
      --input-text: #e0e0e0; /* Dark mode: ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° input ‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --input-placeholder: #aaaaaa; /* Dark mode: ‡∏™‡∏µ placeholder ‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --button-bg: #555555; /* Dark mode: ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° */
      --button-text: #e0e0e0; /* Dark mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏° */
      --button-hover-bg: #666666; /* Dark mode: ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
      --reset-btn-bg: #a03030; /* Dark mode: ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
      --reset-btn-hover-bg: #b04040; /* Dark mode: ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° hover */
      --popup-bg: #3a3a3a; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á popup ‡πÄ‡∏Ç‡πâ‡∏° */
      --popup-text: #e0e0e0; /* Dark mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° popup ‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --popup-close-btn: #aaaaaa; /* Dark mode: ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î popup ‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --history-bg: #3a3a3a; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á history section ‡πÄ‡∏Ç‡πâ‡∏° */
      --history-list-bg: #4a4a4a; /* Dark mode: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á list item ‡πÄ‡∏Ç‡πâ‡∏° */
      --history-item-border: #555555; /* Dark mode: ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á item ‡πÄ‡∏Ç‡πâ‡∏° */
      --history-item-text: #bbbbbb; /* Dark mode: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° item ‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --history-item-time: #aaaaaa; /* Dark mode: ‡πÄ‡∏ß‡∏•‡∏≤ item ‡∏™‡∏ß‡πà‡∏≤‡∏á */
      --gold-item-bg: #4a4230; /* Dark mode: ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÜ ‡πÄ‡∏Ç‡πâ‡∏° */
      --gold-item-border: #d4af37; /* Dark mode: ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
      --silver-item-bg: #40454a; /* Dark mode: ‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÜ ‡πÄ‡∏Ç‡πâ‡∏° */
      --silver-item-border: #a0a0a0; /* Dark mode: ‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
      --link-color: #99ccff; /* Dark mode: ‡∏™‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 15px;
      margin: 0;
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
    }

    .theme-toggle {
        position: fixed; /* Changed to fixed */
        top: 15px; /* Adjust as needed */
        right: 15px; /* Adjust as needed */
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: var(--text-color);
        transition: color 0.2s ease;
        padding: 5px;
        line-height: 1;
        z-index: 1001; /* Ensure it's above other elements */
    }
    .theme-toggle:hover {
        color: var(--tab-active-border); /* Use a highlight color */
    }

    .container {
      max-width: 420px;
      width: 95%;
      margin: 25px auto 10px auto;
      background-color: var(--container-bg);
      border: 2px solid var(--border-color);
      border-radius: 0px;
      box-shadow: 0 4px 8px var(--box-shadow-color);
      position: relative; /* Keep relative for internal elements if needed, but not for toggle */
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
    }

    .tab-button {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      cursor: pointer;
      background-color: var(--tab-inactive-bg);
      border: none;
      border-radius: 0px;
      font-size: 1.1em;
      font-weight: 600;
      color: var(--tab-inactive-text);
      transition: background-color 0.2s ease, color 0.2s ease;
      border-right: 1px solid var(--border-color); /* Use border-color for tab dividers */
    }

    .tab-button:last-child {
        border-right: none;
    }

    .tab-button.active {
      background-color: var(--tab-active-bg);
      color: var(--tab-active-text);
      border-bottom: 3px solid var(--tab-active-border);
      font-weight: 700;
    }

    .tab-button:hover:not(.active) {
      background-color: var(--tab-inactive-bg); /* Use inactive bg for hover */
      filter: brightness(0.9); /* Slightly darken on hover */
    }

    .calculator {
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 20px;
      font-size: 1.6em;
      font-weight: 600;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 400;
      font-size: 0.95em;
      color: var(--text-color);
    }

    input {
      width: calc(100% - 22px);
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 0px;
      background-color: var(--input-bg);
      color: var(--input-text);
      font-size: 1em;
      font-family: 'Sarabun', sans-serif;
      margin-bottom: 5px;
      outline: none;
      box-sizing: border-box;
    }

    input::placeholder {
        color: var(--input-placeholder);
    }

    input:focus {
      border-color: var(--tab-active-border);
      box-shadow: 0 0 5px var(--box-shadow-color);
    }

    input.is-invalid {
      border-color: #dc3545; /* Red for error, constant */
      box-shadow: 0 0 5px rgba(220,53,69,0.5);
    }

    .error-message {
      color: #dc3545; /* Red for error, constant */
      font-size: 0.85em;
      margin-top: 5px;
      margin-bottom: 15px;
      display: block;
      min-height: 1.2em;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background-color: var(--button-bg);
      color: var(--button-text);
      border: 1px solid var(--border-color);
      border-radius: 0px;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px var(--box-shadow-color);
      text-transform: uppercase;
    }

    button.reset-btn {
      background-color: var(--reset-btn-bg);
      border-color: var(--reset-btn-hover-bg);
      color: var(--button-text);
    }

    button.reset-btn:hover {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: 0 3px 6px var(--box-shadow-color);
    }

    button.reset-btn:active {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: inset 0 1px 3px var(--box-shadow-color);
    }

    button:hover {
      background-color: var(--button-hover-bg);
      box-shadow: 0 3px 6px var(--box-shadow-color);
    }

    button:active {
      background-color: var(--button-hover-bg);
      box-shadow: inset 0 1px 3px var(--box-shadow-color);
    }

    .output {
      display: none;
    }

    .output p {
      margin: 8px 0;
    }

    /* Popup Styling */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background-color: var(--popup-bg);
      padding: 30px;
      border-radius: 0px;
      border: 2px solid var(--border-color);
      box-shadow: 0 5px 15px var(--box-shadow-color);
      text-align: center;
      max-width: 350px;
      width: 90%;
      position: relative;
      color: var(--popup-text);
    }

    .popup-content h3 {
      color: var(--text-color);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-transform: uppercase;
    }

    .popup-content p {
      font-size: 1.1em;
      margin: 10px 0;
      color: var(--popup-text);
    }

    .popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: var(--popup-close-btn);
    }

    .popup-content .close-btn:hover {
      color: var(--text-color);
    }

    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* History Section Styling */
    .history-section {
        background-color: var(--history-bg);
        border: 2px solid var(--border-color);
        border-radius: 0px;
        padding: 20px;
        max-width: 400px;
        width: 95%;
        margin: 20px auto;
        box-shadow: 0 2px 5px var(--box-shadow-color);
        color: var(--text-color);
    }

    .history-section h3 {
        text-align: center;
        color: var(--text-color);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.4em;
        text-transform: uppercase;
    }

    .history-list {
        list-style-type: none;
        padding: 0;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 0px;
        padding-top: 5px;
        padding-bottom: 5px;
        background-color: var(--history-list-bg);
    }

    .history-list li {
        margin: 5px 0;
        padding: 10px;
        border-radius: 0px;
        border-bottom: 1px solid var(--history-item-border);
        font-size: 0.9em;
        color: var(--history-item-text);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        position: relative;
    }

    .history-list li:last-child {
        border-bottom: none;
    }

    .history-list li strong {
        color: var(--text-color);
    }

    .gold-history-item {
        background-color: var(--gold-item-bg);
        border-left: 5px solid var(--gold-item-border);
    }

    .silver-history-item {
        background-color: var(--silver-item-bg);
        border-left: 5px solid var(--silver-item-border);
    }

    .history-item-main-text {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
        flex-grow: 1;
    }

    .history-item-content {
        flex-grow: 1;
    }

    .history-item-time {
      font-size: 0.8em;
      color: var(--history-item-time);
      margin-top: 5px;
      align-self: flex-end;
      text-align: right;
      width: 100%;
      padding-right: 25px;
      box-sizing: border-box;
    }

    .delete-history-item {
        background: none;
        border: none;
        color: #dc3545; /* Red for delete, constant */
        font-size: 1.2em;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        transition: color 0.2s ease;
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .delete-history-item:hover {
        color: #c82333; /* Darker red on hover */
    }

    .clear-history-btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 15px;
        background-color: var(--reset-btn-bg);
        color: var(--button-text);
        border: 1px solid var(--reset-btn-hover-bg);
        border-radius: 0px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px var(--box-shadow-color);
        text-transform: uppercase;
    }

    .clear-history-btn:hover {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: 0 3px 6px var(--box-shadow-color);
    }

    .clear-history-btn:active {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: inset 0 1px 3px var(--box-shadow-color);
    }

    .price-reference {
        font-size: 0.85em;
        text-align: center;
        margin-top: 15px;
        color: var(--text-color);
    }
    .price-reference a {
        color: var(--link-color);
        text-decoration: none;
        font-weight: 600;
    }
    .price-reference a:hover {
        text-decoration: underline;
    }

    .popup-karat {
        margin-top: 5px;
        font-weight: 600;
        color: var(--link-color); /* Use link color for Karat display */
        font-size: 1em;
    }


    /* Media Queries */
    @media screen and (max-width: 600px) {
      body {
        padding: 10px;
      }

      /* Adjust margin for container to account for fixed button */
      .container {
        margin-top: 50px; /* Give space for the fixed toggle button */
      }

      .calculator {
        padding: 15px;
      }

      h2 {
        font-size: 1.5em;
        margin-bottom: 15px;
      }

      label {
        font-size: 0.9em;
      }

      input {
        padding: 8px;
        font-size: 0.95em;
        margin-bottom: 10px;
      }

      .button-group {
        flex-direction: column;
        gap: 8px;
      }
      button {
        padding: 10px;
        font-size: 1em;
        min-width: unset;
      }

      .popup-content {
        padding: 20px;
      }
      .popup-content h3 {
        font-size: 1.3em;
      }
      .popup-content p {
        font-size: 1em;
      }

      .tab-button {
        font-size: 1em;
        padding: 10px 0;
      }

      .history-section {
        padding: 15px;
      }
      .history-section h3 {
        font-size: 1.3em;
      }
      .history-list li {
        font-size: 0.85em;
      }
      .delete-history-item {
        top: 5px;
        right: 5px;
      }
      .history-item-time {
        padding-right: 0;
      }
    }
  </style>
</head>
<body>

  <button class="theme-toggle" onclick="toggleDarkMode()" id="themeToggleButton">
      ‚òÄÔ∏è
  </button>

  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="openTab(event, 'gold')">‡∏ó‡∏≠‡∏á</button>
      <button class="tab-button" onclick="openTab(event, 'silver')">‡πÄ‡∏á‡∏¥‡∏ô</button>
    </div>

    <div id="gold" class="tab-content active calculator">
      <h2>ü•á‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏áü•á</h2>

      <label for="goldPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
      <input type="number" id="goldPrice" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á">
      <span class="error-message" id="goldPriceError"></span>

      <label for="goldAdditionalPrice">‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£+ü™™ (‡∏ö‡∏≤‡∏ó):</label>
      <input type="number" id="goldAdditionalPrice" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤">
      <span class="error-message" id="goldAdditionalPriceError"></span>

      <label for="goldPercentage">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏≠‡∏á (%):</label>
      <input type="number" id="goldPercentage" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå">
      <span class="error-message" id="goldPercentageError"></span>

      <label for="goldWeight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≠‡∏á (‡∏Å‡∏£‡∏±‡∏°):</label>
      <input type="number" id="goldWeight" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(‡∏Å‡∏£‡∏±‡∏°)">
      <span class="error-message" id="goldWeightError"></span>

      <div class="button-group">
        <button onclick="calculate('gold')">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        <button type="button" class="reset-btn" onclick="resetCalculator('gold')">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>

      <p class="price-reference">
        ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å: <a href="https://thaigold.info/" target="_blank">ThaiGold.info</a>
      </p>
    </div>

    <div id="silver" class="tab-content calculator">
      <h2>ü•à‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ôü•à</h2>

      <label for="silverPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ô ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°):</label>
      <input type="number" id="silverPrice" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 30">
      <span class="error-message" id="silverPriceError"></span>

      <label for="silverPercentage">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏á‡∏¥‡∏ô (%):</label>
      <input type="number" id="silverPercentage" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå ‡πÄ‡∏ä‡πà‡∏ô 99.9 ‡∏´‡∏£‡∏∑‡∏≠ 92.5">
      <span class="error-message" id="silverPercentageError"></span>

      <label for="silverWeight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ô (‡∏Å‡∏£‡∏±‡∏°):</label>
      <input type="number" id="silverWeight" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏ä‡πà‡∏ô 50">
      <span class="error-message" id="silverWeightError"></span>

      <div class="button-group">
        <button onclick="calculate('silver')">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        <button type="button" class="reset-btn" onclick="resetCalculator('silver')">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>
    </div>

    <div class="output" style="display: none;">
      <p id="pricePerGram">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°: - ‡∏ö‡∏≤‡∏ó</p>
      <p id="result">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢: - ‡∏ö‡∏≤‡∏ó</p>
    </div>
  </div>

  <div class="history-section" id="historySection">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
    <ul id="calculationHistoryList" class="history-list">
      </ul>
    <button type="button" class="clear-history-btn" onclick="clearHistory()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
  </div>


  <div class="popup-overlay" id="resultsPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup()">&times;</span>
      <h3 id="popupTitle">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
      <p id="popupPricePerGram">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°: - ‡∏ö‡∏≤‡∏ó</p>
      <p id="popupResult">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢: - ‡∏ö‡∏≤‡∏ó</p>
      <p id="popupKarat" class="popup-karat" style="display: none;"></p> 
    </div>
  </div>

  <script>
    // Array to store history data
    let calculationHistory = [];

    // Function to save history to Local Storage
    function saveHistory() {
        localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
    }

    // Function to load history from Local Storage
    function loadHistory() {
        const storedHistory = localStorage.getItem('calculationHistory');
        if (storedHistory) {
            calculationHistory = JSON.parse(storedHistory);
            renderHistory(); // Render loaded history to the UI
        }
    }

    // Function to render history to the UI
    function renderHistory() {
        const historyList = document.getElementById('calculationHistoryList');
        historyList.innerHTML = ''; // Clear existing list
        calculationHistory.forEach((item, index) => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <div class="history-item-main-text">
                    <span class="history-item-content">${item.text}</span>
                </div>
                <span class="history-item-time">${item.fullDateTime}</span>
                <button class="delete-history-item" onclick="deleteHistoryItem(${index})">&times;</button>
            `;
            if (item.metalType === 'gold') {
                listItem.classList.add('gold-history-item');
            } else if (item.metalType === 'silver') {
                listItem.classList.add('silver-history-item');
            }
            historyList.appendChild(listItem); // Append instead of prepend for correct indexing
        });
    }

    // Function to delete a specific history item
    function deleteHistoryItem(index) {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            calculationHistory.splice(index, 1); // Remove item from array
            saveHistory(); // Save updated array to Local Storage
            renderHistory(); // Re-render the history list
        }
    }

    // Function to convert percentage to Karat
    function convertToKarat(percentage) {
        // 24 Karat is 100% pure gold
        // So, Karat = (Percentage / 100) * 24
        return (percentage / 100) * 24;
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô error message ‡πÅ‡∏•‡∏∞ class ‡∏Ç‡∏≠‡∏á input
    function setInputError(inputId, errorMessage) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');

        if (errorMessage) {
            inputElement.classList.add('is-invalid');
            errorElement.textContent = errorMessage;
        } else {
            inputElement.classList.remove('is-invalid');
            errorElement.textContent = '';
        }
    }

    // Function to switch tabs
    function openTab(evt, tabName) {
      let i, tabcontent, tabbuttons;

      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }

      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
      
      // Clear all errors when switching tabs
      clearAllErrors();
    }

    // Generic calculate function for both gold and silver
    function calculate(metalType) {
      // Clear previous errors first
      clearAllErrors();

      let mainPrice, additionalPriceInput, percentageInput, weightInput;
      let effectivePrice, pricePerGramRaw, pricePerGram, totalPrice = 0;
      let percentage, weight;
      let popupTitleText;
      let karatValue = null; // Initialize karatValue to null
      let isValid = true; // Flag for validation status

      // Get elements for popup
      const popupKaratElement = document.getElementById('popupKarat');
      popupKaratElement.style.display = 'none'; // Hide by default

      // Get values based on metal type
      if (metalType === 'gold') {
        mainPrice = parseFloat(document.getElementById('goldPrice').value);
        additionalPriceInput = document.getElementById('goldAdditionalPrice').value;
        percentageInput = document.getElementById('goldPercentage').value;
        weightInput = document.getElementById('goldWeight').value;
        popupTitleText = '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á';

        // Gold-specific validation
        if (isNaN(mainPrice) || mainPrice <= 0) {
          setInputError('goldPrice', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ß‡∏Å');
          isValid = false;
        } else {
          setInputError('goldPrice', '');
        }

        let additionalPrice = 0;
        if (additionalPriceInput !== "") {
            additionalPrice = parseFloat(additionalPriceInput);
            if (isNaN(additionalPrice) || additionalPrice < 0) {
                setInputError('goldAdditionalPrice', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)');
                isValid = false;
            } else {
                setInputError('goldAdditionalPrice', '');
            }
        } else {
            setInputError('goldAdditionalPrice', ''); // Clear error if empty
        }

        percentage = parseFloat(percentageInput);
        if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
          setInputError('goldPercentage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏≠‡∏á (1-100)');
          isValid = false;
        } else {
          setInputError('goldPercentage', '');
          karatValue = convertToKarat(percentage); // Calculate Karat for gold
        }

        weight = parseFloat(weightInput);
        // Weight is optional, but if entered, it must be valid
        if (weightInput !== "" && (isNaN(weight) || weight <= 0)) {
            setInputError('goldWeight', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ß‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)');
            isValid = false;
        } else {
            setInputError('goldWeight', '');
        }

        effectivePrice = mainPrice + additionalPrice;

      } else if (metalType === 'silver') {
        mainPrice = parseFloat(document.getElementById('silverPrice').value);
        percentageInput = document.getElementById('silverPercentage').value;
        weightInput = document.getElementById('silverWeight').value;
        popupTitleText = '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ô';

        // Silver-specific validation
        if (isNaN(mainPrice) || mainPrice <= 0) {
          setInputError('silverPrice', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ß‡∏Å');
          isValid = false;
        } else {
          setInputError('silverPrice', '');
        }

        percentage = parseFloat(percentageInput);
        if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
          setInputError('silverPercentage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏á‡∏¥‡∏ô (1-100)');
          isValid = false;
        } else {
          setInputError('silverPercentage', '');
        }

        weight = parseFloat(weightInput);
        // Weight is optional, but if entered, it must be valid
        if (weightInput !== "" && (isNaN(weight) || weight <= 0)) {
            setInputError('silverWeight', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏£‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ß‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)');
            isValid = false;
        } else {
            setInputError('silverWeight', '');
        }
        
        effectivePrice = mainPrice; // No additional price for silver
      }

      // If any validation failed, stop calculation
      if (!isValid) {
        return;
      }

      // Perform calculation
      if (metalType === 'gold') {
        // 1 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á = 15.244 ‡∏Å‡∏£‡∏±‡∏°
        pricePerGramRaw = (effectivePrice / 15.244) * (percentage / 100);
        pricePerGram = Math.floor(pricePerGramRaw); // Gold still floors to whole number
      } else if (metalType === 'silver') {
        // Silver calculation: current price per gram * percentage
        pricePerGramRaw = effectivePrice * (percentage / 100);
        pricePerGram = parseFloat(pricePerGramRaw.toFixed(1)); // Round to 1 decimal place for silver
      }
      
      // Calculate total price if weight is provided
      if (weightInput !== "" && !isNaN(weight) && weight > 0) {
        if (metalType === 'silver') {
            totalPrice = (pricePerGram * weight).toFixed(1); // Keep 1 decimal for total silver price
        } else {
            totalPrice = pricePerGram * weight; // Gold remains whole number
        }
      } else {
          totalPrice = 0; // Ensure total price is 0 if no valid weight for display
      }


      // Display results in popup
      document.getElementById('popupTitle').textContent = popupTitleText;
      document.getElementById('popupPricePerGram').textContent =
        `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°: ${pricePerGram.toLocaleString(undefined, { minimumFractionDigits: metalType === 'silver' ? 1 : 0, maximumFractionDigits: metalType === 'silver' ? 1 : 0 })} ‡∏ö‡∏≤‡∏ó`;

      document.getElementById('popupResult').textContent =
        totalPrice > 0 ? `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢: ${parseFloat(totalPrice).toLocaleString(undefined, { minimumFractionDigits: metalType === 'silver' ? 1 : 0, maximumFractionDigits: metalType === 'silver' ? 1 : 0 })} ‡∏ö‡∏≤‡∏ó` : `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢: - ‡∏ö‡∏≤‡∏ó (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)`;

      // Display Karat for Gold
      if (metalType === 'gold' && karatValue !== null) {
          popupKaratElement.textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${karatValue.toFixed(1)}K`; // Show Karat value
          popupKaratElement.style.display = 'block';
      } else {
          popupKaratElement.style.display = 'none';
      }

      // Show the popup
      document.getElementById('resultsPopup').style.display = 'flex';

      // Auto-save logic: Only save if weight is entered and valid
      if (weightInput !== "" && !isNaN(weight) && weight > 0) {
          let historyEntryText = "";
          // Get full date and time for history in a readable Thai format
          const fullDateTime = new Date().toLocaleString('th-TH', { 
              year: 'numeric', 
              month: 'numeric', 
              day: 'numeric', 
              hour: '2-digit', 
              minute: '2-digit',
              hour12: false // Use 24-hour format
          });

          if (metalType === 'gold') {
              let karatDisplay = "";
              if (karatValue !== null) {
                  karatDisplay = ` (${karatValue.toFixed(1)}K)`;
              }
              historyEntryText = `‡∏ó‡∏≠‡∏á ${percentage.toLocaleString()}%${karatDisplay} - ${weight.toLocaleString()}g: ${totalPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó (${pricePerGram.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)`;
              const actualAdditionalPrice = additionalPriceInput === "" ? 0 : parseFloat(additionalPriceInput);
              if (!isNaN(actualAdditionalPrice) && actualAdditionalPrice > 0) {
                  historyEntryText += ` (+${actualAdditionalPrice.toLocaleString()}‡∏ö.)`;
              }
          } else if (metalType === 'silver') {
              historyEntryText = `‡πÄ‡∏á‡∏¥‡∏ô ${percentage.toLocaleString()}% - ${weight.toLocaleString()}g: ${parseFloat(totalPrice).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })} ‡∏ö‡∏≤‡∏ó (${pricePerGram.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)`;
          }
          
          // Add to calculationHistory array
          calculationHistory.unshift({ // Add to the beginning of the array
              text: historyEntryText,
              fullDateTime: fullDateTime, // Save full date and time
              metalType: metalType
          });
          saveHistory(); // Save to local storage
          renderHistory(); // Re-render the UI
      }
    }

    function closePopup() {
      document.getElementById('resultsPopup').style.display = 'none';
    }

    // Function to clear all calculation history
    function clearHistory() {
        if (confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏≠‡∏à‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
            calculationHistory = []; // Empty the array
            saveHistory(); // Save empty array to Local Storage
            renderHistory(); // Clear the UI list
        }
    }
    
    // Generic reset function for both gold and silver
    function resetCalculator(metalType) {
        if (metalType === 'gold') {
            document.getElementById('goldPrice').value = '';
            document.getElementById('goldAdditionalPrice').value = '';
            document.getElementById('goldPercentage').value = '';
            document.getElementById('goldWeight').value = '';
        } else if (metalType === 'silver') {
            document.getElementById('silverPrice').value = '';
            document.getElementById('silverPercentage').value = '';
            document.getElementById('silverWeight').value = '';
        }
        clearAllErrors(); // Clear errors after reset
    }

    // Function to clear all validation errors across both tabs
    function clearAllErrors() {
        const errorSpans = document.querySelectorAll('.error-message');
        errorSpans.forEach(span => {
            span.textContent = '';
        });
        const invalidInputs = document.querySelectorAll('input.is-invalid');
        invalidInputs.forEach(input => {
            input.classList.remove('is-invalid');
        });
    }

    // --- Dark Mode / Light Mode Functionality ---
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode'); // Toggle the 'dark-mode' class
        
        // Save user's preference to localStorage
        if (body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            document.getElementById('themeToggleButton').textContent = 'üåô'; // Change icon to moon
        } else {
            localStorage.setItem('theme', 'light');
            document.getElementById('themeToggleButton').textContent = '‚òÄÔ∏è'; // Change icon to sun
        }
    }

    // Apply saved theme on page load
    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('themeToggleButton').textContent = 'üåô';
        } else {
            // Default to light mode if no preference or preference is 'light'
            document.body.classList.remove('dark-mode');
            document.getElementById('themeToggleButton').textContent = '‚òÄÔ∏è';
        }
    }


    // Set initial active tab and load history on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('gold').style.display = 'block';
      clearAllErrors(); // Clear any potential errors on page load
      loadHistory(); // Load history when the page loads
      applySavedTheme(); // Apply saved theme on load
    });
  </script>

</body>
</html>
