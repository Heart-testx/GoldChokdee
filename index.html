<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ! (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏ä‡∏£‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°)</title>
    <style>
        :root {
            --gap-size: 15px; /* Define a CSS variable for gap */
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            flex-direction: column;
            padding: 20px 10px; /* ‡∏•‡∏î padding ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Top Controls Area */
        .top-controls-container {
            width: 95%; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            max-width: 450px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° max-width ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            background-color: #fff;
            padding: 15px 20px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .top-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .currency-display {
            font-size: 1.1em; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px; /* ‡∏•‡∏î gap */
        }
        .diamond-icon {
            width: 22px; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            height: 22px;
            vertical-align: middle;
        }
        .count-display {
            font-size: 1em; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            color: #333;
            font-weight: bold;
        }
        .reset-button, .shop-button, .inventory-button, .minigame-button { /* Added minigame-button */
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 20px;
            font-size: 0.85em; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏î */
        }
        .reset-button { background-color: #f44336; }
        .reset-button:hover { background-color: #da190b; }
        .shop-button { background-color: #17a2b8; }
        .shop-button:hover { background-color: #138496; }
        .inventory-button { background-color: #ff9800; } /* ‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á */
        .inventory-button:hover { background-color: #e68900; }
        .minigame-button { background-color: #673ab7; } /* New color for minigame button */
        .minigame-button:hover { background-color: #512da8; }

        /* Container for multiple cards */
        #resultsContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--gap-size); /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ CSS */
            width: 100%; /* ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
            max-width: 1200px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î max-width ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 5 ‡πÉ‡∏ö */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .card-container {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            overflow: hidden;
            margin-bottom: 0; /* Remove extra margin-bottom if present */
        }

        /* Responsive adjustments for card-container */
        /* Default for wide screens: 5 cards per row */
        .card-container {
            width: calc(20% - (var(--gap-size) * 4 / 5)); /* 5 cards, accounting for 4 gaps */
            max-width: 220px; /* Max individual card width to prevent too wide */
            min-width: 160px; /* Min width for mobile portrait */
        }

        @media (max-width: 1200px) { /* 4 cards per row */
            .card-container {
                width: calc(25% - (var(--gap-size) * 3 / 4));
                max-width: 250px;
            }
        }
        @media (max-width: 900px) { /* 3 cards per row */
            .card-container {
                width: calc(33.33% - (var(--gap-size) * 2 / 3));
                max-width: 280px;
            }
        }
        @media (max-width: 600px) { /* 2 cards per row */
            .card-container {
                width: calc(50% - (var(--gap-size) * 1 / 2));
                max-width: 350px;
            }
        }
        @media (max-width: 400px) { /* 1 card per row */
            .card-container {
                width: calc(100% - (var(--gap-size) * 0)); /* Full width, no gaps between */
                max-width: 400px;
            }
        }


        /* Border Glow Effect for Rarity */
        .card-container::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 20px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        .card-container.rarity-lr::before { /* New LR Glow */
            background: linear-gradient(45deg, #e74c3c, #f39c12, #f1c40f, #2ecc71, #3498db, #9b59b6, #e74c3c);
            background-size: 600% 600%;
            animation: glowing 6s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-ur::before {
            background: linear-gradient(45deg, #ffcc00, #ff6600, #ff00cc, #6600ff);
            background-size: 400% 400%;
            animation: glowing 4s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-ssr::before {
            background: linear-gradient(45deg, #00ffff, #00bfff, #8a2be2, #ff1493);
            background-size: 400% 400%;
            animation: glowing 3s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-sr::before {
            background: linear-gradient(45deg, #00ff00, #008000);
            background-size: 400% 400%;
            animation: glowing 2s ease-in-out infinite;
            opacity: 1;
        }
        .card-container.rarity-n::before {
            opacity: 0;
        }

        .card-image {
            width: 80px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid #66bb6a; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î border */
            animation: popIn 0.5s ease-out;
        }
        .card-name {
            font-size: 1.2em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠ */
            color: #333;
            margin-bottom: 5px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-skill {
            font-size: 0.8em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏Å‡∏¥‡∏• */
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
            font-style: italic;
            min-height: 3.5em; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î min-height ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word; /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÜ ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ */
        }
        .card-stats {
            font-size: 0.75em;
            color: #666;
            margin-top: 5px;
            line-height: 1.3;
        }
        .card-stats span {
            display: block;
        }
        .rarity-display {
            font-size: 1em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏£‡∏ó */
            font-weight: bold;
            margin-bottom: 8px;
            padding: 2px 7px;
            border-radius: 10px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î border-radius */
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Rarity Specific Colors */
        .rarity-display.lr { background-color: #FF1493; color: #FFFFFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* New LR Color */
        .rarity-display.ur { background-color: #FFD700; color: #8B0000; text-shadow: 1px 1px 2px rgba(255,255,255,0.7); }
        .rarity-display.ssr { background-color: #8A2BE2; color: #FFFFFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .rarity-display.sr { background-color: #00FF7F; color: #006400; text-shadow: 1px 1px 2px rgba(255,255,255,0.7); }
        .rarity-display.n { background-color: #C0C0C0; color: #555555; }


        .random-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 30px;
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        .random-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        .random-button:active {
            transform: translateY(0);
        }

        .random-button.x10 {
            background-color: #007bff;
        }
        .random-button.x10:hover {
            background-color: #0056b3;
        }
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .error-message {
            color: #d9534f;
            margin-top: 10px;
            font-weight: bold;
            display: none;
            text-align: center;
        }


        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 10px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡πÉ‡∏´‡πâ popup ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            box-sizing: border-box;
        }
        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .popup-content {
            background-color: #fff;
            padding: 20px 30px; /* ‡∏•‡∏î padding */
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 95%; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° max-width ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            max-height: 90vh; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
            overflow-y: auto; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° scrollbar ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô */
        }
        .popup-overlay.active .popup-content {
            transform: scale(1);
        }
        .popup-content h2 {
            color: #333; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ popup */
            font-size: 2em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î */
            margin-bottom: 15px;
            text-shadow: none; /* ‡πÑ‡∏°‡πà‡∏°‡∏µ shadow */
        }
        .popup-content p {
            font-size: 1.1em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î */
            color: #333;
            margin-bottom: 20px;
        }
        .popup-close-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 20px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            border-radius: 25px;
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 15px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
        }
        .popup-close-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        /* Shop Popup Styles */
        #shopPopupOverlay {
            z-index: 1010;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 15px; /* ‡∏õ‡∏£‡∏±‡∏ö padding */
            margin-bottom: 8px; /* ‡∏•‡∏î margin-bottom */
            gap: 10px;
            flex-wrap: wrap; /* ‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
        }
        .shop-item-info {
            text-align: left;
            flex-grow: 1; /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ */
        }
        .shop-item-name {
            font-weight: bold;
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
            color: #555;
        }
        .shop-item-price {
            display: flex;
            align-items: center;
            gap: 4px; /* ‡∏•‡∏î gap */
            font-size: 1em; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */
            color: #007bff;
            font-weight: bold;
        }
        .shop-item-real-price {
            font-size: 0.9em;
            color: #777;
            margin-left: 10px;
            white-space: nowrap;
        }
        .buy-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }
        .buy-button:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }
        .buy-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Inventory Popup Styles */
        #inventoryPopupContent .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            gap: 10px;
            margin-top: 20px;
            max-height: 50vh; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á grid */
            overflow-y: auto; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° scrollbar */
        }

        .inventory-item {
            background-color: #eceff1;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .inventory-item img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #ccc;
        }
        .inventory-item .name {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .inventory-item .count {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: #007bff;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .inventory-item .rarity-label {
            font-size: 0.7em;
            font-weight: bold;
            padding: 1px 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        /* New LR Rarity Label */
        .inventory-item .rarity-label.lr { background-color: #FF1493; color: #FFFFFF; }
        .inventory-item .rarity-label.ur { background-color: #FFD700; color: #8B0000; }
        .inventory-item .rarity-label.ssr { background-color: #8A2BE2; color: #FFFFFF; }
        .inventory-item .rarity-label.sr { background-color: #00FF7F; color: #006400; }
        .inventory-item .rarity-label.n { background-color: #C0C0C0; color: #555555; }
        .inventory-item .stats {
            font-size: 0.7em;
            color: #666;
            text-align: left;
            margin-top: 5px;
            line-height: 1.2;
            width: 100%;
        }


        /* Exchange Section in Shop Popup */
        .exchange-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .exchange-section h3 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 15px;
        }
        .exchange-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .exchange-item-info {
            text-align: left;
            flex-grow: 1;
        }
        .exchange-cost {
            font-size: 1em;
            color: #d9534f;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .exchange-cost span {
            font-size: 0.9em;
            color: #555;
            font-weight: normal;
        }
        .exchange-button {
            background-color: #5cb85c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }
        .exchange-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .exchange-button:hover:not(:disabled) {
            background-color: #4cae4c;
            transform: translateY(-1px);
        }

        /* Probability Boost Item */
        .probability-boost-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .probability-boost-section h3 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 15px;
        }
        .boost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .boost-item-info {
            text-align: left;
            flex-grow: 1;
        }
        .boost-item-name {
            font-weight: bold;
            font-size: 1em;
            color: #555;
        }
        .boost-item-price {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 1em;
            color: #dc3545; /* Red color for boost price */
            font-weight: bold;
        }
        .boost-item-duration {
            font-size: 0.8em;
            color: #777;
            margin-top: 5px;
        }
        .buy-boost-button {
            background-color: #6f42c1; /* Purple color for boost button */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }
        .buy-boost-button:hover {
            background-color: #5a359d;
            transform: translateY(-1px);
        }
        .buy-boost-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Mini-Game Popup Styles */
        #miniGamePopupOverlay {
            z-index: 1020;
        }
        #miniGamePopupContent .mini-game-section {
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            background-color: #fdfdfd;
        }
        #miniGamePopupContent .mini-game-section h3 {
            font-size: 1.3em;
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 10px;
        }
        #miniGamePopupContent .mini-game-rewards {
            margin-top: 10px;
            font-size: 0.95em;
            color: #555;
        }
        #miniGamePopupContent .mini-game-cost {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1em;
            color: #d9534f;
            font-weight: bold;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        #miniGamePopupContent .mini-game-cost span {
            font-weight: normal;
            color: #333;
        }
        #miniGamePopupContent .mini-game-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
        }
        #miniGamePopupContent .mini-game-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        #miniGamePopupContent .mini-game-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #miniGamePopupContent .mini-game-status {
            margin-top: 15px;
            font-size: 0.9em;
            color: #007bff;
            font-weight: bold;
        }


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes glowing {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>
    <div class="top-controls-container">
        <div class="top-controls-row">
            <div class="currency-display">
                <img src="https://i.ibb.co/Yn7pbdq/21-diamond-png-image.png" alt="Diamond" class="diamond-icon">
                ‡πÄ‡∏û‡∏ä‡∏£: <span id="diamondCount">0</span>
            </div>
            <button class="shop-button" onclick="openShop()">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div class="top-controls-row">
            <div class="count-display">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°: <span id="rollCount">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            <button class="inventory-button" onclick="openInventory()">‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
        </div>
        <div class="top-controls-row">
            <div class="count-display">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏ä‡∏£: <span id="topUpCount">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            <button class="minigame-button" onclick="openMiniGame()">‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°</button> </div>
        <div class="top-controls-row">
            <div></div> <button class="reset-button" onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <div class="button-group">
        <button class="random-button" onclick="handleRoll(1)">‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ 100 üíé)</button>
        <button class="random-button x10" onclick="handleRoll(10)">‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ 900 üíé)</button>
    </div>
    <div id="errorMessage" class="error-message"></div>

    <div id="resultsContainer">
        <div id="initialCard" class="card-container">
            <h1>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠...</h1>
            <div id="rarityDisplay" class="rarity-display"></div>
            <img id="friendImage" class="card-image" src="https://via.placeholder.com/150/EEEEEE/888888?text=‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" alt="‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
            <div id="friendName" class="card-name">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°!</div>
            <div id="friendSkill" class="card-skill">‡∏à‡∏∞‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡∏™‡∏∏‡∏î‡∏Æ‡∏≤!</div>
            <div id="friendStats" class="card-stats"></div>
        </div>
    </div>

    <div id="urPopupOverlay" class="popup-overlay">
        <div class="popup-content">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ UR!</h2>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Ultra Rare!</p>
            <button class="popup-close-button" onclick="closePopup('urPopupOverlay')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="lrPopupOverlay" class="popup-overlay"> <div class="popup-content">
            <h2>‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ LR!</h2>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Legendary Rare!</p>
            <button class="popup-close-button" onclick="closePopup('lrPopupOverlay')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="shopPopupOverlay" class="popup-overlay">
        <div id="shopPopupContent" class="popup-content">
            <h2>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏ä‡∏£</h2>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-name">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
                    <div class="shop-item-price">
                        <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                        1,000 ‡πÄ‡∏û‡∏ä‡∏£ <span class="shop-item-real-price">(‡∏£‡∏≤‡∏Ñ‡∏≤: 99 ‡∏ö‡∏≤‡∏ó)</span>
                    </div>
                </div>
                <button class="buy-button" onclick="buyDiamonds(1000, 99)">‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-name">‡πÅ‡∏û‡πá‡∏Å‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°</div>
                    <div class="shop-item-price">
                        <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                        5,000 ‡πÄ‡∏û‡∏ä‡∏£ <span class="shop-item-real-price">(‡∏£‡∏≤‡∏Ñ‡∏≤: 449 ‡∏ö‡∏≤‡∏ó)</span>
                    </div>
                </div>
                <button class="buy-button" onclick="buyDiamonds(5000, 449)">‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-name">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ</div>
                    <div class="shop-item-price">
                        <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                        10,000 ‡πÄ‡∏û‡∏ä‡∏£ <span class="shop-item-real-price">(‡∏£‡∏≤‡∏Ñ‡∏≤: 899 ‡∏ö‡∏≤‡∏ó)</span>
                    </div>
                </div>
                <button class="buy-button" onclick="buyDiamonds(10000, 899)">‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-name">‡πÅ‡∏û‡πá‡∏Å‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ</div>
                    <div class="shop-item-price">
                        <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                        50,000 ‡πÄ‡∏û‡∏ä‡∏£ <span class="shop-item-real-price">(‡∏£‡∏≤‡∏Ñ‡∏≤: 10,000 ‡∏ö‡∏≤‡∏ó)</span>
                    </div>
                </div>
                <button class="buy-button" onclick="buyDiamonds(50000, 10000)">‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-name">‡πÅ‡∏û‡πá‡∏Å‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥</div>
                    <div class="shop-item-price">
                        <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                        100,000 ‡πÄ‡∏û‡∏ä‡∏£ <span class="shop-item-real-price">(‡∏£‡∏≤‡∏Ñ‡∏≤: 15,000 ‡∏ö‡∏≤‡∏ó)</span>
                    </div>
                </div>
                <button class="buy-button" onclick="buyDiamonds(100000, 15000)">‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>

            <div class="exchange-section">
                <h3>‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</h3>
                <div class="exchange-item">
                    <div class="exchange-item-info">
                        <div class="shop-item-name">‡πÅ‡∏•‡∏Å N Cards ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</div>
                        <div class="exchange-cost">‡πÉ‡∏ä‡πâ <span id="nCardCount">0</span>/500 ‡πÉ‡∏ö N <span>‡πÑ‡∏î‡πâ 100 üíé</span></div>
                    </div>
                    <button class="exchange-button" id="exchangeNBtn" onclick="exchangeCards('N', 500, 100)" disabled>‡πÅ‡∏•‡∏Å</button>
                </div>
                <div class="exchange-item">
                    <div class="exchange-item-info">
                        <div class="shop-item-name">‡πÅ‡∏•‡∏Å SR Cards ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</div>
                        <div class="exchange-cost">‡πÉ‡∏ä‡πâ <span id="srCardCount">0</span>/300 ‡πÉ‡∏ö SR <span>‡πÑ‡∏î‡πâ 100 üíé</span></div>
                    </div>
                    <button class="exchange-button" id="exchangeSRBtn" onclick="exchangeCards('SR', 300, 100)" disabled>‡πÅ‡∏•‡∏Å</button>
                </div>
                <div class="exchange-item">
                    <div class="exchange-item-info">
                        <div class="shop-item-name">‡πÅ‡∏•‡∏Å SSR Cards ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</div>
                        <div class="exchange-cost">‡πÉ‡∏ä‡πâ <span id="ssrCardCount">0</span>/150 ‡πÉ‡∏ö SSR <span>‡πÑ‡∏î‡πâ 100 üíé</span></div>
                    </div>
                    <button class="exchange-button" id="exchangeSSRBtn" onclick="exchangeCards('SSR', 150, 100)" disabled>‡πÅ‡∏•‡∏Å</button>
                </div>
                <div class="exchange-item">
                    <div class="exchange-item-info">
                        <div class="shop-item-name">‡πÅ‡∏•‡∏Å UR Cards ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</div>
                        <div class="exchange-cost">‡πÉ‡∏ä‡πâ <span id="urCardCount">0</span>/1 ‡πÉ‡∏ö UR <span>‡πÑ‡∏î‡πâ 5000 üíé</span></div>
                    </div>
                    <button class="exchange-button" id="exchangeURBtn" onclick="exchangeCards('UR', 1, 5000)" disabled>‡πÅ‡∏•‡∏Å</button>
                </div>
                <div class="exchange-item"> <div class="exchange-item-info">
                        <div class="shop-item-name">‡πÅ‡∏•‡∏Å LR Cards ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£</div>
                        <div class="exchange-cost">‡πÉ‡∏ä‡πâ <span id="lrCardCount">0</span>/1 ‡πÉ‡∏ö LR <span>‡πÑ‡∏î‡πâ 15000 üíé</span></div>
                    </div>
                    <button class="exchange-button" id="exchangeLRBtn" onclick="exchangeCards('LR', 1, 15000)" disabled>‡πÅ‡∏•‡∏Å</button>
                </div>
            </div>

            <div class="probability-boost-section">
                <h3>‡∏ö‡∏π‡∏™‡∏ï‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</h3>
                <div class="boost-item">
                    <div class="boost-item-info">
                        <div class="boost-item-name">‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ UR x2</div>
                        <div class="boost-item-price">
                            <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                            10,000 ‡πÄ‡∏û‡∏ä‡∏£
                        </div>
                        <div class="boost-item-duration" id="urBoostStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                    </div>
                    <button class="buy-boost-button" id="buyURBoostBtn" onclick="buyProbabilityBoost(10000, 'UR', 2, 300000)">‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>
                <div class="boost-item"> <div class="boost-item-info">
                        <div class="boost-item-name">‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ LR x2</div>
                        <div class="boost-item-price">
                            <img src="https://i.ibb.co/hZ2v6Vj/diamond-icon.png" alt="Diamond" class="diamond-icon">
                            50,000 ‡πÄ‡∏û‡∏ä‡∏£
                        </div>
                        <div class="boost-item-duration" id="lrBoostStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                    </div>
                    <button class="buy-boost-button" id="buyLRBoostBtn" onclick="buyProbabilityBoost(50000, 'LR', 2, 300000)">‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>
            </div>

            <button class="popup-close-button" onclick="closeShop()">‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
    </div>

    <div id="inventoryPopupOverlay" class="popup-overlay">
        <div id="inventoryPopupContent" class="popup-content">
            <h2>‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î</h2>
            <div class="inventory-grid" id="inventoryGrid">
                </div>
            <button class="popup-close-button" onclick="closePopup('inventoryPopupOverlay')">‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏á</button>
        </div>
    </div>

    <div id="miniGamePopupOverlay" class="popup-overlay">
        <div id="miniGamePopupContent" class="popup-content">
            <h2>‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°: ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢!</h2>
            <p>‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•! ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î.</p>

            <div class="mini-game-section">
                <h3>1. ‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ (Easy Expedition)</h3>
                <p>‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô N 5 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SR 1 ‡πÉ‡∏ö</p>
                <div class="mini-game-cost">
                    ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î N: <span id="miniGame1NCount">0</span>/5
                    ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡πå‡∏î SR: <span id="miniGame1SRCount">0</span>/1
                </div>
                <div class="mini-game-rewards">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: 50 üíé, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 5% ‡πÑ‡∏î‡πâ SSR Card</div>
                <button class="mini-game-button" id="startExpedition1Btn" onclick="startExpedition('easy')" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ (1 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
                <div class="mini-game-status" id="easyExpeditionStatus"></div>
            </div>

            <div class="mini-game-section">
                <h3>2. ‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (Challenging Expedition)</h3>
                <p>‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô SSR 3 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ UR 1 ‡πÉ‡∏ö</p>
                <div class="mini-game-cost">
                    ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î SSR: <span id="miniGame2SSRCount">0</span>/3
                    ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡πå‡∏î UR: <span id="miniGame2URCount">0</span>/1
                </div>
                <div class="mini-game-rewards">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: 500 üíé, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 1% ‡πÑ‡∏î‡πâ UR Card, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 0.1% ‡πÑ‡∏î‡πâ LR Card</div>
                <button class="mini-game-button" id="startExpedition2Btn" onclick="startExpedition('challenging')" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (5 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
                <div class="mini-game-status" id="challengingExpeditionStatus"></div>
            </div>

            <div class="mini-game-section">
                <h3>3. ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô (Ancient Ruins Exploration)</h3>
                <p>‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Stamina ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 200 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (UR 1 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SSR 5 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SR 10 ‡πÉ‡∏ö)</p>
                <div class="mini-game-cost">
                    Stamina ‡∏£‡∏ß‡∏°: <span id="miniGame3StaminaCount">0</span>/200
                </div>
                <div class="mini-game-rewards">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: 1000 üíé, ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 2% ‡πÑ‡∏î‡πâ LR Card</div>
                <button class="mini-game-button" id="startExpedition3Btn" onclick="startExpedition('ancient_ruins')" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à (10 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
                <div class="mini-game-status" id="ancientRuinsExpeditionStatus"></div>
            </div>

            <div class="mini-game-section">
                <h3>4. ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ (Summit Conquest)</h3>
                <p>‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Attack ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 300 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (LR 1 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ UR 3 ‡πÉ‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ SSR 10 ‡πÉ‡∏ö)</p>
                <div class="mini-game-cost">
                    Attack ‡∏£‡∏ß‡∏°: <span id="miniGame4AttackCount">0</span>/300
                </div>
                <div class="mini-game-rewards">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: 5000 üíé, ‡∏Å‡∏≤‡∏£‡πå‡∏î LR 100%</div>
                <button class="mini-game-button" id="startExpedition4Btn" onclick="startExpedition('summit_conquest')" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏ä‡∏¥‡∏ï (30 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
                <div class="mini-game-status" id="summitConquestExpeditionStatus"></div>
            </div>

            <div class="mini-game-section">
                <h3>5. ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ (Buddy Rescue Operation)</h3>
                <p>‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Defense ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 250 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞ N Card 50 ‡πÉ‡∏ö</p>
                <div class="mini-game-cost">
                    Defense ‡∏£‡∏ß‡∏°: <span id="miniGame5DefenseCount">0</span>/250, N Card: <span id="miniGame5NCount">0</span>/50
                </div>
                <div class="mini-game-rewards">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: 2500 üíé, ‡∏Å‡∏≤‡∏£‡πå‡∏î UR 100% (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)</div>
                <button class="mini-game-button" id="startExpedition5Btn" onclick="startExpedition('buddy_rescue')" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ (15 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
                <div class="mini-game-status" id="buddyRescueExpeditionStatus"></div>
            </div>

            <button class="popup-close-button" onclick="closePopup('miniGamePopupOverlay')">‡∏õ‡∏¥‡∏î‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°</button>
        </div>
    </div>


    <script>
        let rollCounter = 0;
        let diamondCount = 1000;
        let topUpCount = 0;
        let inventory = {}; // { "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô": { friendData: {}, count: 1 } }
        let rollsSinceLastUR = 0;
        let rollsSinceLastLR = 0; // New: Pity for LR
        const PITY_ROLLS_FOR_UR = 1000;
        const PITY_ROLLS_FOR_LR = 5000; // New: Pity for LR

        const COST_PER_ROLL = 100;
        const COST_TEN_ROLLS = 900;

        // Probability Boost variables
        let urBoostActive = false;
        let urBoostEndTime = 0;
        let lrBoostActive = false; // New: LR Boost
        let lrBoostEndTime = 0; // New: LR Boost

        const friendsData = [
            // LR (Legendary Rare) - 0.001% chance
            {
                rarity: "LR",
                name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏à‡∏≠‡∏°‡∏û‡∏•‡∏±‡∏á",
                image: "https://i.ibb.co/L51cFLQ/superduck.jpg", // Replace with a unique LR image
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏´‡πà‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•' - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏ä‡∏£‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏¥‡∏ï‡∏¥‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏±‡∏ö‡∏•‡πâ‡∏≤‡∏ô!",
                stats: { hp: 2000000, stamina: 1000000, attack: 1500000, defense: 1200000 }
            },
            // UR (Ultra Rare) - 0.04% chance
            {
                rarity: "UR",
                name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä",
                image: "https://i.ibb.co/mrHp5yqZ/IMG-20250320-184722-323.webp",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å' - ‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ô‡πà‡∏≤‡∏ó‡∏±‡∏ä‡∏ô‡πà‡∏≤‡∏à‡∏∏‡πä‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏•‡∏á‡πÑ‡∏´‡∏•",
                stats: { hp: 150, stamina: 80, attack: 120, defense: 100 }
            },
            {
                rarity: "UR",
                name: "‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡∏ß‡∏ô‡πâ‡∏≠",
                image: "https://i.ibb.co/L51cFLQ/superduck.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô' - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏°‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠",
                stats: { hp: 140, stamina: 90, attack: 110, defense: 95 }
            },
            {
                rarity: "UR",
                name: "‡∏ï‡πâ‡∏≤‡∏ü‡∏±‡∏ô‡πÄ‡∏´‡∏¢‡∏¥‡∏ô",
                image: "https://i.ibb.co/L51cFLQ/superduck.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ü‡∏±‡∏ô‡πÄ‡∏â‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤' - ‡∏™‡∏Å‡∏¥‡∏•‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏â‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ß‡∏Å‡∏°‡∏∂‡∏á",
                stats: { hp: 160, stamina: 70, attack: 130, defense: 110 }
            },
            {
                rarity: "UR",
                name: "‡∏≠‡∏±‡∏á‡∏Å‡∏≠‡∏£‡πå‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä",
                image: "https://i.ibb.co/L51cFLQ/superduck.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏±‡πà‡∏á' - ‡∏£‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏¢‡∏±‡πà‡∏ß‡∏¢‡∏ß‡∏ô‡∏™‡∏≤‡∏ß‡πÜ!",
                stats: { hp: 130, stamina: 110, attack: 100, defense: 80 }
            },
            // SSR (Super Super Rare) - 5% chance
            {
                rarity: "SSR",
                name: "‡∏ã‡∏±‡∏á‡∏Å‡∏∏‡πä‡∏Ñ‡∏ô‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì",
                image: "https://i.ibb.co/y4p8R0c/ajarnyord.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÄ‡∏´‡∏á‡∏≤‡∏à‡∏±‡∏ö‡πÉ‡∏à' - ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏î ‡πÄ‡∏Ç‡∏≤‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏≠‡πÉ‡∏à‡πÄ‡∏•‡∏µ‡∏¢‡πÑ‡∏≠‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á",
                stats: { hp: 100, stamina: 60, attack: 80, defense: 70 }
            },
            {
                rarity: "SSR",
                name: "‡∏ï‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏™‡πà‡∏á‡∏°‡∏≤",
                image: "https://i.ibb.co/7Jx5YRkg/tar.png",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô' - ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≤‡∏û‡∏π‡∏î ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
                stats: { hp: 90, stamina: 70, attack: 90, defense: 60 }
            },
            // SR (Super Rare) - 20% chance
            {
                rarity: "SR",
                name: "‡∏£‡∏ñ‡∏ö‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á",
                image: "https://i.ibb.co/hK00gKj/Somchai.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏à‡∏∞‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà' - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏•‡∏ö‡∏´‡∏ô‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î‡πÑ‡∏î‡πâ",
                stats: { hp: 70, stamina: 50, attack: 40, defense: 50 }
            },
            {
                rarity: "SR",
                name: "‡∏£‡∏ñ‡∏ï‡∏¥‡∏°",
                image: "https://i.ibb.co/tpV4nKMD/IMG-7130-00-10-17-39-Still001.png",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ó‡∏∞‡∏•‡∏ß‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á' - ‡πÑ‡∏≠‡∏Ñ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡∏ä‡∏≠‡∏ö‡∏ó‡∏∞‡∏•‡∏∏‡∏ó‡∏∞‡∏•‡∏ß‡∏á‡∏´‡∏°‡∏±‡∏î‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô",
                stats: { hp: 60, stamina: 40, attack: 50, defense: 40 }
            },
            {
                rarity: "SR",
                name: "‡∏î‡∏≠‡∏î‡πÅ‡∏£‡πâ‡∏ô",
                image: "https://i.ibb.co/j3gQW6Q/Pongpat.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡πÅ‡∏ú‡∏î‡πÄ‡∏ú‡∏≤' - ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏î‡πÅ‡∏£‡πâ‡∏ô‡∏°‡∏±‡∏ô‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏£‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πÜ‡∏≠‡∏¢‡πà‡∏≤‡πÑ‡∏õ‡∏¢‡∏∑‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏î‡∏≠‡∏î",
                stats: { hp: 80, stamina: 30, attack: 60, defense: 30 }
            },
            // N (Normal) - Adjusted to 74.959%
            {
                rarity: "N",
                name: "‡∏õ‡∏≤‡∏Å‡∏î‡∏≥",
                image: "https://i.ibb.co/mrHp5yqZ/IMG-20250320-184722-323.webp",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏à‡∏∏‡πä‡∏ö‡πÜ' - ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏à‡∏∞‡∏£‡∏≤‡∏ö‡∏£‡∏∑‡πà‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏∏‡πà‡∏ô‡∏ß‡∏≤‡∏¢",
                stats: { hp: 30, stamina: 20, attack: 15, defense: 20 }
            },
            {
                rarity: "N",
                name: "‡∏≠‡∏µ‡∏Å‡∏•‡∏∞‡∏ö‡πà",
                image: "https://i.ibb.co/r20vK355/IMG-20250703-202739.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏à‡∏≠‡∏°‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏Å‡∏û‡∏π‡∏î‡∏ú‡∏¥‡∏î' - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¥‡∏à‡∏â‡∏≤‡πÅ‡∏Å‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ù‡∏π‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏ú‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î",
                stats: { hp: 25, stamina: 25, attack: 10, defense: 25 }
            },
            {
                rarity: "N",
                name: "‡∏Ñ‡∏¥‡∏°",
                image: "https://i.ibb.co/spmkgvnS/1000008128-removebg-preview.png",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏ï‡∏¥‡∏î‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏á‡∏≠‡∏°‡πÅ‡∏á‡∏°' - ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤‡πÉ‡∏à‡∏à‡∏∞‡∏Ç‡∏≤‡∏î‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",
                stats: { hp: 35, stamina: 15, attack: 20, defense: 15 }
            },
            {
                rarity: "N",
                name: "‡∏´‡∏£‡∏±‡πà‡∏á",
                image: "https://i.ibb.co/72gX0j/fahsai.jpg",
                skill: "‡∏™‡∏Å‡∏¥‡∏•: '‡∏´‡∏£‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢' - ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏ä‡∏≠‡∏ö‡∏´‡∏£‡∏±‡πà‡∏á‡πÉ‡∏ô",
                stats: { hp: 20, stamina: 30, attack: 18, defense: 10 }
            }
        ];

        let currentDropRates = {
            "LR": 0.01, // New: LR rarity rate
            "UR": 0.04,
            "SSR": 5,
            "SR": 20,
            "N": 74.95 // Adjusted N rate
        };

        const originalDropRates = { ...currentDropRates }; // Store original rates

        const duplicateRewards = {
            "N": 10,
            "SR": 50,
            "SSR": 100,
            "UR": 300,
            "LR": 1000 // New: LR duplicate reward
        };

        const exchangeRates = {
            "N": { count: 500, reward: 100 },
            "SR": { count: 300, reward: 100 },
            "SSR": { count: 150, reward: 100 },
            "UR": { count: 1, reward: 5000 },
            "LR": { count: 1, reward: 15000 } // New: LR exchange rate
        };

        // Mini-Game state
        let easyExpeditionOngoing = false;
        let challengingExpeditionOngoing = false;
        let ancientRuinsExpeditionOngoing = false;
        let summitConquestExpeditionOngoing = false;
        let buddyRescueExpeditionOngoing = false;

        let easyExpeditionEndTime = 0;
        let challengingExpeditionEndTime = 0;
        let ancientRuinsExpeditionEndTime = 0;
        let summitConquestExpeditionEndTime = 0;
        let buddyRescueExpeditionEndTime = 0;


        // --- LocalStorage Functions ---
        function saveGameData() {
            localStorage.setItem('diamondCount', diamondCount);
            localStorage.setItem('rollCounter', rollCounter);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('rollsSinceLastUR', rollsSinceLastUR);
            localStorage.setItem('rollsSinceLastLR', rollsSinceLastLR); // Save LR pity counter
            localStorage.setItem('topUpCount', topUpCount);
            localStorage.setItem('urBoostActive', urBoostActive);
            localStorage.setItem('urBoostEndTime', urBoostEndTime);
            localStorage.setItem('lrBoostActive', lrBoostActive); // Save LR boost status
            localStorage.setItem('lrBoostEndTime', lrBoostEndTime); // Save LR boost end time

            // Save mini-game state
            localStorage.setItem('easyExpeditionOngoing', easyExpeditionOngoing);
            localStorage.setItem('challengingExpeditionOngoing', challengingExpeditionOngoing);
            localStorage.setItem('ancientRuinsExpeditionOngoing', ancientRuinsExpeditionOngoing);
            localStorage.setItem('summitConquestExpeditionOngoing', summitConquestExpeditionOngoing);
            localStorage.setItem('buddyRescueExpeditionOngoing', buddyRescueExpeditionOngoing);

            localStorage.setItem('easyExpeditionEndTime', easyExpeditionEndTime);
            localStorage.setItem('challengingExpeditionEndTime', challengingExpeditionEndTime);
            localStorage.setItem('ancientRuinsExpeditionEndTime', ancientRuinsExpeditionEndTime);
            localStorage.setItem('summitConquestExpeditionEndTime', summitConquestExpeditionEndTime);
            localStorage.setItem('buddyRescueExpeditionEndTime', buddyRescueExpeditionEndTime);
        }

        function loadGameData() {
            const savedDiamonds = localStorage.getItem('diamondCount');
            const savedRolls = localStorage.getItem('rollCounter');
            const savedInventory = localStorage.getItem('inventory');
            const savedRollsSinceLastUR = localStorage.getItem('rollsSinceLastUR');
            const savedRollsSinceLastLR = localStorage.getItem('rollsSinceLastLR'); // Load LR pity counter
            const savedTopUpCount = localStorage.getItem('topUpCount');
            const savedUrBoostActive = localStorage.getItem('urBoostActive');
            const savedUrBoostEndTime = localStorage.getItem('urBoostEndTime');
            const savedLrBoostActive = localStorage.getItem('lrBoostActive'); // Load LR boost status
            const savedLrBoostEndTime = localStorage.getItem('lrBoostEndTime'); // Load LR boost end time

            // Load mini-game state
            const savedEasyExpeditionOngoing = localStorage.getItem('easyExpeditionOngoing');
            const savedChallengingExpeditionOngoing = localStorage.getItem('challengingExpeditionOngoing');
            const savedAncientRuinsExpeditionOngoing = localStorage.getItem('ancientRuinsExpeditionOngoing');
            const savedSummitConquestExpeditionOngoing = localStorage.getItem('summitConquestExpeditionOngoing');
            const savedBuddyRescueExpeditionOngoing = localStorage.getItem('buddyRescueExpeditionOngoing');


            const savedEasyExpeditionEndTime = localStorage.getItem('easyExpeditionEndTime');
            const savedChallengingExpeditionEndTime = localStorage.getItem('challengingExpeditionEndTime');
            const savedAncientRuinsExpeditionEndTime = localStorage.getItem('ancientRuinsExpeditionEndTime');
            const savedSummitConquestExpeditionEndTime = localStorage.getItem('summitConquestExpeditionEndTime');
            const savedBuddyRescueExpeditionEndTime = localStorage.getItem('buddyRescueExpeditionEndTime');


            if (savedDiamonds !== null) {
                diamondCount = parseInt(savedDiamonds);
            }
            if (savedRolls !== null) {
                rollCounter = parseInt(savedRolls);
            }
            if (savedInventory !== null) {
                inventory = JSON.parse(savedInventory);
            }
            if (savedRollsSinceLastUR !== null) {
                rollsSinceLastUR = parseInt(savedRollsSinceLastUR);
            }
            if (savedRollsSinceLastLR !== null) { // Load LR pity
                rollsSinceLastLR = parseInt(savedRollsSinceLastLR);
            }
            if (savedTopUpCount !== null) {
                topUpCount = parseInt(savedTopUpCount);
            }

            urBoostActive = (savedUrBoostActive === 'true');
            urBoostEndTime = parseInt(savedUrBoostEndTime || '0');
            lrBoostActive = (savedLrBoostActive === 'true'); // Load LR boost
            lrBoostEndTime = parseInt(savedLrBoostEndTime || '0'); // Load LR boost

            // Load mini-game state
            easyExpeditionOngoing = (savedEasyExpeditionOngoing === 'true');
            challengingExpeditionOngoing = (savedChallengingExpeditionOngoing === 'true');
            ancientRuinsExpeditionOngoing = (savedAncientRuinsExpeditionOngoing === 'true');
            summitConquestExpeditionOngoing = (savedSummitConquestExpeditionOngoing === 'true');
            buddyRescueExpeditionOngoing = (savedBuddyRescueExpeditionOngoing === 'true');


            easyExpeditionEndTime = parseInt(savedEasyExpeditionEndTime || '0');
            challengingExpeditionEndTime = parseInt(savedChallengingExpeditionEndTime || '0');
            ancientRuinsExpeditionEndTime = parseInt(savedAncientRuinsExpeditionEndTime || '0');
            summitConquestExpeditionEndTime = parseInt(savedSummitConquestExpeditionEndTime || '0');
            buddyRescueExpeditionEndTime = parseInt(savedBuddyRescueExpeditionEndTime || '0');


            updateDisplay();
            checkAllBoostsStatus(); // Check all boost statuses on load
            updateMiniGameButtons(); // Update mini-game buttons on load
        }

        // --- UI Update Functions ---
        function updateDisplay() {
            document.getElementById('rollCount').textContent = rollCounter;
            document.getElementById('diamondCount').textContent = diamondCount;
            document.getElementById('topUpCount').textContent = topUpCount;
            updateShopExchangeButtons();
            updateURBoostDisplay();
            updateLRBoostDisplay(); // New: Update LR boost display
            updateMiniGameButtons(); // Update mini-game buttons
            saveGameData();
        }

        function updateURBoostDisplay() {
            const urBoostStatusElement = document.getElementById('urBoostStatus');
            const buyURBoostBtn = document.getElementById('buyURBoostBtn');
            const now = Date.now();

            if (urBoostActive && urBoostEndTime > now) {
                const timeLeft = urBoostEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                urBoostStatusElement.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                buyURBoostBtn.disabled = true;
            } else {
                urBoostActive = false;
                urBoostEndTime = 0; // Reset end time if expired
                urBoostStatusElement.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                buyURBoostBtn.disabled = false;
            }
        }

        function updateLRBoostDisplay() { // New: Function to update LR boost display
            const lrBoostStatusElement = document.getElementById('lrBoostStatus');
            const buyLRBoostBtn = document.getElementById('buyLRBoostBtn');
            const now = Date.now();

            if (lrBoostActive && lrBoostEndTime > now) {
                const timeLeft = lrBoostEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                lrBoostStatusElement.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                buyLRBoostBtn.disabled = true;
            } else {
                lrBoostActive = false;
                lrBoostEndTime = 0; // Reset end time if expired
                lrBoostStatusElement.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                buyLRBoostBtn.disabled = false;
            }
        }

        function checkAllBoostsStatus() {
            const now = Date.now();
            let shouldRecalculateRates = false;

            if (urBoostActive && now >= urBoostEndTime) {
                urBoostActive = false;
                urBoostEndTime = 0;
                shouldRecalculateRates = true;
            }
            if (lrBoostActive && now >= lrBoostEndTime) { // Check LR boost
                lrBoostActive = false;
                lrBoostEndTime = 0;
                shouldRecalculateRates = true;
            }

            if (shouldRecalculateRates) {
                recalculateDropRates(); // Recalculate if any boost expired
            }
            updateURBoostDisplay();
            updateLRBoostDisplay();
        }

        function recalculateDropRates() {
            currentDropRates = { ...originalDropRates }; // Start with original rates

            // Apply UR boost if active
            if (urBoostActive && urBoostEndTime > Date.now()) {
                currentDropRates["UR"] = originalDropRates["UR"] * 2;
            }

            // Apply LR boost if active
            if (lrBoostActive && lrBoostEndTime > Date.now()) { // New LR boost logic
                currentDropRates["LR"] = originalDropRates["LR"] * 2;
            }

            // Normalize other rates to maintain sum of 100%
            let currentTotalBoostedRate = 0;
            if (currentDropRates["UR"] !== originalDropRates["UR"]) {
                currentTotalBoostedRate += currentDropRates["UR"];
            } else {
                currentTotalBoostedRate += originalDropRates["UR"];
            }

            if (currentDropRates["LR"] !== originalDropRates["LR"]) {
                currentTotalBoostedRate += currentDropRates["LR"];
            } else {
                currentTotalBoostedRate += originalDropRates["LR"];
            }


            const nonBoostedRarities = Object.keys(originalDropRates).filter(r => r !== "UR" && r !== "LR");
            const originalNonBoostedTotal = nonBoostedRarities.reduce((sum, r) => sum + originalDropRates[r], 0);
            const targetNonBoostedTotal = 100 - currentTotalBoostedRate;

            if (originalNonBoostedTotal > 0) {
                const reductionFactor = targetNonBoostedTotal / originalNonBoostedTotal;
                nonBoostedRarities.forEach(rarity => {
                    currentDropRates[rarity] = originalDropRates[rarity] * reductionFactor;
                });
            }
        }

        // --- Gacha Logic ---
        function getWeightedRandomRarity() {
            recalculateDropRates(); // Always ensure rates are up-to-date

            let rand = Math.random() * 100;
            let cumulativeRate = 0;

            // Pity system for LR (highest priority)
            if (rollsSinceLastLR >= PITY_ROLLS_FOR_LR) {
                return "LR";
            }
            // Pity system for UR (second highest priority)
            if (rollsSinceLastUR >= PITY_ROLLS_FOR_UR) {
                return "UR";
            }

            for (const rarity in currentDropRates) {
                cumulativeRate += currentDropRates[rarity];
                if (rand < cumulativeRate) {
                    return rarity;
                }
            }
            return "N"; // Fallback
        }

        function getRandomFriendByRarity(rarity) {
            const friendsInRarity = friendsData.filter(friend => friend.rarity === rarity);
            if (friendsInRarity.length > 0) {
                return friendsInRarity[Math.floor(Math.random() * friendsInRarity.length)];
            }
            console.warn(`No friends found for rarity: ${rarity}. Falling back to Normal.`);
            return friendsData.find(f => f.rarity === "N");
        }

        // --- Card Creation and Display ---
        function createCardElement(friend, rarity) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card-container rarity-${rarity.toLowerCase()}`;
            cardDiv.style.animation = 'fadeIn 0.8s ease-out';

            cardDiv.innerHTML = `
                <div class="rarity-display ${rarity.toLowerCase()}">${rarity}</div>
                <img class="card-image" src="${friend.image}" alt="‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
                <div class="card-name">${friend.name}</div>
                <div class="card-skill">${friend.skill}</div>
                <div class="card-stats">
                    <span>HP: ${friend.stats.hp}</span>
                    <span>Stamina: ${friend.stats.stamina}</span>
                    <span>Attack: ${friend.stats.attack}</span>
                    <span>Defense: ${friend.stats.defense}</span>
                </div>
            `;

            const imgElement = cardDiv.querySelector('.card-image');
            imgElement.style.animation = 'popIn 0.5s ease-out';

            return cardDiv;
        }

        // --- Main Roll Function ---
        function handleRoll(numRolls) {
            const cost = (numRolls === 1) ? COST_PER_ROLL : COST_TEN_ROLLS;
            const errorMessage = document.getElementById('errorMessage');
            const resultsContainer = document.getElementById('resultsContainer');

            checkAllBoostsStatus(); // Ensure rates are correct before rolling

            if (diamondCount < cost) {
                errorMessage.textContent = `‡πÄ‡∏û‡∏ä‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${cost} üíé ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÅ‡∏Ñ‡πà ${diamondCount} üíé`;
                errorMessage.style.display = 'block';
                return;
            }

            diamondCount -= cost;
            errorMessage.style.display = 'none';

            resultsContainer.innerHTML = '';
            let hasUR = false;
            let hasLR = false; // New: Flag for LR
            let hasSRorHigherInTenRolls = false;

            let rollsResults = [];

            for (let i = 0; i < numRolls; i++) {
                rollCounter++;
                rollsSinceLastUR++;
                rollsSinceLastLR++; // Increment LR pity counter

                let selectedRarity;
                let selectedFriend;

                // Determine rarity (pity check within getWeightedRandomRarity)
                selectedRarity = getWeightedRandomRarity();
                selectedFriend = getRandomFriendByRarity(selectedRarity);

                rollsResults.push({ friend: selectedFriend, rarity: selectedRarity });

                if (selectedRarity === "LR") {
                    hasLR = true;
                    rollsSinceLastLR = 0; // Reset LR pity if LR is obtained
                }
                if (selectedRarity === "UR") {
                    hasUR = true;
                    rollsSinceLastUR = 0; // Reset UR pity if UR is obtained
                }
                if (selectedRarity === "SR" || selectedRarity === "SSR" || selectedRarity === "UR" || selectedRarity === "LR") {
                    hasSRorHigherInTenRolls = true;
                }
            }

            // --- 10-Pull Guarantee Logic (after Pity check) ---
            if (numRolls === 10 && !hasSRorHigherInTenRolls) {
                const guaranteedRarities = friendsData.filter(f => f.rarity === 'SR' || f.rarity === 'SSR' || f.rarity === 'UR' || f.rarity === 'LR');
                if (guaranteedRarities.length > 0) {
                    const guaranteedFriend = guaranteedRarities[Math.floor(Math.random() * guaranteedRarities.length)];
                    const nIndex = rollsResults.findIndex(r => r.rarity === 'N');
                    if (nIndex !== -1) {
                        rollsResults[nIndex] = { friend: guaranteedFriend, rarity: guaranteedFriend.rarity };
                    } else {
                        rollsResults[rollsResults.length - 1] = { friend: guaranteedFriend, rarity: guaranteedFriend.rarity };
                    }
                    if (guaranteedFriend.rarity === "UR") {
                        hasUR = true;
                    }
                    if (guaranteedFriend.rarity === "LR") { // Check for guaranteed LR
                        hasLR = true;
                    }
                }
            }

            rollsResults.forEach(result => {
                const friend = result.friend;
                const rarity = result.rarity;

                if (inventory[friend.name]) {
                    inventory[friend.name].count++;
                    diamondCount += duplicateRewards[rarity];
                } else {
                    inventory[friend.name] = { friendData: friend, count: 1 };
                }

                const newCard = createCardElement(friend, rarity);
                resultsContainer.appendChild(newCard);
            });

            updateDisplay();

            if (hasLR) { // New: Show LR popup
                showPopup('lrPopupOverlay');
            } else if (hasUR) {
                showPopup('urPopupOverlay');
            }
        }

        // --- Popup Management ---
        function showPopup(popupId) {
            document.getElementById(popupId).classList.add('active');
        }

        function closePopup(popupId) {
            document.getElementById(popupId).classList.remove('active');
        }

        // --- Shop Functions ---
        function openShop() {
            updateShopExchangeButtons();
            checkAllBoostsStatus(); // Ensure boost displays are fresh
            showPopup('shopPopupOverlay');
        }

        function closeShop() {
            closePopup('shopPopupOverlay');
        }

        function buyDiamonds(amount, price) {
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ ${amount} ‡πÄ‡∏û‡∏ä‡∏£ ‡∏£‡∏≤‡∏Ñ‡∏≤ ${price} ‡∏ö‡∏≤‡∏ó ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                diamondCount += amount;
                topUpCount++;
                updateDisplay();
                alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${amount} ‡πÄ‡∏û‡∏ä‡∏£! ‡πÄ‡∏û‡∏ä‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ ${diamondCount} üíé`);
            }
        }

        function buyProbabilityBoost(cost, rarityType, multiplier, durationMs) {
            if (diamondCount < cost) {
                alert(`‡πÄ‡∏û‡∏ä‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${cost} üíé ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÅ‡∏Ñ‡πà ${diamondCount} üíé`);
                return;
            }

            let boostActiveFlag;
            let boostEndTimeVar;
            let boostStatusElement;
            let boostIntervalVar;

            if (rarityType === 'UR') {
                boostActiveFlag = urBoostActive;
                boostEndTimeVar = urBoostEndTime;
                boostStatusElement = document.getElementById('urBoostStatus');
                boostIntervalVar = 'urBoostInterval';
            } else if (rarityType === 'LR') { // New LR boost handling
                boostActiveFlag = lrBoostActive;
                boostEndTimeVar = lrBoostEndTime;
                boostStatusElement = document.getElementById('lrBoostStatus');
                boostIntervalVar = 'lrBoostInterval';
            } else {
                alert("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á.");
                return;
            }

            if (boostActiveFlag && boostEndTimeVar > Date.now()) {
                alert('‡∏ö‡∏π‡∏™‡∏ï‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà! ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ ${rarityType} x${multiplier} ‡∏£‡∏≤‡∏Ñ‡∏≤ ${cost} üíé ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${durationMs / 60000} ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                diamondCount -= cost;

                if (rarityType === 'UR') {
                    urBoostActive = true;
                    urBoostEndTime = Date.now() + durationMs;
                } else if (rarityType === 'LR') {
                    lrBoostActive = true;
                    lrBoostEndTime = Date.now() + durationMs;
                }

                recalculateDropRates(); // Re-calculate rates after boost purchase
                updateDisplay();

                clearInterval(window[boostIntervalVar]);
                window[boostIntervalVar] = setInterval(() => {
                    checkAllBoostsStatus();
                }, 1000);
                alert(`‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏π‡∏™‡∏ï‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ ${rarityType} x${multiplier} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            }
        }


        // --- Exchange Cards Functions ---
        function updateShopExchangeButtons() {
            const rarityCounts = { "N": 0, "SR": 0, "SSR": 0, "UR": 0, "LR": 0 }; // Added LR
            Object.values(inventory).forEach(item => {
                if (rarityCounts[item.friendData.rarity] !== undefined) {
                    rarityCounts[item.friendData.rarity] += item.count;
                }
            });

            document.getElementById('nCardCount').textContent = rarityCounts["N"];
            document.getElementById('srCardCount').textContent = rarityCounts["SR"];
            document.getElementById('ssrCardCount').textContent = rarityCounts["SSR"];
            document.getElementById('urCardCount').textContent = rarityCounts["UR"];
            document.getElementById('lrCardCount').textContent = rarityCounts["LR"]; // New: LR count

            // Enable/disable buttons based on available cards
            document.getElementById('exchangeNBtn').disabled = rarityCounts["N"] < exchangeRates["N"].count;
            document.getElementById('exchangeSRBtn').disabled = rarityCounts["SR"] < exchangeRates["SR"].count;
            document.getElementById('exchangeSSRBtn').disabled = rarityCounts["SSR"] < exchangeRates["SSR"].count;
            document.getElementById('exchangeURBtn').disabled = rarityCounts["UR"] < exchangeRates["UR"].count;
            document.getElementById('exchangeLRBtn').disabled = rarityCounts["LR"] < exchangeRates["LR"].count; // New: LR exchange button
        }

        function exchangeCards(rarity, requiredCount, rewardDiamonds) {
            let currentCount = 0;
            Object.values(inventory).forEach(item => {
                if (item.friendData.rarity === rarity) {
                    currentCount += item.count;
                }
            });

            if (currentCount < requiredCount) {
                alert(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î ${rarity} ‡πÑ‡∏°‡πà‡∏û‡∏≠ (${currentCount}/${requiredCount})!`);
                return;
            }

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î ${rarity} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${requiredCount} ‡πÉ‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö ${rewardDiamonds} üíé ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                let cardsToDeduct = requiredCount;
                const inventoryArray = Object.values(inventory); // Clone to iterate safely

                // Iterate backwards to safely delete items
                for (let i = inventoryArray.length - 1; i >= 0 && cardsToDeduct > 0; i--) {
                    const item = inventoryArray[i];
                    if (item.friendData.rarity === rarity) {
                        if (item.count <= cardsToDeduct) {
                            cardsToDeduct -= item.count;
                            delete inventory[item.friendData.name]; // Remove the item
                        } else {
                            item.count -= cardsToDeduct;
                            cardsToDeduct = 0;
                        }
                    }
                }

                diamondCount += rewardDiamonds;
                updateDisplay();
                updateShopExchangeButtons();
                alert(`‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${rewardDiamonds} üíé`);
            }
        }


        // --- Inventory Functions ---
        function openInventory() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';

            const rarityOrder = { "LR": 5, "UR": 4, "SSR": 3, "SR": 2, "N": 1 }; // Added LR

            const sortedInventoryKeys = Object.keys(inventory).sort((a, b) => {
                const rarityA = inventory[a].friendData.rarity;
                const rarityB = inventory[b].friendData.rarity;
                return rarityOrder[rarityB] - rarityOrder[rarityA];
            });

            if (sortedInventoryKeys.length === 0) {
                inventoryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #777;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ‡∏•‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏î‡∏π‡∏™‡∏¥!</p>';
            } else {
                sortedInventoryKeys.forEach(friendName => {
                    const item = inventory[friendName];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.innerHTML = `
                        <div class="rarity-label ${item.friendData.rarity.toLowerCase()}">${item.friendData.rarity}</div>
                        <img src="${item.friendData.image}" alt="${item.friendData.name}">
                        <div class="name">${item.friendData.name}</div>
                        <div class="stats">
                            <span>HP: ${item.friendData.stats.hp}</span>
                            <span>Stamina: ${item.friendData.stats.stamina}</span>
                            <span>Attack: ${item.friendData.stats.attack}</span>
                            <span>Defense: ${item.friendData.stats.defense}</span>
                        </div>
                        <div class="count">${item.count}</div>
                    `;
                    inventoryGrid.appendChild(itemDiv);
                });
            }
            showPopup('inventoryPopupOverlay');
        }

        // --- Mini-Game Functions ---
        function openMiniGame() {
            updateMiniGameButtons();
            showPopup('miniGamePopupOverlay');
        }

        function updateMiniGameButtons() {
            const nCards = getCardCountByRarity("N");
            const srCards = getCardCountByRarity("SR");
            const ssrCards = getCardCountByRarity("SSR");
            const urCards = getCardCountByRarity("UR");
            const lrCards = getCardCountByRarity("LR");

            const totalStamina = getTotalStat("stamina");
            const totalAttack = getTotalStat("attack");
            const totalDefense = getTotalStat("defense");

            const now = Date.now();

            // Expedition 1 (Easy)
            const easyBtn = document.getElementById('startExpedition1Btn');
            const easyStatus = document.getElementById('easyExpeditionStatus');
            document.getElementById('miniGame1NCount').textContent = nCards;
            document.getElementById('miniGame1SRCount').textContent = srCards;

            if (easyExpeditionOngoing && easyExpeditionEndTime > now) {
                const timeLeft = easyExpeditionEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                easyStatus.textContent = `‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà... (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                easyBtn.disabled = true;
            } else if (easyExpeditionOngoing && easyExpeditionEndTime <= now) {
                easyExpeditionOngoing = false;
                easyExpeditionEndTime = 0;
                easyStatus.textContent = '';
                claimExpeditionRewards('easy');
            } else {
                easyStatus.textContent = '';
                easyBtn.disabled = !((nCards >= 5) || (srCards >= 1));
            }

            // Expedition 2 (Challenging)
            const challengingBtn = document.getElementById('startExpedition2Btn');
            const challengingStatus = document.getElementById('challengingExpeditionStatus');
            document.getElementById('miniGame2SSRCount').textContent = ssrCards;
            document.getElementById('miniGame2URCount').textContent = urCards;

            if (challengingExpeditionOngoing && challengingExpeditionEndTime > now) {
                const timeLeft = challengingExpeditionEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                challengingStatus.textContent = `‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà... (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                challengingBtn.disabled = true;
            } else if (challengingExpeditionOngoing && challengingExpeditionEndTime <= now) {
                challengingExpeditionOngoing = false;
                challengingExpeditionEndTime = 0;
                challengingStatus.textContent = '';
                claimExpeditionRewards('challenging');
            } else {
                challengingStatus.textContent = '';
                challengingBtn.disabled = !((ssrCards >= 3) || (urCards >= 1));
            }

            // Expedition 3 (Ancient Ruins)
            const ancientRuinsBtn = document.getElementById('startExpedition3Btn');
            const ancientRuinsStatus = document.getElementById('ancientRuinsExpeditionStatus');
            document.getElementById('miniGame3StaminaCount').textContent = totalStamina;

            if (ancientRuinsExpeditionOngoing && ancientRuinsExpeditionEndTime > now) {
                const timeLeft = ancientRuinsExpeditionEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                ancientRuinsStatus.textContent = `‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà... (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                ancientRuinsBtn.disabled = true;
            } else if (ancientRuinsExpeditionOngoing && ancientRuinsExpeditionEndTime <= now) {
                ancientRuinsExpeditionOngoing = false;
                ancientRuinsExpeditionEndTime = 0;
                ancientRuinsStatus.textContent = '';
                claimExpeditionRewards('ancient_ruins');
            } else {
                ancientRuinsStatus.textContent = '';
                ancientRuinsBtn.disabled = !(totalStamina >= 200);
            }

            // Expedition 4 (Summit Conquest)
            const summitConquestBtn = document.getElementById('startExpedition4Btn');
            const summitConquestStatus = document.getElementById('summitConquestExpeditionStatus');
            document.getElementById('miniGame4AttackCount').textContent = totalAttack;

            if (summitConquestExpeditionOngoing && summitConquestExpeditionEndTime > now) {
                const timeLeft = summitConquestExpeditionEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                summitConquestStatus.textContent = `‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà... (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                summitConquestBtn.disabled = true;
            } else if (summitConquestExpeditionOngoing && summitConquestExpeditionEndTime <= now) {
                summitConquestExpeditionOngoing = false;
                summitConquestExpeditionEndTime = 0;
                summitConquestStatus.textContent = '';
                claimExpeditionRewards('summit_conquest');
            } else {
                summitConquestStatus.textContent = '';
                summitConquestBtn.disabled = !(totalAttack >= 300);
            }

            // Expedition 5 (Buddy Rescue)
            const buddyRescueBtn = document.getElementById('startExpedition5Btn');
            const buddyRescueStatus = document.getElementById('buddyRescueExpeditionStatus');
            document.getElementById('miniGame5DefenseCount').textContent = totalDefense;
            document.getElementById('miniGame5NCount').textContent = nCards;

            if (buddyRescueExpeditionOngoing && buddyRescueExpeditionEndTime > now) {
                const timeLeft = buddyRescueExpeditionEndTime - now;
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                buddyRescueStatus.textContent = `‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà... (${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)`;
                buddyRescueBtn.disabled = true;
            } else if (buddyRescueExpeditionOngoing && buddyRescueExpeditionEndTime <= now) {
                buddyRescueExpeditionOngoing = false;
                buddyRescueExpeditionEndTime = 0;
                buddyRescueStatus.textContent = '';
                claimExpeditionRewards('buddy_rescue');
            } else {
                buddyRescueStatus.textContent = '';
                buddyRescueBtn.disabled = !((totalDefense >= 250) && (nCards >= 50));
            }


            saveGameData(); // Save state after updating buttons
        }


        function getCardCountByRarity(rarity) {
            let count = 0;
            Object.values(inventory).forEach(item => {
                if (item.friendData.rarity === rarity) {
                    count += item.count;
                }
            });
            return count;
        }

        function getTotalStat(statType) {
            let totalStat = 0;
            Object.values(inventory).forEach(item => {
                totalStat += item.friendData.stats[statType] * item.count;
            });
            return totalStat;
        }

        function getCardsForExpedition(type) {
            let nCards = getCardCountByRarity("N");
            let srCards = getCardCountByRarity("SR");
            let ssrCards = getCardCountByRarity("SSR");
            let urCards = getCardCountByRarity("UR");
            let lrCards = getCardCountByRarity("LR");

            if (type === 'easy') {
                if (nCards >= 5) return { rarity: "N", count: 5 };
                if (srCards >= 1) return { rarity: "SR", count: 1 };
                return null;
            } else if (type === 'challenging') {
                if (ssrCards >= 3) return { rarity: "SSR", count: 3 };
                if (urCards >= 1) return { rarity: "UR", count: 1 };
                return null;
            } else if (type === 'ancient_ruins') {
                const availableCards = Object.values(inventory).filter(item => item.friendData.rarity === 'UR' || item.friendData.rarity === 'SSR' || item.friendData.rarity === 'SR');
                let tempStamina = 0;
                let cardsToUse = [];

                // Prioritize higher rarity cards for deduction
                const sortedAvailable = availableCards.sort((a, b) => {
                    const rarityOrder = { "UR": 3, "SSR": 2, "SR": 1 };
                    return rarityOrder[b.friendData.rarity] - rarityOrder[a.friendData.rarity];
                });

                for (const item of sortedAvailable) {
                    for (let i = 0; i < item.count; i++) {
                        if (tempStamina < 200) {
                            tempStamina += item.friendData.stats.stamina;
                            cardsToUse.push(item.friendData);
                        } else {
                            break;
                        }
                    }
                    if (tempStamina >= 200) break;
                }

                if (tempStamina >= 200) {
                    return { type: "stat_based", cards: cardsToUse, stat: "stamina", required: 200 };
                }
                return null;
            } else if (type === 'summit_conquest') {
                 const availableCards = Object.values(inventory).filter(item => item.friendData.rarity === 'LR' || item.friendData.rarity === 'UR' || item.friendData.rarity === 'SSR');
                let tempAttack = 0;
                let cardsToUse = [];

                const sortedAvailable = availableCards.sort((a, b) => {
                    const rarityOrder = { "LR": 3, "UR": 2, "SSR": 1 };
                    return rarityOrder[b.friendData.rarity] - rarityOrder[a.friendData.rarity];
                });

                for (const item of sortedAvailable) {
                    for (let i = 0; i < item.count; i++) {
                        if (tempAttack < 300) {
                            tempAttack += item.friendData.stats.attack;
                            cardsToUse.push(item.friendData);
                        } else {
                            break;
                        }
                    }
                    if (tempAttack >= 300) break;
                }

                if (tempAttack >= 300) {
                    return { type: "stat_based", cards: cardsToUse, stat: "attack", required: 300 };
                }
                return null;
            } else if (type === 'buddy_rescue') {
                const availableNCards = getCardCountByRarity("N");
                if (availableNCards < 50) return null;

                const availableCards = Object.values(inventory).filter(item => item.friendData.rarity === 'LR' || item.friendData.rarity === 'UR' || item.friendData.rarity === 'SSR' || item.friendData.rarity === 'SR');
                let tempDefense = 0;
                let cardsToUseForDefense = [];

                const sortedAvailable = availableCards.sort((a, b) => {
                    const rarityOrder = { "LR": 4, "UR": 3, "SSR": 2, "SR": 1 };
                    return rarityOrder[b.friendData.rarity] - rarityOrder[a.friendData.rarity];
                });

                for (const item of sortedAvailable) {
                    for (let i = 0; i < item.count; i++) {
                        if (tempDefense < 250) {
                            tempDefense += item.friendData.stats.defense;
                            cardsToUseForDefense.push(item.friendData);
                        } else {
                            break;
                        }
                    }
                    if (tempDefense >= 250) break;
                }

                if (tempDefense >= 250 && availableNCards >= 50) {
                    return { type: "complex", cardsForDefense: cardsToUseForDefense, nCardsRequired: 50 };
                }
                return null;
            }
            return null;
        }

        function deductCardsFromInventory(rarity, count) {
            let cardsToDeduct = count;
            const inventoryArray = Object.values(inventory);

            // Iterate backwards to safely delete items
            for (let i = inventoryArray.length - 1; i >= 0 && cardsToDeduct > 0; i--) {
                const item = inventoryArray[i];
                if (item.friendData.rarity === rarity) {
                    if (item.count <= cardsToDeduct) {
                        cardsToDeduct -= item.count;
                        delete inventory[item.friendData.name];
                    } else {
                        item.count -= cardsToDeduct;
                        cardsToDeduct = 0;
                    }
                }
            }
        }

        function deductSpecificCardsFromInventory(cardsList) {
            cardsList.forEach(cardData => {
                if (inventory[cardData.name] && inventory[cardData.name].count > 0) {
                    inventory[cardData.name].count--;
                    if (inventory[cardData.name].count === 0) {
                        delete inventory[cardData.name];
                    }
                }
            });
        }


        function startExpedition(type) {
            let costMet = false;
            let cardsUsed = null;
            let durationMinutes = 0;

            if (type === 'easy') {
                const reqs = getCardsForExpedition('easy');
                if (reqs) {
                    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ${reqs.rarity} ${reqs.count} ‡πÉ‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        deductCardsFromInventory(reqs.rarity, reqs.count);
                        costMet = true;
                        durationMinutes = 1;
                    }
                } else {
                    alert("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ!");
                }
            } else if (type === 'challenging') {
                const reqs = getCardsForExpedition('challenging');
                if (reqs) {
                    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ${reqs.rarity} ${reqs.count} ‡πÉ‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        deductCardsFromInventory(reqs.rarity, reqs.count);
                        costMet = true;
                        durationMinutes = 5;
                    }
                } else {
                    alert("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢!");
                }
            } else if (type === 'ancient_ruins') {
                const reqs = getCardsForExpedition('ancient_ruins');
                if (reqs) {
                    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Stamina ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô ${reqs.required} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        deductSpecificCardsFromInventory(reqs.cards);
                        costMet = true;
                        durationMinutes = 10;
                    }
                } else {
                    alert("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Stamina ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ! (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° 200)");
                }
            } else if (type === 'summit_conquest') {
                const reqs = getCardsForExpedition('summit_conquest');
                if (reqs) {
                    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Attack ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô ${reqs.required} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        deductSpecificCardsFromInventory(reqs.cards);
                        costMet = true;
                        durationMinutes = 30;
                    }
                } else {
                    alert("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Attack ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ! (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° 300)");
                }
            } else if (type === 'buddy_rescue') {
                const reqs = getCardsForExpedition('buddy_rescue');
                if (reqs) {
                    if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î N ${reqs.nCardsRequired} ‡πÉ‡∏ö ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Defense ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô ${reqs.cardsForDefense.reduce((sum, c) => sum + c.stats.defense, 0)} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        deductCardsFromInventory("N", reqs.nCardsRequired);
                        deductSpecificCardsFromInventory(reqs.cardsForDefense);
                        costMet = true;
                        durationMinutes = 15;
                    }
                } else {
                    alert("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ! (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ N 50 ‡πÉ‡∏ö ‡πÅ‡∏•‡∏∞ Defense ‡∏£‡∏ß‡∏° 250)");
                }
            }

            if (costMet) {
                const now = Date.now();
                if (type === 'easy') {
                    easyExpeditionOngoing = true;
                    easyExpeditionEndTime = now + (durationMinutes * 60 * 1000);
                    window.easyExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
                } else if (type === 'challenging') {
                    challengingExpeditionOngoing = true;
                    challengingExpeditionEndTime = now + (durationMinutes * 60 * 1000);
                    window.challengingExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
                } else if (type === 'ancient_ruins') {
                    ancientRuinsExpeditionOngoing = true;
                    ancientRuinsExpeditionEndTime = now + (durationMinutes * 60 * 1000);
                    window.ancientRuinsExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
                } else if (type === 'summit_conquest') {
                    summitConquestExpeditionOngoing = true;
                    summitConquestExpeditionEndTime = now + (durationMinutes * 60 * 1000);
                    window.summitConquestExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
                } else if (type === 'buddy_rescue') {
                    buddyRescueExpeditionOngoing = true;
                    buddyRescueExpeditionEndTime = now + (durationMinutes * 60 * 1000);
                    window.buddyRescueExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
                }
                alert(`‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢ ${type} ‡πÅ‡∏•‡πâ‡∏ß! ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ô ${durationMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ`);
                updateDisplay();
            }
        }

        function claimExpeditionRewards(type) {
            let rewardsMessage = "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢:";
            if (type === 'easy') {
                diamondCount += 50;
                rewardsMessage += " 50 üíé";
                if (Math.random() * 100 < 5) { // 5% chance for SSR
                    const ssrFriend = getRandomFriendByRarity("SSR");
                    addCardToInventory(ssrFriend);
                    rewardsMessage += `, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î SSR: ${ssrFriend.name}`;
                }
                alert(rewardsMessage);
            } else if (type === 'challenging') {
                diamondCount += 500;
                rewardsMessage += " 500 üíé";
                if (Math.random() * 100 < 1) { // 1% chance for UR
                    const urFriend = getRandomFriendByRarity("UR");
                    addCardToInventory(urFriend);
                    rewardsMessage += `, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î UR: ${urFriend.name}`;
                } else if (Math.random() * 100 < 0.1) { // 0.1% chance for LR
                    const lrFriend = getRandomFriendByRarity("LR");
                    addCardToInventory(lrFriend);
                    rewardsMessage += `, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î LR: ${lrFriend.name}`;
                }
                alert(rewardsMessage);
            } else if (type === 'ancient_ruins') {
                diamondCount += 1000;
                rewardsMessage += " 1000 üíé";
                if (Math.random() * 100 < 2) { // 2% chance for LR
                    const lrFriend = getRandomFriendByRarity("LR");
                    addCardToInventory(lrFriend);
                    rewardsMessage += `, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î LR: ${lrFriend.name}`;
                }
                alert(rewardsMessage);
            } else if (type === 'summit_conquest') {
                diamondCount += 5000;
                rewardsMessage += " 5000 üíé";
                const lrFriend = getRandomFriendByRarity("LR"); // 100% LR
                addCardToInventory(lrFriend);
                rewardsMessage += `, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î LR: ${lrFriend.name}`;
                alert(rewardsMessage);
            } else if (type === 'buddy_rescue') {
                diamondCount += 2500;
                rewardsMessage += " 2500 üíé";
                const urFriends = friendsData.filter(f => f.rarity === "UR");
                if (urFriends.length > 0) {
                    const selectedUR = prompt(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö UR Card 100%! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î UR ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: \n${urFriends.map((f, i) => `${i + 1}. ${f.name}`).join('\n')}\n(‡∏õ‡πâ‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç):`);
                    const urIndex = parseInt(selectedUR) - 1;
                    if (urIndex >= 0 && urIndex < urFriends.length) {
                        addCardToInventory(urFriends[urIndex]);
                        rewardsMessage += `, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î UR: ${urFriends[urIndex].name} ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å!`;
                    } else {
                        rewardsMessage += `, ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î UR ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`;
                        // Give a random UR if selection fails
                        addCardToInventory(getRandomFriendByRarity("UR"));
                    }
                } else {
                    rewardsMessage += `, ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î UR ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`;
                }
                alert(rewardsMessage);
            }
            updateDisplay();
        }

        function addCardToInventory(friendData) {
            if (inventory[friendData.name]) {
                inventory[friendData.name].count++;
            } else {
                inventory[friendData.name] = { friendData: friendData, count: 1 };
            }
        }


        // --- Reset Function ---
        function resetAll() {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏ä‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ!")) {
                rollCounter = 0;
                diamondCount = 1000;
                topUpCount = 0;
                inventory = {};
                rollsSinceLastUR = 0;
                rollsSinceLastLR = 0; // Reset LR pity
                urBoostActive = false;
                urBoostEndTime = 0;
                lrBoostActive = false; // Reset LR boost
                lrBoostEndTime = 0; // Reset LR boost
                currentDropRates = { ...originalDropRates };
                clearInterval(window.urBoostInterval);
                clearInterval(window.lrBoostInterval); // Clear LR boost interval

                // Reset mini-game states
                easyExpeditionOngoing = false;
                challengingExpeditionOngoing = false;
                ancientRuinsExpeditionOngoing = false;
                summitConquestExpeditionOngoing = false;
                buddyRescueExpeditionOngoing = false;

                easyExpeditionEndTime = 0;
                challengingExpeditionEndTime = 0;
                ancientRuinsExpeditionEndTime = 0;
                summitConquestExpeditionEndTime = 0;
                buddyRescueExpeditionEndTime = 0;

                clearInterval(window.easyExpeditionTimer);
                clearInterval(window.challengingExpeditionTimer);
                clearInterval(window.ancientRuinsExpeditionTimer);
                clearInterval(window.summitConquestExpeditionTimer);
                clearInterval(window.buddyRescueExpeditionTimer);


                updateDisplay();

                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.innerHTML = '';

                const initialCard = document.createElement('div');
                initialCard.id = 'initialCard';
                initialCard.className = 'card-container';
                initialCard.innerHTML = `
                    <h1>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠...</h1>
                    <div id="rarityDisplay" class="rarity-display"></div>
                    <img id="friendImage" class="card-image" src="https://via.placeholder.com/150/EEEEEE/888888?text=‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" alt="‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
                    <div id="friendName" class="card-name">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°!</div>
                    <div id="friendSkill" class="card-skill">‡∏à‡∏∞‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡∏™‡∏∏‡∏î‡∏Æ‡∏≤!</div>
                    <div id="friendStats" class="card-stats"></div>
                `;
                resultsContainer.appendChild(initialCard);

                document.getElementById('errorMessage').style.display = 'none';
                alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!");
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadGameData();
            updateShopExchangeButtons();
            updateMiniGameButtons(); // Initial update for mini-game buttons

            // Set up recurring checks for boost expiration
            if (urBoostActive && urBoostEndTime > Date.now()) {
                window.urBoostInterval = setInterval(() => checkAllBoostsStatus(), 1000);
            }
            if (lrBoostActive && lrBoostEndTime > Date.now()) {
                window.lrBoostInterval = setInterval(() => checkAllBoostsStatus(), 1000);
            }
            // Set up recurring checks for expedition completion
            if (easyExpeditionOngoing && easyExpeditionEndTime > Date.now()) {
                window.easyExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
            }
            if (challengingExpeditionOngoing && challengingExpeditionEndTime > Date.now()) {
                window.challengingExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
            }
            if (ancientRuinsExpeditionOngoing && ancientRuinsExpeditionEndTime > Date.now()) {
                window.ancientRuinsExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
            }
            if (summitConquestExpeditionOngoing && summitConquestExpeditionEndTime > Date.now()) {
                window.summitConquestExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
            }
            if (buddyRescueExpeditionOngoing && buddyRescueExpeditionEndTime > Date.now()) {
                window.buddyRescueExpeditionTimer = setInterval(() => updateMiniGameButtons(), 1000);
            }
        });
    </script>
</body>
</html>
