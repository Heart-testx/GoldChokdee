<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ร้านโชคดีรับซื้อทอง,เงิน,นาก</title>
  
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for easy theme switching */
    :root {
      --bg-color: #e0e0e0; /* Light mode: สีเทาอ่อนเหมือนปูนเปลือย */
      --text-color: #333333; /* Light mode: สีเทาเข้มสำหรับข้อความ */
      --container-bg: #f2f2f2; /* Light mode: ขาวอมเทาสำหรับ container */
      --border-color: #b0b0b0; /* Light mode: ขอบสีเทากลางๆ */
      --box-shadow-color: rgba(0,0,0,0.15); /* Light mode: เงา */
      --tab-inactive-bg: #e0e0e0; /* Light mode: พื้นหลัง tab ที่ไม่ active */
      --tab-inactive-text: #666666; /* Light mode: สีข้อความ tab ที่ไม่ active */
      --tab-active-bg: #ffffff; /* Light mode: พื้นหลัง tab ที่ active */
      --tab-active-text: #333333; /* Light mode: สีข้อความ tab ที่ active */
      --tab-active-border: #6c757d; /* Light mode: สีเทาเข้มสำหรับขีดเส้นใต้ active tab */
      --input-bg: #ffffff; /* Light mode: พื้นหลัง input */
      --input-text: #333333; /* Light mode: สีข้อความ input */
      --input-placeholder: #888888; /* Light mode: สี placeholder */
      --button-bg: #6c757d; /* Light mode: ปุ่มหลักสีเทาเข้ม */
      --button-text: white; /* Light mode: ข้อความขาวบนปุ่ม */
      --button-hover-bg: #5a6268; /* Light mode: สีเข้มขึ้นเมื่อ hover */
      --reset-btn-bg: #dc3545; /* Light mode: ปุ่มรีเซ็ตสีแดง */
      --reset-btn-hover-bg: #c82333; /* Light mode: ปุ่มรีเซ็ตสีแดง hover */
      --popup-bg: #f2f2f2; /* Light mode: พื้นหลัง popup */
      --popup-text: #333333; /* Light mode: ข้อความ popup */
      --popup-close-btn: #888888; /* Light mode: ปุ่มปิด popup */
      --history-bg: #f2f2f2; /* Light mode: พื้นหลัง history section */
      --history-list-bg: #ffffff; /* Light mode: พื้นหลัง list item */
      --history-item-border: #e0e0e0; /* Light mode: เส้นแบ่ง item */
      --history-item-text: #555555; /* Light mode: ข้อความ item */
      --history-item-time: #777; /* Light mode: เวลา item */
      --gold-item-bg: #fcf8e3; /* Light mode: สีทองอ่อนๆ */
      --gold-item-border: #d4af37; /* Light mode: สีทองเข้ม */
      --silver-item-bg: #f0f4f7; /* Light mode: สีเงินอ่อนๆ */
      --silver-item-border: #a0a0a0; /* Light mode: สีเงินเข้ม */
      --link-color: #6c757d; /* Light mode: สีลิงก์ */
    }

    /* Dark Mode Styles */
    body.dark-mode {
      --bg-color: #2c2c2c; /* Dark mode: พื้นหลังเข้ม */
      --text-color: #e0e0e0; /* Dark mode: ข้อความสว่าง */
      --container-bg: #3a3a3a; /* Dark mode: พื้นหลัง container เข้มขึ้น */
      --border-color: #555555; /* Dark mode: ขอบเข้มขึ้น */
      --box-shadow-color: rgba(0,0,0,0.4); /* Dark mode: เงาเข้มขึ้น */
      --tab-inactive-bg: #4a4a4a; /* Dark mode: พื้นหลัง tab ที่ไม่ active */
      --tab-inactive-text: #bbbbbb; /* Dark mode: สีข้อความ tab ที่ไม่ active */
      --tab-active-bg: #2c2c2c; /* Dark mode: พื้นหลัง tab ที่ active */
      --tab-active-text: #ffffff; /* Dark mode: สีข้อความ tab ที่ active */
      --tab-active-border: #888888; /* Dark mode: ขีดเส้นใต้ active tab */
      --input-bg: #4a4a4a; /* Dark mode: พื้นหลัง input เข้ม */
      --input-text: #e0e0e0; /* Dark mode: สีข้อความ input สว่าง */
      --input-placeholder: #aaaaaa; /* Dark mode: สี placeholder สว่าง */
      --button-bg: #555555; /* Dark mode: ปุ่มหลักสีเข้ม */
      --button-text: #e0e0e0; /* Dark mode: ข้อความสว่างบนปุ่ม */
      --button-hover-bg: #666666; /* Dark mode: สีเข้มขึ้นเมื่อ hover */
      --reset-btn-bg: #a03030; /* Dark mode: ปุ่มรีเซ็ตสีแดงเข้ม */
      --reset-btn-hover-bg: #b04040; /* Dark mode: ปุ่มรีเซ็ตสีแดงเข้ม hover */
      --popup-bg: #3a3a3a; /* Dark mode: พื้นหลัง popup เข้ม */
      --popup-text: #e0e0e0; /* Dark mode: ข้อความ popup สว่าง */
      --popup-close-btn: #aaaaaa; /* Dark mode: ปุ่มปิด popup สว่าง */
      --history-bg: #3a3a3a; /* Dark mode: พื้นหลัง history section เข้ม */
      --history-list-bg: #4a4a4a; /* Dark mode: พื้นหลัง list item เข้ม */
      --history-item-border: #555555; /* Dark mode: เส้นแบ่ง item เข้ม */
      --history-item-text: #bbbbbb; /* Dark mode: ข้อความ item สว่าง */
      --history-item-time: #aaaaaa; /* Dark mode: เวลา item สว่าง */
      --gold-item-bg: #4a4230; /* Dark mode: สีทองอ่อนๆ เข้ม */
      --gold-item-border: #d4af37; /* Dark mode: สีทองเข้ม */
      --silver-item-bg: #40454a; /* Dark mode: สีเงินอ่อนๆ เข้ม */
      --silver-item-border: #a0a0a0; /* Dark mode: สีเงินเข้ม */
      --link-color: #99ccff; /* Dark mode: สีลิงก์สว่างขึ้น */
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 15px;
      margin: 0;
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
    }

    .theme-toggle {
        position: fixed; /* Changed to fixed */
        top: 15px; /* Adjust as needed */
        right: 15px; /* Adjust as needed */
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: var(--text-color);
        transition: color 0.2s ease;
        padding: 5px;
        line-height: 1;
        z-index: 1001; /* Ensure it's above other elements */
    }
    .theme-toggle:hover {
        color: var(--tab-active-border); /* Use a highlight color */
    }

    .container {
      max-width: 420px;
      width: 95%;
      margin: 25px auto 10px auto;
      background-color: var(--container-bg);
      border: 2px solid var(--border-color);
      border-radius: 0px;
      box-shadow: 0 4px 8px var(--box-shadow-color);
      position: relative; /* Keep relative for internal elements if needed, but not for toggle */
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
    }

    .tab-button {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      cursor: pointer;
      background-color: var(--tab-inactive-bg);
      border: none;
      border-radius: 0px;
      font-size: 1.1em;
      font-weight: 600;
      color: var(--tab-inactive-text);
      transition: background-color 0.2s ease, color 0.2s ease;
      border-right: 1px solid var(--border-color); /* Use border-color for tab dividers */
    }

    .tab-button:last-child {
        border-right: none;
    }

    .tab-button.active {
      background-color: var(--tab-active-bg);
      color: var(--tab-active-text);
      border-bottom: 3px solid var(--tab-active-border);
      font-weight: 700;
    }

    .tab-button:hover:not(.active) {
      background-color: var(--tab-inactive-bg); /* Use inactive bg for hover */
      filter: brightness(0.9); /* Slightly darken on hover */
    }

    .calculator {
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 20px;
      font-size: 1.6em;
      font-weight: 600;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 400;
      font-size: 0.95em;
      color: var(--text-color);
    }

    input {
      width: calc(100% - 22px);
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 0px;
      background-color: var(--input-bg);
      color: var(--input-text);
      font-size: 1em;
      font-family: 'Sarabun', sans-serif;
      margin-bottom: 5px;
      outline: none;
      box-sizing: border-box;
    }

    input::placeholder {
        color: var(--input-placeholder);
    }

    input:focus {
      border-color: var(--tab-active-border);
      box-shadow: 0 0 5px var(--box-shadow-color);
    }

    input.is-invalid {
      border-color: #dc3545; /* Red for error, constant */
      box-shadow: 0 0 5px rgba(220,53,69,0.5);
    }

    .error-message {
      color: #dc3545; /* Red for error, constant */
      font-size: 0.85em;
      margin-top: 5px;
      margin-bottom: 15px;
      display: block;
      min-height: 1.2em;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background-color: var(--button-bg);
      color: var(--button-text);
      border: 1px solid var(--border-color);
      border-radius: 0px;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px var(--box-shadow-color);
      text-transform: uppercase;
    }

    button.reset-btn {
      background-color: var(--reset-btn-bg);
      border-color: var(--reset-btn-hover-bg);
      color: var(--button-text);
    }

    button.reset-btn:hover {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: 0 3px 6px var(--box-shadow-color);
    }

    button.reset-btn:active {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: inset 0 1px 3px var(--box-shadow-color);
    }

    button:hover {
      background-color: var(--button-hover-bg);
      box-shadow: 0 3px 6px var(--box-shadow-color);
    }

    button:active {
      background-color: var(--button-hover-bg);
      box-shadow: inset 0 1px 3px var(--box-shadow-color);
    }

    .output {
      display: none;
    }

    .output p {
      margin: 8px 0;
    }

    /* Popup Styling */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background-color: var(--popup-bg);
      padding: 30px;
      border-radius: 0px;
      border: 2px solid var(--border-color);
      box-shadow: 0 5px 15px var(--box-shadow-color);
      text-align: center;
      max-width: 350px;
      width: 90%;
      position: relative;
      color: var(--popup-text);
    }

    .popup-content h3 {
      color: var(--text-color);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-transform: uppercase;
    }

    .popup-content p {
      font-size: 1.1em;
      margin: 10px 0;
      color: var(--popup-text);
    }

    .popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: var(--popup-close-btn);
    }

    .popup-content .close-btn:hover {
      color: var(--text-color);
    }

    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* History Section Styling */
    .history-section {
        background-color: var(--history-bg);
        border: 2px solid var(--border-color);
        border-radius: 0px;
        padding: 20px;
        max-width: 400px;
        width: 95%;
        margin: 20px auto;
        box-shadow: 0 2px 5px var(--box-shadow-color);
        color: var(--text-color);
    }

    .history-section h3 {
        text-align: center;
        color: var(--text-color);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.4em;
        text-transform: uppercase;
    }

    .history-list {
        list-style-type: none;
        padding: 0;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 0px;
        padding-top: 5px;
        padding-bottom: 5px;
        background-color: var(--history-list-bg);
    }

    .history-list li {
        margin: 5px 0;
        padding: 10px;
        border-radius: 0px;
        border-bottom: 1px solid var(--history-item-border);
        font-size: 0.9em;
        color: var(--history-item-text);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        position: relative;
    }

    .history-list li:last-child {
        border-bottom: none;
    }

    .history-list li strong {
        color: var(--text-color);
    }

    .gold-history-item {
        background-color: var(--gold-item-bg);
        border-left: 5px solid var(--gold-item-border);
    }

    .silver-history-item {
        background-color: var(--silver-item-bg);
        border-left: 5px solid var(--silver-item-border);
    }

    .history-item-main-text {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
        flex-grow: 1;
    }

    .history-item-content {
        flex-grow: 1;
    }

    .history-item-time {
      font-size: 0.8em;
      color: var(--history-item-time);
      margin-top: 5px;
      align-self: flex-end;
      text-align: right;
      width: 100%;
      padding-right: 25px;
      box-sizing: border-box;
    }

    .delete-history-item {
        background: none;
        border: none;
        color: #dc3545; /* Red for delete, constant */
        font-size: 1.2em;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        transition: color 0.2s ease;
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .delete-history-item:hover {
        color: #c82333; /* Darker red on hover */
    }

    .clear-history-btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 15px;
        background-color: var(--reset-btn-bg);
        color: var(--button-text);
        border: 1px solid var(--reset-btn-hover-bg);
        border-radius: 0px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px var(--box-shadow-color);
        text-transform: uppercase;
    }

    .clear-history-btn:hover {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: 0 3px 6px var(--box-shadow-color);
    }

    .clear-history-btn:active {
      background-color: var(--reset-btn-hover-bg);
      box-shadow: inset 0 1px 3px var(--box-shadow-color);
    }

    .price-reference {
        font-size: 0.85em;
        text-align: center;
        margin-top: 15px;
        color: var(--text-color);
    }
    .price-reference a {
        color: var(--link-color);
        text-decoration: none;
        font-weight: 600;
    }
    .price-reference a:hover {
        text-decoration: underline;
    }

    .popup-karat {
        margin-top: 5px;
        font-weight: 600;
        color: var(--link-color); /* Use link color for Karat display */
        font-size: 1em;
    }


    /* Media Queries */
    @media screen and (max-width: 600px) {
      body {
        padding: 10px;
      }

      /* Adjust margin for container to account for fixed button */
      .container {
        margin-top: 50px; /* Give space for the fixed toggle button */
      }

      .calculator {
        padding: 15px;
      }

      h2 {
        font-size: 1.5em;
        margin-bottom: 15px;
      }

      label {
        font-size: 0.9em;
      }

      input {
        padding: 8px;
        font-size: 0.95em;
        margin-bottom: 10px;
      }

      .button-group {
        flex-direction: column;
        gap: 8px;
      }
      button {
        padding: 10px;
        font-size: 1em;
        min-width: unset;
      }

      .popup-content {
        padding: 20px;
      }
      .popup-content h3 {
        font-size: 1.3em;
      }
      .popup-content p {
        font-size: 1em;
      }

      .tab-button {
        font-size: 1em;
        padding: 10px 0;
      }

      .history-section {
        padding: 15px;
      }
      .history-section h3 {
        font-size: 1.3em;
      }
      .history-list li {
        font-size: 0.85em;
      }
      .delete-history-item {
        top: 5px;
        right: 5px;
      }
      .history-item-time {
        padding-right: 0;
      }
    }
  </style>
</head>
<body>

  <button class="theme-toggle" onclick="toggleDarkMode()" id="themeToggleButton">
      ☀️
  </button>

  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="openTab(event, 'gold')">ทอง</button>
      <button class="tab-button" onclick="openTab(event, 'silver')">เงิน</button>
    </div>

    <div id="gold" class="tab-content active calculator">
      <h2>🥇คิดราคาทอง🥇</h2>

      <label for="goldPrice">ราคาทอง ณ ปัจจุบัน (บาท):</label>
      <input type="number" id="goldPrice" placeholder="กรอกราคาทอง">
      <span class="error-message" id="goldPriceError"></span>

      <label for="goldAdditionalPrice">มีบัตร+🪪 (บาท):</label>
      <input type="number" id="goldAdditionalPrice" placeholder="ถ้ามีบัตรบวกให้กรอกราคา">
      <span class="error-message" id="goldAdditionalPriceError"></span>

      <label for="goldPercentage">เปอร์เซ็นต์ทอง (%):</label>
      <input type="number" id="goldPercentage" placeholder="กรอกเปอร์เซ็นต์">
      <span class="error-message" id="goldPercentageError"></span>

      <label for="goldWeight">น้ำหนักทอง (กรัม):</label>
      <input type="number" id="goldWeight" placeholder="กรอกน้ำหนัก(กรัม)">
      <span class="error-message" id="goldWeightError"></span>

      <div class="button-group">
        <button onclick="calculate('gold')">คำนวณ</button>
        <button type="button" class="reset-btn" onclick="resetCalculator('gold')">รีเซ็ต</button>
      </div>

      <p class="price-reference">
        อ้างอิงราคาทองคำจาก: <a href="https://thaigold.info/" target="_blank">ThaiGold.info</a>
      </p>
    </div>

    <div id="silver" class="tab-content calculator">
      <h2>🥈คิดราคาแร่เงิน🥈</h2>

      <label for="silverPrice">ราคาแร่เงิน ณ ปัจจุบัน (บาท/กรัม):</label>
      <input type="number" id="silverPrice" placeholder="กรอกราคาแร่เงิน เช่น 30">
      <span class="error-message" id="silverPriceError"></span>

      <label for="silverPercentage">เปอร์เซ็นต์เงิน (%):</label>
      <input type="number" id="silverPercentage" placeholder="กรอกเปอร์เซ็นต์ เช่น 99.9 หรือ 92.5">
      <span class="error-message" id="silverPercentageError"></span>

      <label for="silverWeight">น้ำหนักแร่เงิน (กรัม):</label>
      <input type="number" id="silverWeight" placeholder="กรอกน้ำหนัก (ถ้ามี) เช่น 50">
      <span class="error-message" id="silverWeightError"></span>

      <div class="button-group">
        <button onclick="calculate('silver')">คำนวณ</button>
        <button type="button" class="reset-btn" onclick="resetCalculator('silver')">รีเซ็ต</button>
      </div>
    </div>

    <div class="output" style="display: none;">
      <p id="pricePerGram">ราคาต่อกรัม: - บาท</p>
      <p id="result">ราคาทองที่ต้องจ่าย: - บาท</p>
    </div>
  </div>

  <div class="history-section" id="historySection">
    <h3>ประวัติการคำนวณ</h3>
    <ul id="calculationHistoryList" class="history-list">
      </ul>
    <button type="button" class="clear-history-btn" onclick="clearHistory()">ล้างประวัติ</button>
  </div>


  <div class="popup-overlay" id="resultsPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup()">&times;</span>
      <h3 id="popupTitle">ผลการคำนวณ</h3>
      <p id="popupPricePerGram">ราคาต่อกรัม: - บาท</p>
      <p id="popupResult">ราคาที่ต้องจ่าย: - บาท</p>
      <p id="popupKarat" class="popup-karat" style="display: none;"></p> 
    </div>
  </div>

  <script>
    // Array to store history data
    let calculationHistory = [];

    // Function to save history to Local Storage
    function saveHistory() {
        localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
    }

    // Function to load history from Local Storage
    function loadHistory() {
        const storedHistory = localStorage.getItem('calculationHistory');
        if (storedHistory) {
            calculationHistory = JSON.parse(storedHistory);
            renderHistory(); // Render loaded history to the UI
        }
    }

    // Function to render history to the UI
    function renderHistory() {
        const historyList = document.getElementById('calculationHistoryList');
        historyList.innerHTML = ''; // Clear existing list
        calculationHistory.forEach((item, index) => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <div class="history-item-main-text">
                    <span class="history-item-content">${item.text}</span>
                </div>
                <span class="history-item-time">${item.fullDateTime}</span>
                <button class="delete-history-item" onclick="deleteHistoryItem(${index})">&times;</button>
            `;
            if (item.metalType === 'gold') {
                listItem.classList.add('gold-history-item');
            } else if (item.metalType === 'silver') {
                listItem.classList.add('silver-history-item');
            }
            historyList.appendChild(listItem); // Append instead of prepend for correct indexing
        });
    }

    // Function to delete a specific history item
    function deleteHistoryItem(index) {
        if (confirm("คุณต้องการลบรายการนี้ใช่หรือไม่?")) {
            calculationHistory.splice(index, 1); // Remove item from array
            saveHistory(); // Save updated array to Local Storage
            renderHistory(); // Re-render the history list
        }
    }

    // Function to convert percentage to Karat
    function convertToKarat(percentage) {
        // 24 Karat is 100% pure gold
        // So, Karat = (Percentage / 100) * 24
        return (percentage / 100) * 24;
    }


    // ฟังก์ชันช่วยจัดการแสดง/ซ่อน error message และ class ของ input
    function setInputError(inputId, errorMessage) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');

        if (errorMessage) {
            inputElement.classList.add('is-invalid');
            errorElement.textContent = errorMessage;
        } else {
            inputElement.classList.remove('is-invalid');
            errorElement.textContent = '';
        }
    }

    // Function to switch tabs
    function openTab(evt, tabName) {
      let i, tabcontent, tabbuttons;

      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }

      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
      
      // Clear all errors when switching tabs
      clearAllErrors();
    }

    // Generic calculate function for both gold and silver
    function calculate(metalType) {
      // Clear previous errors first
      clearAllErrors();

      let mainPrice, additionalPriceInput, percentageInput, weightInput;
      let effectivePrice, pricePerGramRaw, pricePerGram, totalPrice = 0;
      let percentage, weight;
      let popupTitleText;
      let karatValue = null; // Initialize karatValue to null
      let isValid = true; // Flag for validation status

      // Get elements for popup
      const popupKaratElement = document.getElementById('popupKarat');
      popupKaratElement.style.display = 'none'; // Hide by default

      // Get values based on metal type
      if (metalType === 'gold') {
        mainPrice = parseFloat(document.getElementById('goldPrice').value);
        additionalPriceInput = document.getElementById('goldAdditionalPrice').value;
        percentageInput = document.getElementById('goldPercentage').value;
        weightInput = document.getElementById('goldWeight').value;
        popupTitleText = 'ผลการคำนวณราคาทอง';

        // Gold-specific validation
        if (isNaN(mainPrice) || mainPrice <= 0) {
          setInputError('goldPrice', 'กรุณากรอกราคาทองให้ถูกต้องและเป็นจำนวนบวก');
          isValid = false;
        } else {
          setInputError('goldPrice', '');
        }

        let additionalPrice = 0;
        if (additionalPriceInput !== "") {
            additionalPrice = parseFloat(additionalPriceInput);
            if (isNaN(additionalPrice) || additionalPrice < 0) {
                setInputError('goldAdditionalPrice', 'กรุณากรอกราคาบัตรบวกให้ถูกต้อง (เป็นตัวเลข หรือเว้นว่าง)');
                isValid = false;
            } else {
                setInputError('goldAdditionalPrice', '');
            }
        } else {
            setInputError('goldAdditionalPrice', ''); // Clear error if empty
        }

        percentage = parseFloat(percentageInput);
        if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
          setInputError('goldPercentage', 'กรุณากรอกเปอร์เซ็นต์ทอง (1-100)');
          isValid = false;
        } else {
          setInputError('goldPercentage', '');
          karatValue = convertToKarat(percentage); // Calculate Karat for gold
        }

        weight = parseFloat(weightInput);
        // Weight is optional, but if entered, it must be valid
        if (weightInput !== "" && (isNaN(weight) || weight <= 0)) {
            setInputError('goldWeight', 'กรุณากรอกน้ำหนักทองให้ถูกต้องและเป็นจำนวนบวก (ถ้ามี)');
            isValid = false;
        } else {
            setInputError('goldWeight', '');
        }

        effectivePrice = mainPrice + additionalPrice;

      } else if (metalType === 'silver') {
        mainPrice = parseFloat(document.getElementById('silverPrice').value);
        percentageInput = document.getElementById('silverPercentage').value;
        weightInput = document.getElementById('silverWeight').value;
        popupTitleText = 'ผลการคำนวณราคาแร่เงิน';

        // Silver-specific validation
        if (isNaN(mainPrice) || mainPrice <= 0) {
          setInputError('silverPrice', 'กรุณากรอกราคาแร่เงินให้ถูกต้องและเป็นจำนวนบวก');
          isValid = false;
        } else {
          setInputError('silverPrice', '');
        }

        percentage = parseFloat(percentageInput);
        if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
          setInputError('silverPercentage', 'กรุณากรอกเปอร์เซ็นต์เงิน (1-100)');
          isValid = false;
        } else {
          setInputError('silverPercentage', '');
        }

        weight = parseFloat(weightInput);
        // Weight is optional, but if entered, it must be valid
        if (weightInput !== "" && (isNaN(weight) || weight <= 0)) {
            setInputError('silverWeight', 'กรุณากรอกน้ำหนักแร่เงินให้ถูกต้องและเป็นจำนวนบวก (ถ้ามี)');
            isValid = false;
        } else {
            setInputError('silverWeight', '');
        }
        
        effectivePrice = mainPrice; // No additional price for silver
      }

      // If any validation failed, stop calculation
      if (!isValid) {
        return;
      }

      // Perform calculation
      if (metalType === 'gold') {
        // 1 บาททอง = 15.244 กรัม
        pricePerGramRaw = (effectivePrice / 15.244) * (percentage / 100);
        pricePerGram = Math.floor(pricePerGramRaw); // Gold still floors to whole number
      } else if (metalType === 'silver') {
        // Silver calculation: current price per gram * percentage
        pricePerGramRaw = effectivePrice * (percentage / 100);
        pricePerGram = parseFloat(pricePerGramRaw.toFixed(1)); // Round to 1 decimal place for silver
      }
      
      // Calculate total price if weight is provided
      if (weightInput !== "" && !isNaN(weight) && weight > 0) {
        if (metalType === 'silver') {
            totalPrice = (pricePerGram * weight).toFixed(1); // Keep 1 decimal for total silver price
        } else {
            totalPrice = pricePerGram * weight; // Gold remains whole number
        }
      } else {
          totalPrice = 0; // Ensure total price is 0 if no valid weight for display
      }


      // Display results in popup
      document.getElementById('popupTitle').textContent = popupTitleText;
      document.getElementById('popupPricePerGram').textContent =
        `ราคาต่อกรัม: ${pricePerGram.toLocaleString(undefined, { minimumFractionDigits: metalType === 'silver' ? 1 : 0, maximumFractionDigits: metalType === 'silver' ? 1 : 0 })} บาท`;

      document.getElementById('popupResult').textContent =
        totalPrice > 0 ? `ราคาที่ต้องจ่าย: ${parseFloat(totalPrice).toLocaleString(undefined, { minimumFractionDigits: metalType === 'silver' ? 1 : 0, maximumFractionDigits: metalType === 'silver' ? 1 : 0 })} บาท` : `ราคาที่ต้องจ่าย: - บาท (กรุณากรอกน้ำหนัก)`;

      // Display Karat for Gold
      if (metalType === 'gold' && karatValue !== null) {
          popupKaratElement.textContent = `ประมาณ ${karatValue.toFixed(1)}K`; // Show Karat value
          popupKaratElement.style.display = 'block';
      } else {
          popupKaratElement.style.display = 'none';
      }

      // Show the popup
      document.getElementById('resultsPopup').style.display = 'flex';

      // Auto-save logic: Only save if weight is entered and valid
      if (weightInput !== "" && !isNaN(weight) && weight > 0) {
          let historyEntryText = "";
          // Get full date and time for history in a readable Thai format
          const fullDateTime = new Date().toLocaleString('th-TH', { 
              year: 'numeric', 
              month: 'numeric', 
              day: 'numeric', 
              hour: '2-digit', 
              minute: '2-digit',
              hour12: false // Use 24-hour format
          });

          if (metalType === 'gold') {
              let karatDisplay = "";
              if (karatValue !== null) {
                  karatDisplay = ` (${karatValue.toFixed(1)}K)`;
              }
              historyEntryText = `ทอง ${percentage.toLocaleString()}%${karatDisplay} - ${weight.toLocaleString()}g: ${totalPrice.toLocaleString()} บาท (${pricePerGram.toLocaleString()} บาท/กรัม)`;
              const actualAdditionalPrice = additionalPriceInput === "" ? 0 : parseFloat(additionalPriceInput);
              if (!isNaN(actualAdditionalPrice) && actualAdditionalPrice > 0) {
                  historyEntryText += ` (+${actualAdditionalPrice.toLocaleString()}บ.)`;
              }
          } else if (metalType === 'silver') {
              historyEntryText = `เงิน ${percentage.toLocaleString()}% - ${weight.toLocaleString()}g: ${parseFloat(totalPrice).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })} บาท (${pricePerGram.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })} บาท/กรัม)`;
          }
          
          // Add to calculationHistory array
          calculationHistory.unshift({ // Add to the beginning of the array
              text: historyEntryText,
              fullDateTime: fullDateTime, // Save full date and time
              metalType: metalType
          });
          saveHistory(); // Save to local storage
          renderHistory(); // Re-render the UI
      }
    }

    function closePopup() {
      document.getElementById('resultsPopup').style.display = 'none';
    }

    // Function to clear all calculation history
    function clearHistory() {
        if (confirm("แน่ใจหรอจ๊ะที่จะลบประวัติทั้งหมด?")) {
            calculationHistory = []; // Empty the array
            saveHistory(); // Save empty array to Local Storage
            renderHistory(); // Clear the UI list
        }
    }
    
    // Generic reset function for both gold and silver
    function resetCalculator(metalType) {
        if (metalType === 'gold') {
            document.getElementById('goldPrice').value = '';
            document.getElementById('goldAdditionalPrice').value = '';
            document.getElementById('goldPercentage').value = '';
            document.getElementById('goldWeight').value = '';
        } else if (metalType === 'silver') {
            document.getElementById('silverPrice').value = '';
            document.getElementById('silverPercentage').value = '';
            document.getElementById('silverWeight').value = '';
        }
        clearAllErrors(); // Clear errors after reset
    }

    // Function to clear all validation errors across both tabs
    function clearAllErrors() {
        const errorSpans = document.querySelectorAll('.error-message');
        errorSpans.forEach(span => {
            span.textContent = '';
        });
        const invalidInputs = document.querySelectorAll('input.is-invalid');
        invalidInputs.forEach(input => {
            input.classList.remove('is-invalid');
        });
    }

    // --- Dark Mode / Light Mode Functionality ---
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode'); // Toggle the 'dark-mode' class
        
        // Save user's preference to localStorage
        if (body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            document.getElementById('themeToggleButton').textContent = '🌙'; // Change icon to moon
        } else {
            localStorage.setItem('theme', 'light');
            document.getElementById('themeToggleButton').textContent = '☀️'; // Change icon to sun
        }
    }

    // Apply saved theme on page load
    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('themeToggleButton').textContent = '🌙';
        } else {
            // Default to light mode if no preference or preference is 'light'
            document.body.classList.remove('dark-mode');
            document.getElementById('themeToggleButton').textContent = '☀️';
        }
    }


    // Set initial active tab and load history on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('gold').style.display = 'block';
      clearAllErrors(); // Clear any potential errors on page load
      loadHistory(); // Load history when the page loads
      applySavedTheme(); // Apply saved theme on load
    });
  </script>

</body>
</html>
