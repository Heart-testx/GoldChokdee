<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ร้านโชคดีรับซื้อทอง,เงิน,นาก</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Sarabun', sans-serif; /* เปลี่ยนฟอนต์หลักเป็น Sarabun */
      background-color: #e0e0e0; /* สีเทาอ่อนเหมือนปูนเปลือย */
      color: #333333; /* สีเทาเข้มสำหรับข้อความ */
      padding: 15px;
      margin: 0;
      box-sizing: border-box;
    }

    .container {
      max-width: 420px;
      width: 95%;
      margin: 25px auto 10px auto;
      background-color: #f2f2f2; /* ขาวอมเทาสำหรับ container */
      border: 2px solid #b0b0b0; /* ขอบสีเทากลางๆ */
      border-radius: 0px; /* มุมเหลี่ยมคม */
      box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* เงาไม่เข้มมากนัก */
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #b0b0b0; /* ขอบล่างของ tabs */
    }

    .tab-button {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      cursor: pointer;
      background-color: #e0e0e0; /* พื้นหลัง tab ที่ไม่ active */
      border: none;
      border-radius: 0px;
      font-size: 1.1em;
      font-weight: 600;
      color: #666666; /* สีข้อความ tab ที่ไม่ active */
      transition: background-color 0.2s ease, color 0.2s ease;
      border-right: 1px solid #c0c0c0; /* เส้นแบ่ง tab */
    }

    .tab-button:last-child {
        border-right: none;
    }

    .tab-button.active {
      background-color: #ffffff; /* พื้นหลัง tab ที่ active เป็นสีขาวสว่างขึ้น */
      color: #333333; /* สีข้อความ tab ที่ active */
      border-bottom: 3px solid #6c757d; /* สีเทาเข้มสำหรับขีดเส้นใต้ active tab */
      font-weight: 700;
    }

    .tab-button:hover:not(.active) {
      background-color: #d4d4d4; /* สีอ่อนลงเมื่อ hover */
    }

    .calculator {
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #555555; /* สีเทาเข้มสำหรับหัวข้อ */
      margin-bottom: 20px;
      font-size: 1.6em;
      font-weight: 600;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 400;
      font-size: 0.95em;
      color: #444444; /* สีเทาสำหรับ label */
    }

    input {
      width: calc(100% - 22px);
      padding: 10px;
      border: 1px solid #b0b0b0; /* ขอบ input */
      border-radius: 0px;
      background-color: #ffffff; /* พื้นหลัง input สีขาว */
      color: #333333; /* สีข้อความ input */
      font-size: 1em;
      font-family: 'Sarabun', sans-serif; /* เปลี่ยนฟอนต์ input เป็น Sarabun */
      margin-bottom: 5px; /* ลด margin-bottom เพื่อให้มีที่ว่างสำหรับ error message */
      outline: none;
      box-sizing: border-box;
    }

    input::placeholder {
        color: #888888; /* สี placeholder */
    }

    input:focus {
      border-color: #6c757d; /* สีเทาเข้มเมื่อ focus */
      box-shadow: 0 0 5px rgba(108,117,125,0.5); /* เงาอ่อนๆ เมื่อ focus */
    }

    /* สไตล์สำหรับ input ที่มีปัญหา */
    input.is-invalid {
      border-color: #dc3545; /* ขอบสีแดง */
      box-shadow: 0 0 5px rgba(220,53,69,0.5);
    }

    /* สไตล์สำหรับข้อความ error */
    .error-message {
      color: #dc3545; /* สีแดงสำหรับข้อความ error */
      font-size: 0.85em;
      margin-top: 5px;
      margin-bottom: 15px; /* เพิ่ม margin-bottom ให้ข้อความ error มีพื้นที่ */
      display: block; /* ทำให้ข้อความ error ขึ้นบรรทัดใหม่ */
      min-height: 1.2em; /* กันไม่ให้ layout กระโดดเมื่อข้อความหายไป */
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background-color: #6c757d; /* ปุ่มหลักสีเทาเข้ม */
      color: white; /* ข้อความขาวบนปุ่ม */
      border: 1px solid #5a6268; /* ขอบปุ่ม */
      border-radius: 0px;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-transform: uppercase;
    }

    button.reset-btn {
      background-color: #dc3545; /* ปุ่มรีเซ็ตสีแดง */
      border-color: #c82333;
      color: white;
    }

    button.reset-btn:hover {
      background-color: #c82333;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    button.reset-btn:active {
      background-color: #bd2130;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    button:hover {
      background-color: #5a6268; /* สีเข้มขึ้นเมื่อ hover */
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    button:active {
      background-color: #495057; /* สีเข้มขึ้นเมื่อ active */
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Output Section - Hidden by default now */
    .output {
      display: none;
    }

    .output p {
      margin: 8px 0;
    }

    /* Popup Styling */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6); /* Overlay สีดำโปร่งแสง */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background-color: #f2f2f2; /* พื้นหลัง popup */
      padding: 30px;
      border-radius: 0px;
      border: 2px solid #b0b0b0;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 350px;
      width: 90%;
      position: relative;
      color: #333333;
    }

    .popup-content h3 {
      color: #555555; /* หัวข้อ popup */
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.5em;
      text-transform: uppercase;
    }

    .popup-content p {
      font-size: 1.1em;
      margin: 10px 0;
      color: #444444;
    }

    .popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #888888;
    }

    .popup-content .close-btn:hover {
      color: #555555;
    }

    /* Hide tab content by default */
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* History Section Styling */
    .history-section {
        background-color: #f2f2f2; /* พื้นหลัง history section */
        border: 2px solid #b0b0b0;
        border-radius: 0px;
        padding: 20px;
        max-width: 400px;
        width: 95%;
        margin: 20px auto;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        color: #333333;
    }

    .history-section h3 {
        text-align: center;
        color: #555555;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.4em;
        text-transform: uppercase;
    }

    .history-list {
        list-style-type: none;
        padding: 0;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #b0b0b0;
        border-radius: 0px;
        padding-top: 5px;
        padding-bottom: 5px;
        background-color: #ffffff; /* พื้นหลัง list item */
    }

    .history-list li {
        margin: 5px 0;
        padding: 10px;
        border-radius: 0px;
        border-bottom: 1px solid #e0e0e0; /* เส้นแบ่ง item */
        font-size: 0.9em;
        color: #555555;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative; /* สำหรับตำแหน่งปุ่มลบ */
    }

    .history-list li:last-child {
        border-bottom: none;
    }

    .history-list li strong {
        color: #333333;
    }

    /* New styles for distinct gold/silver history items */
    .gold-history-item {
        background-color: #fcf8e3; /* สีทองอ่อนๆ */
        border-left: 5px solid #d4af37; /* สีทองเข้ม */
    }

    .silver-history-item {
        background-color: #f0f4f7; /* สีเงินอ่อนๆ */
        border-left: 5px solid #a0a0a0; /* สีเงินเข้ม */
    }

    .history-item-time {
      font-size: 0.8em;
      color: #777;
      margin-left: 10px; /* ระยะห่างจากข้อความหลัก */
    }

    /* Style for delete button */
    .delete-history-item {
        background: none;
        border: none;
        color: #dc3545; /* สีแดง */
        font-size: 1.2em;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1; /* เพื่อให้ "x" อยู่ตรงกลาง */
        margin-left: 10px; /* ระยะห่างจากข้อความเวลา */
        transition: color 0.2s ease;
    }
    .delete-history-item:hover {
        color: #c82333;
    }


    .clear-history-btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 15px;
        background-color: #dc3545; /* ปุ่มล้างประวัติสีแดง */
        color: white;
        border: 1px solid #c82333;
        border-radius: 0px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-transform: uppercase;
    }

    .clear-history-btn:hover {
      background-color: #c82333;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .clear-history-btn:active {
      background-color: #bd2130;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    .price-reference {
        font-size: 0.85em;
        text-align: center;
        margin-top: 15px;
        color: #666666;
    }
    .price-reference a {
        color: #6c757d; /* ลิงก์สีเทาเข้ม */
        text-decoration: none;
        font-weight: 600;
    }
    .price-reference a:hover {
        text-decoration: underline;
    }


    /* Media Queries */
    @media screen and (max-width: 600px) {
      body {
        padding: 10px;
      }

      .container {
        margin: 15px auto;
      }

      .calculator {
        padding: 15px;
      }

      h2 {
        font-size: 1.5em;
        margin-bottom: 15px;
      }

      label {
        font-size: 0.9em;
      }

      input {
        padding: 8px;
        font-size: 0.95em;
        margin-bottom: 10px;
      }

      .button-group {
        flex-direction: column;
        gap: 8px;
      }
      button {
        padding: 10px;
        font-size: 1em;
        min-width: unset;
      }

      .popup-content {
        padding: 20px;
      }
      .popup-content h3 {
        font-size: 1.3em;
      }
      .popup-content p {
        font-size: 1em;
      }

      .tab-button {
        font-size: 1em;
        padding: 10px 0;
      }

      .history-section {
        padding: 15px;
      }
      .history-section h3 {
        font-size: 1.3em;
      }
      .history-list li {
        font-size: 0.85em;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="openTab(event, 'gold')">ทอง</button>
      <button class="tab-button" onclick="openTab(event, 'silver')">เงิน</button>
    </div>

    <div id="gold" class="tab-content active calculator">
      <h2>🥇คิดราคาทอง🥇</h2>

      <label for="goldPrice">ราคาทอง ณ ปัจจุบัน (บาท):</label>
      <input type="number" id="goldPrice" placeholder="กรอกราคาทอง">
      <span class="error-message" id="goldPriceError"></span>

      <label for="goldAdditionalPrice">มีบัตร+🪪 (บาท):</label>
      <input type="number" id="goldAdditionalPrice" placeholder="ถ้ามีบัตรบวกให้กรอกราคา">
      <span class="error-message" id="goldAdditionalPriceError"></span>

      <label for="goldPercentage">เปอร์เซ็นต์ทอง (%):</label>
      <input type="number" id="goldPercentage" placeholder="กรอกเปอร์เซ็นต์">
      <span class="error-message" id="goldPercentageError"></span>

      <label for="goldWeight">น้ำหนักทอง (กรัม):</label>
      <input type="number" id="goldWeight" placeholder="กรอกน้ำหนัก(กรัม)">
      <span class="error-message" id="goldWeightError"></span>

      <div class="button-group">
        <button onclick="calculate('gold')">คำนวณ</button>
        <button type="button" class="reset-btn" onclick="resetCalculator('gold')">รีเซ็ต</button>
      </div>

      <p class="price-reference">
        อ้างอิงราคาทองคำจาก: <a href="https://thaigold.info/" target="_blank">ThaiGold.info</a>
      </p>
    </div>

    <div id="silver" class="tab-content calculator">
      <h2>🥈คิดราคาแร่เงิน🥈</h2>

      <label for="silverPrice">ราคาแร่เงิน ณ ปัจจุบัน (บาท/กรัม):</label>
      <input type="number" id="silverPrice" placeholder="กรอกราคาแร่เงิน เช่น 30">
      <span class="error-message" id="silverPriceError"></span>

      <label for="silverPercentage">เปอร์เซ็นต์เงิน (%):</label>
      <input type="number" id="silverPercentage" placeholder="กรอกเปอร์เซ็นต์ เช่น 99.9 หรือ 92.5">
      <span class="error-message" id="silverPercentageError"></span>

      <label for="silverWeight">น้ำหนักแร่เงิน (กรัม):</label>
      <input type="number" id="silverWeight" placeholder="กรอกน้ำหนัก (ถ้ามี) เช่น 50">
      <span class="error-message" id="silverWeightError"></span>

      <div class="button-group">
        <button onclick="calculate('silver')">คำนวณ</button>
        <button type="button" class="reset-btn" onclick="resetCalculator('silver')">รีเซ็ต</button>
      </div>
    </div>

    <div class="output" style="display: none;">
      <p id="pricePerGram">ราคาต่อกรัม: - บาท</p>
      <p id="result">ราคาทองที่ต้องจ่าย: - บาท</p>
    </div>
  </div>

  <div class="history-section" id="historySection">
    <h3>ประวัติการคำนวณ</h3>
    <ul id="calculationHistoryList" class="history-list">
      </ul>
    <button type="button" class="clear-history-btn" onclick="clearHistory()">ล้างประวัติ</button>
  </div>


  <div class="popup-overlay" id="resultsPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup()">&times;</span>
      <h3 id="popupTitle">ผลการคำนวณ</h3>
      <p id="popupPricePerGram">ราคาต่อกรัม: - บาท</p>
      <p id="popupResult">ราคาที่ต้องจ่าย: - บาท</p>
    </div>
  </div>

  <script>
    // Array to store history data
    let calculationHistory = [];

    // Function to save history to Local Storage
    function saveHistory() {
        localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
    }

    // Function to load history from Local Storage
    function loadHistory() {
        const storedHistory = localStorage.getItem('calculationHistory');
        if (storedHistory) {
            calculationHistory = JSON.parse(storedHistory);
            renderHistory(); // Render loaded history to the UI
        }
    }

    // Function to render history to the UI
    function renderHistory() {
        const historyList = document.getElementById('calculationHistoryList');
        historyList.innerHTML = ''; // Clear existing list
        calculationHistory.forEach((item, index) => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <span>${item.text}</span>
                <span class="history-item-time">${item.time}</span>
                <button class="delete-history-item" onclick="deleteHistoryItem(${index})">&times;</button>
            `;
            if (item.metalType === 'gold') {
                listItem.classList.add('gold-history-item');
            } else if (item.metalType === 'silver') {
                listItem.classList.add('silver-history-item');
            }
            historyList.appendChild(listItem); // Append instead of prepend for correct indexing
        });
    }

    // Function to delete a specific history item
    function deleteHistoryItem(index) {
        if (confirm("คุณต้องการลบรายการนี้ใช่หรือไม่?")) {
            calculationHistory.splice(index, 1); // Remove item from array
            saveHistory(); // Save updated array to Local Storage
            renderHistory(); // Re-render the history list
        }
    }


    // ฟังก์ชันช่วยจัดการแสดง/ซ่อน error message และ class ของ input
    function setInputError(inputId, errorMessage) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');

        if (errorMessage) {
            inputElement.classList.add('is-invalid');
            errorElement.textContent = errorMessage;
        } else {
            inputElement.classList.remove('is-invalid');
            errorElement.textContent = '';
        }
    }

    // Function to switch tabs
    function openTab(evt, tabName) {
      let i, tabcontent, tabbuttons;

      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }

      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
      
      // Clear all errors when switching tabs
      clearAllErrors();
    }

    // Generic calculate function for both gold and silver
    function calculate(metalType) {
      // Clear previous errors first
      clearAllErrors();

      let mainPrice, additionalPriceInput, percentageInput, weightInput;
      let effectivePrice, pricePerGramRaw, pricePerGram, totalPrice = 0;
      let percentage, weight;
      let popupTitleText;
      let isValid = true; // Flag for validation status

      // Get values based on metal type
      if (metalType === 'gold') {
        mainPrice = parseFloat(document.getElementById('goldPrice').value);
        additionalPriceInput = document.getElementById('goldAdditionalPrice').value;
        percentageInput = document.getElementById('goldPercentage').value;
        weightInput = document.getElementById('goldWeight').value;
        popupTitleText = 'ผลการคำนวณราคาทอง';

        // Gold-specific validation
        if (isNaN(mainPrice) || mainPrice <= 0) {
          setInputError('goldPrice', 'กรุณากรอกราคาทองให้ถูกต้องและเป็นจำนวนบวก');
          isValid = false;
        } else {
          setInputError('goldPrice', '');
        }

        let additionalPrice = 0;
        if (additionalPriceInput !== "") {
            additionalPrice = parseFloat(additionalPriceInput);
            if (isNaN(additionalPrice) || additionalPrice < 0) {
                setInputError('goldAdditionalPrice', 'กรุณากรอกราคาบัตรบวกให้ถูกต้อง (เป็นตัวเลข หรือเว้นว่าง)');
                isValid = false;
            } else {
                setInputError('goldAdditionalPrice', '');
            }
        } else {
            setInputError('goldAdditionalPrice', ''); // Clear error if empty
        }

        percentage = parseFloat(percentageInput);
        if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
          setInputError('goldPercentage', 'กรุณากรอกเปอร์เซ็นต์ทอง (1-100)');
          isValid = false;
        } else {
          setInputError('goldPercentage', '');
        }

        weight = parseFloat(weightInput);
        // Weight is optional, but if entered, it must be valid
        if (weightInput !== "" && (isNaN(weight) || weight <= 0)) {
            setInputError('goldWeight', 'กรุณากรอกน้ำหนักทองให้ถูกต้องและเป็นจำนวนบวก (ถ้ามี)');
            isValid = false;
        } else {
            setInputError('goldWeight', '');
        }

        effectivePrice = mainPrice + additionalPrice;

      } else if (metalType === 'silver') {
        mainPrice = parseFloat(document.getElementById('silverPrice').value);
        percentageInput = document.getElementById('silverPercentage').value;
        weightInput = document.getElementById('silverWeight').value;
        popupTitleText = 'ผลการคำนวณราคาแร่เงิน';

        // Silver-specific validation
        if (isNaN(mainPrice) || mainPrice <= 0) {
          setInputError('silverPrice', 'กรุณากรอกราคาแร่เงินให้ถูกต้องและเป็นจำนวนบวก');
          isValid = false;
        } else {
          setInputError('silverPrice', '');
        }

        percentage = parseFloat(percentageInput);
        if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
          setInputError('silverPercentage', 'กรุณากรอกเปอร์เซ็นต์เงิน (1-100)');
          isValid = false;
        } else {
          setInputError('silverPercentage', '');
        }

        weight = parseFloat(weightInput);
        // Weight is optional, but if entered, it must be valid
        if (weightInput !== "" && (isNaN(weight) || weight <= 0)) {
            setInputError('silverWeight', 'กรุณากรอกน้ำหนักแร่เงินให้ถูกต้องและเป็นจำนวนบวก (ถ้ามี)');
            isValid = false;
        } else {
            setInputError('silverWeight', '');
        }
        
        effectivePrice = mainPrice; // No additional price for silver
      }

      // If any validation failed, stop calculation
      if (!isValid) {
        return;
      }

      // Perform calculation
      if (metalType === 'gold') {
        // 1 บาททอง = 15.244 กรัม
        pricePerGramRaw = (effectivePrice / 15.244) * (percentage / 100);
        pricePerGram = Math.floor(pricePerGramRaw); // Gold still floors to whole number
      } else if (metalType === 'silver') {
        // Silver calculation: current price per gram * percentage
        pricePerGramRaw = effectivePrice * (percentage / 100);
        pricePerGram = parseFloat(pricePerGramRaw.toFixed(1)); // Round to 1 decimal place for silver
      }
      
      // Calculate total price if weight is provided
      if (weightInput !== "" && !isNaN(weight) && weight > 0) {
        if (metalType === 'silver') {
            totalPrice = (pricePerGram * weight).toFixed(1); // Keep 1 decimal for total silver price
        } else {
            totalPrice = pricePerGram * weight; // Gold remains whole number
        }
      } else {
          totalPrice = 0; // Ensure total price is 0 if no valid weight for display
      }


      // Display results in popup
      document.getElementById('popupTitle').textContent = popupTitleText;
      document.getElementById('popupPricePerGram').textContent =
        `ราคาต่อกรัม: ${pricePerGram.toLocaleString(undefined, { minimumFractionDigits: metalType === 'silver' ? 1 : 0, maximumFractionDigits: metalType === 'silver' ? 1 : 0 })} บาท`;

      document.getElementById('popupResult').textContent =
        totalPrice > 0 ? `ราคาที่ต้องจ่าย: ${parseFloat(totalPrice).toLocaleString(undefined, { minimumFractionDigits: metalType === 'silver' ? 1 : 0, maximumFractionDigits: metalType === 'silver' ? 1 : 0 })} บาท` : `ราคาที่ต้องจ่าย: - บาท (กรุณากรอกน้ำหนัก)`;

      // Show the popup
      document.getElementById('resultsPopup').style.display = 'flex';

      // Auto-save logic: Only save if weight is entered and valid
      if (weightInput !== "" && !isNaN(weight) && weight > 0) {
          let historyEntryText = "";
          const currentTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

          if (metalType === 'gold') {
              historyEntryText = `ทอง ${percentage.toLocaleString()}% - ${weight.toLocaleString()}g: ${totalPrice.toLocaleString()} บาท (${pricePerGram.toLocaleString()} บาท/กรัม)`;
              const actualAdditionalPrice = additionalPriceInput === "" ? 0 : parseFloat(additionalPriceInput);
              if (!isNaN(actualAdditionalPrice) && actualAdditionalPrice > 0) {
                  historyEntryText += ` (+${actualAdditionalPrice.toLocaleString()}บ.)`;
              }
          } else if (metalType === 'silver') {
              historyEntryText = `เงิน ${percentage.toLocaleString()}% - ${weight.toLocaleString()}g: ${parseFloat(totalPrice).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })} บาท (${pricePerGram.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })} บาท/กรัม)`;
          }
          
          // Add to calculationHistory array
          calculationHistory.unshift({ // Add to the beginning of the array
              text: historyEntryText,
              time: currentTime,
              metalType: metalType
          });
          saveHistory(); // Save to local storage
          renderHistory(); // Re-render the UI
      }
    }

    function closePopup() {
      document.getElementById('resultsPopup').style.display = 'none';
    }

    // Function to clear all calculation history
    function clearHistory() {
        if (confirm("แน่ใจหรอจ๊ะที่จะลบประวัติทั้งหมด?")) {
            calculationHistory = []; // Empty the array
            saveHistory(); // Save empty array to Local Storage
            renderHistory(); // Clear the UI list
        }
    }
    
    // Generic reset function for both gold and silver
    function resetCalculator(metalType) {
        if (metalType === 'gold') {
            document.getElementById('goldPrice').value = '';
            document.getElementById('goldAdditionalPrice').value = '';
            document.getElementById('goldPercentage').value = '';
            document.getElementById('goldWeight').value = '';
        } else if (metalType === 'silver') {
            document.getElementById('silverPrice').value = '';
            document.getElementById('silverPercentage').value = '';
            document.getElementById('silverWeight').value = '';
        }
        clearAllErrors(); // Clear errors after reset
    }

    // Function to clear all validation errors across both tabs
    function clearAllErrors() {
        const errorSpans = document.querySelectorAll('.error-message');
        errorSpans.forEach(span => {
            span.textContent = '';
        });
        const invalidInputs = document.querySelectorAll('input.is-invalid');
        invalidInputs.forEach(input => {
            input.classList.remove('is-invalid');
        });
    }

    // Set initial active tab and load history on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('gold').style.display = 'block';
      clearAllErrors(); // Clear any potential errors on page load
      loadHistory(); // Load history when the page loads
    });
  </script>

</body>
</html>
